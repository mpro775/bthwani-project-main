# خطة إكمال عربون إلى نظام الحجوزات (V5)

هذه الخطة لرفع **نظام عربون** الحالي إلى **نظام حجوزات كامل** متوافق مع مواصفات V5 – Offers & Bookings في وثيقة التسليم (الحجوزات بعيادات، صالونات، دورات، فعاليات مع slots وتكامل محفظة).

---

## الوضع الحالي vs الهدف

| الجانب | عربون الحالي | الهدف (V5) |
|--------|---------------|------------|
| العروض | كيان واحد `Arabon` (عرض بعربون) | `providers` + `offers` أو توسيع Arabon ليدعم فئات (عيادة/صالون/فعالية) |
| الأوقات | `scheduleAt` واحد + `bookingPeriod` | جدول **slots** (أوقات متعددة قابلة للحجز، يومي/ساعي) |
| الحجز | طلب `ArabonRequest` (قبول/رفض فقط) | **حجز مؤكد** مرتبط بـ slot + دفع من المحفظة |
| الدفع | لا تكامل محفظة | **Escrow**: حجز رسوم الحجز، خصم من الإجمالي لاحقاً، استرداد عند الإلغاء (وحجب عند no-show) |
| الحالات | draft → pending → confirmed → completed/cancelled | إضافة حالات للحجز: confirmed, completed, cancelled, no_show |

---

## المرحلة 1: Slots (الأوقات المتاحة)

| # | المهمة | الملف / الموقع | التفاصيل |
|---|--------|-----------------|-----------|
| 1.1 | إنشاء entity للـ slots | `backend-nest/src/modules/arabon/entities/booking-slot.entity.ts` | حقول: `arabonId` (أو `offerId`)، `datetime` (Date)، `isBooked` (boolean)، `durationMinutes` (اختياري). فهارس: `{ arabonId: 1, datetime: 1 }`. |
| 1.2 | إنشاء خدمة Slot | `backend-nest/src/modules/arabon/booking-slot.service.ts` أو داخل `arabon.service.ts` | دوال: `createSlots(arabonId, start, end, intervalMinutes)`، `getAvailableSlots(arabonId, dateFrom?, dateTo?)`، `reserveSlot(slotId, userId)`، `releaseSlot(slotId)`. |
| 1.3 | API: عرض الأوقات المتاحة | `arabon.controller.ts` | `GET /arabon/:id/slots?from=...&to=...` — يرجع قائمة slots غير محجوزة للعربون في المدى الزمني. |
| 1.4 | API: إنشاء/تحديث slots (للمالك) | `arabon.controller.ts` | `POST /arabon/:id/slots` — body: `{ slots: [{ datetime, durationMinutes? }] }` أو نطاق زمني + فاصل. التحقق أن المستخدم = `ownerId`. |
| 1.5 | (اختياري) تقويم في الواجهة | تطبيق المستخدم + لوحة الشريك | واجهة لاختيار تاريخ ووقت عند الحجز؛ واجهة للشريك لعرض/إدارة slots (إضافة، حذف، إلغاء حجز). |

---

## المرحلة 2: ربط الحجز بالمحفظة (Escrow)

| # | المهمة | الملف / الموقع | التفاصيل |
|---|--------|-----------------|-----------|
| 2.1 | ربط وحدة المحفظة بعربون | `backend-nest/src/modules/arabon/arabon.module.ts` | استيراد `WalletModule`، حقن `WalletService` (أو خدمة hold/release) في `ArabonService` أو خدمة حجوزات جديدة. |
| 2.2 | حجز مبلغ عند تأكيد الحجز | خدمة الحجوزات / ArabonService | عند "تأكيد حجز" (قبول طلب + اختيار slot): استدعاء `holdFunds(userId, depositAmount, refId: bookingId)`. تخزين `walletTxId` أو `holdId` في سجل الحجز. |
| 2.3 | إطلاق المبلغ للمالك أو استرداده | نفس الخدمة | عند `completed`: تحويل المبلغ المحجوز للمالك (أو خصم من إجمالي الخدمة حسب المنتج). عند `cancelled`: استدعاء إطلاق للمستخدم (refund). عند `no_show`: عدم استرداد (أو حسب السياسة). |
| 2.4 | سجل معاملات مرتبط بالحجز | `Wallet` + كيان الحجز | التأكد أن معاملات المحفظة تحوي `refId` = `bookingId` ونوع مثل `booking_deposit` / `booking_refund` / `booking_complete` لتسهيل التتبع والتدقيق. |

---

## المرحلة 3: كيان الحجز (Booking) وواجهات API

| # | المهمة | الملف / الموقع | التفاصيل |
|---|--------|----------------|-----------|
| 3.1 | إنشاء entity للحجز | `backend-nest/src/modules/arabon/entities/booking.entity.ts` | حقول: `userId`, `arabonId`, `slotId`, `status` (pending_payment, confirmed, completed, cancelled, no_show), `walletTxId` (أو ref للمحفظة), `depositAmount`, `metadata`, `timestamps`. |
| 3.2 | تحويل "طلب عربون" إلى حجز مؤكد | منطق الخدمة | عند قبول الطلب: إنشاء سجل `Booking` مرتبط بـ slot محدد، ثم استدعاء حجز المحفظة. ربط `ArabonRequest` بـ `Booking` (حقل `bookingId` في Request اختياري) أو استبدال التدفق بحجز مباشر. |
| 3.3 | API: تأكيد حجز (دفع + ربط slot) | `arabon.controller.ts` أو `bookings.controller.ts` | `POST /arabon/:id/book` أو `POST /bookings/confirm`: body `{ slotId, depositAmount?, couponId? }`. التحقق من توفر الـ slot، خصم/حجز من المحفظة، إنشاء `Booking`، تحديث `slot.isBooked = true`. |
| 3.4 | API: حالة الحجز | Controller | `GET /bookings/:id` أو `GET /arabon/bookings/:bookingId` — تفاصيل الحجز (عربون، slot، حالة، مبلغ، تاريخ). |
| 3.5 | API: قائمة حجوزات المستخدم | Controller | `GET /bookings/my` أو `GET /arabon/my-bookings` — حجوزات المستخدم الحالي مع فلترة (status، من-إلى تاريخ). |
| 3.6 | API: قائمة حجوزات العارض (المالك) | Controller | `GET /arabon/:id/bookings` — للمالك فقط، لعرض كل الحجوزات على هذا العربون (لتقويم الشريك وإدارة no-show). |

---

## المرحلة 4: No-Show والاسترداد

| # | المهمة | الملف / الموقع | التفاصيل |
|---|--------|----------------|-----------|
| 4.1 | حالة no_show في الحجز | `booking.entity.ts` + Service | إضافة `no_show` كحالة؛ تحديث الحجز إلى `no_show` من لوحة المالك أو بعد انتهاء الموعد بدون تأكيد حضور. |
| 4.2 | منطق الاسترداد حسب الحالة | خدمة الحجوزات + Wallet | عند `cancelled` (قبل الموعد): استرداد كامل. عند `no_show`: عدم استرداد (أو نسبة حسب السياسة). عند `completed`: تحويل للمالك. توثيق السياسة في تعليقات أو config. |
| 4.3 | API لتحديث حالة الحجز (مكتمل / no-show) | Controller | `PATCH /bookings/:id/status` — body `{ status: 'completed' | 'no_show' | 'cancelled' }`. صلاحيات: مالك العربون أو أدمن. |

---

## المرحلة 5: توافق الواجهات والتطبيقات

| # | المهمة | الملف / الموقع | التفاصيل |
|---|--------|----------------|-----------|
| 5.1 | تطبيق المستخدم: اختيار وقت من slots | `app-user` (شاشات عربون/حجز) | استدعاء `GET /arabon/:id/slots`، عرض منتقي تاريخ/وقت، ثم استدعاء `POST /bookings/confirm` مع `slotId` ودفع من المحفظة. |
| 5.2 | تطبيق المستخدم: سجل حجوزاتي | `app-user` | شاشة "حجوزاتي" تعرض `GET /arabon/my-bookings` مع إمكانية إلغاء (إن كانت السياسة تسمح) وعرض الحالة. |
| 5.3 | لوحة الشريك: تقويم الحجوزات | `admin-dashboard` أو بوابة الشريك | عرض حجوزات اليوم/الأسبوع لكل عربون، إعادة جدولة (تغيير slot)، تحديد completed / no_show. |
| 5.4 | لوحة الإدارة: إدارة الحجز (Escrow) | `admin-dashboard` (رابط "إدارة الحجز" الموجود) | إن لم تكن مبنية بعد: عرض معاملات مرتبطة بالحجوزات (deposit، refund، payout) وربطها بـ bookingId. |

---

## المرحلة 6: تحسينات اختيارية (للمستقبل)

| # | المهمة | التفاصيل |
|---|--------|-----------|
| 6.1 | كوبونات أول حجز | خصم على رسوم الحجز أو الإجمالي عند أول حجز للمستخدم (ربط مع وحدة كوبونات إن وجدت). |
| 6.2 | فئات العروض (عيادة/صالون/فعالية) | إضافة حقل `offerType` أو `category` في Arabon والفلترة في الواجهة حسب وثيقة V5. |
| 6.3 | فيديو للمكان (Venue Videos) | ربط وسائط إضافية (فيديو) بعربون/عرض كما في `short-video-service` بالوثيقة. |
| 6.4 | مؤشرات أداء (KPIs) | لوحة: معدل تحويل الحجز، عدد الحجوزات المدفوعة، دقة التقويم، معدل no-show — كما في وثيقة V5. |

---

## ترتيب التنفيذ المقترح

1. **المرحلة 1** (Slots) — أساس لعرض أوقات واضحة وتجربة حجز سليمة.
2. **المرحلة 3** (كيان الحجز + APIs) — مع تدفق "حجز بدون دفع" أولاً إن لزم، ثم ربط الدفع.
3. **المرحلة 2** (المحفظة) — تفعيل الدفع الفعلي والـ escrow بعد استقرار نموذج الحجز.
4. **المرحلة 4** (No-Show والاسترداد) — لإغلاق دورة حياة الحجز.
5. **المرحلة 5** (الواجهات) — بالتوازي أو بعد استقرار الـ APIs.
6. **المرحلة 6** — حسب الأولوية المنتجية.

---

## ملاحظات تقنية

- **قاعدة البيانات:** عربون الحالي MongoDB (Mongoose). الـ slots و الـ bookings يمكن أن تكون مجموعات (collections) جديدة في نفس الـ DB.
- **الصلاحيات:** التحقق من `ownerId` عند إدارة slots وحجوزات العربون؛ التحقق من `userId` عند إلغاء الحجز أو عرض "حجوزاتي".
- **الإشعارات:** (خارج نطاق هذه الخطة) إشعار المستخدم بتأكيد الحجز، تذكير قبل الموعد، وإشعار المالك بطلب حجز جديد أو إلغاء.

---

*آخر تحديث: وفق تحليل نظام عربون الحالي ووثيقة V5 – Offers & Bookings.*
