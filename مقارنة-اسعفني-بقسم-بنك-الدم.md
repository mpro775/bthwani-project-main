# مقارنة اسعفني بقسم بنك الدم (V7 – Find Blood)

هذا المستند يقارن ما ورد في **خطة إكمال خدمة اسعفني** (وفق مواصفات V7 – Find Blood / قسم بنك الدم في وثائق التسليم) بما تم تنفيذه فعلياً في **خدمة اسعفني** عبر الباك إند، تطبيق المستخدم، الموقع، ولوحة التحكم.

---

## 1. نظرة عامة

| العنصر      | المتطلب (V7 – Find Blood / بنك الدم)        | خدمة اسعفني المُنفذة                                    |
| ----------- | ------------------------------------------- | ------------------------------------------------------- |
| **الاسم**   | شبكة تبرع بالدم عاجلة / Find Blood          | اسعفني (Es3afni)                                        |
| **الهدف**   | طلبات تبرع بالدم مع أولوية وانتهاء وتنبيهات | ✅ مطابق (بدون تكامل مستشفيات)                          |
| **المنصات** | خادم، تطبيق، ويب، لوحة تحكم                 | ✅ backend-nest, app-user, bthwani-web, admin-dashboard |

---

## 2. مواصفات قاعدة البيانات ومقارنتها

### 2.1 كيان طلب الدم (Es3afni)

| الحقل في الخطة | الحقل في اسعفني المُنفذ                                                 | الحالة   |
| -------------- | ----------------------------------------------------------------------- | -------- |
| `ownerId`      | `ownerId` (ObjectId ref User)                                           | ✅ مطابق |
| `title`        | `title`                                                                 | ✅ مطابق |
| `description`  | `description`                                                           | ✅ مطابق |
| `bloodType`    | `bloodType` (مع التحقق A+…O-)                                           | ✅ مطابق |
| `location`     | `location` (lat, lng, address)                                          | ✅ مطابق |
| `metadata`     | `metadata` (contact, unitsNeeded, إلخ)                                  | ✅ مطابق |
| `status`       | `status` (draft, pending, confirmed, completed, cancelled, **expired**) | ✅ مطابق |
| `urgency`      | `urgency` (low, normal, urgent, critical)                               | ✅ مُنفذ |
| `expiresAt`    | `expiresAt` (48 ساعة من النشر)                                          | ✅ مُنفذ |
| `publishedAt`  | `publishedAt`                                                           | ✅ مُنفذ |
| GeoJSON للبحث  | `locationGeo` (Point, 2dsphere)                                         | ✅ مُنفذ |

### 2.2 كيان المتبرع (Es3afniDonor)

| الحقل في الخطة         | الحقل في اسعفني المُنفذ      | الحالة   |
| ---------------------- | ---------------------------- | -------- |
| `userId`               | `userId` (ObjectId ref User) | ✅ مطابق |
| `bloodType`            | `bloodType`                  | ✅ مطابق |
| `lastDonation`         | `lastDonation` (Date)        | ✅ مطابق |
| `available`            | `available` (boolean)        | ✅ مطابق |
| `location`             | `location` + `locationGeo`   | ✅ مطابق |
| `city` / `governorate` | `city`, `governorate`        | ✅ مطابق |

### 2.3 كيان تنبيهات المتبرعين (Es3afniDonorAlert)

| الحقل في الخطة | الحقل في اسعفني المُنفذ   | الحالة     |
| -------------- | ------------------------- | ---------- |
| `requestId`    | `requestId` (ref Es3afni) | ✅ مطابق   |
| `donorId`      | `donorId` (userId)        | ✅ مطابق   |
| `delivered`    | `delivered` (boolean)     | ✅ مطابق   |
| `sentAt`       | `sentAt` (Date)           | ✅ مطابق   |
| `readAt`       | —                         | ⚠️ اختياري |

---

## 3. الميزات الأساسية (Core Features)

| الميزة في الخطة        | الوصف                              | الحالة في اسعفني                          |
| ---------------------- | ---------------------------------- | ----------------------------------------- |
| **طلب تبرع (CRUD)**    | إنشاء/تعديل/حذف طلب مع فصيلة وموقع | ✅ مُنفذ                                  |
| **فصيلة الدم**         | A+ … O- مع التحقق                  | ✅ مُنفذ (DTO + front)                    |
| **الموقع الجغرافي**    | lat, lng, address + GeoJSON        | ✅ مُنفذ (location + locationGeo)         |
| **الأولوية (urgency)** | low, normal, urgent, critical      | ✅ مُنفذ (entity, DTOs, كل الواجهات)      |
| **انتهاء 48 ساعة**     | expiresAt عند النشر، cron للانتهاء | ✅ مُنفذ (publishedAt + expiresAt + Cron) |
| **حالة منتهي**         | status = expired                   | ✅ مُنفذ                                  |

---

## 4. الميزات المتقدمة (Advanced Features)

| الميزة في الخطة       | الوصف                                       | الحالة في اسعفني                                     |
| --------------------- | ------------------------------------------- | ---------------------------------------------------- |
| **سجل المتبرعين**     | تسجيل/تحديث/ملف متبرع، GET donors/me        | ✅ مُنفذ (Donor entity + service + كل المنصات)       |
| **متبرعون قريبون**    | GET donors/nearby (lat, lng, radius, فصيلة) | ✅ مُنفذ (findDonorsNearby، 2dsphere)                |
| **بلاغاتي**           | GET /es3afni/my مع cursor                   | ✅ مُنفذ                                             |
| **بحث**               | GET /es3afni/search (q, bloodType, status)  | ✅ مُنفذ                                             |
| **فلترة القائمة**     | bloodType, status, urgency                  | ✅ مُنفذ (GET /es3afni وواجهات القوائم)              |
| **محادثة الطلب**      | محادثة صاحب الطلب + متبرع، إغلاق 48 ساعة    | ✅ مُنفذ (وحدة es3afni-chat، donor مُخفى كـ "متبرع") |
| **تنبيهات للمتبرعين** | إنشاء DonorAlert عند نشر طلب مطابق          | ⚠️ جزئي (تُسجّل السجلات فقط، لا إرسال push/SMS)      |

---

## 5. الميزات الذكية / الاختيارية

| الميزة في الخطة      | الوصف                                       | الحالة في اسعفني              |
| -------------------- | ------------------------------------------- | ----------------------------- |
| **تحقق رقم الهاتف**  | التحقق من هاتف المستخدم قبل نشر الطلب       | ❌ غير مُنفذ                  |
| **إرسال push/SMS**   | إشعار فعلي للمتبرعين عند طلب عاجل مطابق     | ❌ غير مُنفذ (DonorAlert فقط) |
| **عرض تنبيهات بلاغ** | في تفاصيل البلاغ بالأدمن: قائمة DonorAlerts | ❌ غير مُنفذ                  |

---

## 6. واجهات API – مقارنة Endpoints

| Endpoint في الخطة                 | Endpoint المُنفذ                                     | الحالة   |
| --------------------------------- | ---------------------------------------------------- | -------- |
| `POST /es3afni`                   | `POST /es3afni`                                      | ✅ مُنفذ |
| `GET /es3afni`                    | `GET /es3afni?cursor,bloodType,status,urgency`       | ✅ مُنفذ |
| `GET /es3afni/my`                 | `GET /es3afni/my`                                    | ✅ مُنفذ |
| `GET /es3afni/search`             | `GET /es3afni/search?q,bloodType,status,cursor`      | ✅ مُنفذ |
| `GET /es3afni/:id`                | `GET /es3afni/:id`                                   | ✅ مُنفذ |
| `PATCH /es3afni/:id`              | `PATCH /es3afni/:id`                                 | ✅ مُنفذ |
| `DELETE /es3afni/:id`             | `DELETE /es3afni/:id`                                | ✅ مُنفذ |
| `GET /es3afni/donors/nearby`      | `GET /es3afni/donors/nearby`                         | ✅ مُنفذ |
| `GET /es3afni/donors/me`          | `GET /es3afni/donors/me`                             | ✅ مُنفذ |
| `POST /es3afni/donors/me`         | `POST /es3afni/donors/me`                            | ✅ مُنفذ |
| `PATCH /es3afni/donors/me`        | `PATCH /es3afni/donors/me`                           | ✅ مُنفذ |
| —                                 | es3afni-chat: create, list, messages, send, markRead | ✅ مُنفذ |
| `GET /admin/es3afni`              | `GET /admin/es3afni?cursor,bloodType,status,urgency` | ✅ مُنفذ |
| `GET /admin/es3afni/donors`       | `GET /admin/es3afni/donors`                          | ✅ مُنفذ |
| `GET /admin/es3afni/:id`          | `GET /admin/es3afni/:id`                             | ✅ مُنفذ |
| `PATCH /admin/es3afni/:id/status` | `PATCH /admin/es3afni/:id/status`                    | ✅ مُنفذ |
| `DELETE /admin/es3afni/:id`       | `DELETE /admin/es3afni/:id`                          | ✅ مُنفذ |

---

## 7. الخدمات (Backend) – مقارنة

| الخدمة في الخطة          | الوصف                                                      | الحالة في اسعفني               |
| ------------------------ | ---------------------------------------------------------- | ------------------------------ |
| **Es3afniService**       | CRUD، findAll مع فلاتر، findMy، search، انتهاء 48 ساعة     | ✅ مُنفذ                       |
| **Es3afniDonorService**  | register، update، getMy، findDonorsNearby، findAllForAdmin | ✅ مُنفذ                       |
| **DonorAlert عند النشر** | إنشاء سجلات DonorAlert للمتبرعين المطابقين                 | ✅ مُنفذ (بدون إرسال push/SMS) |
| **Cron انتهاء الطلبات**  | تحديث status إلى expired عند expiresAt                     | ✅ مُنفذ                       |
| **es3afni-chat**         | محادثة مرتبطة بطلب، إغلاق بعد 48 ساعة                      | ✅ مُنفذ                       |

---

## 8. التطبيق (app-user)

| الميزة في الخطة                | الحالة في اسعفني                                         |
| ------------------------------ | -------------------------------------------------------- |
| إنشاء/تعديل طلب تبرع           | ✅ Es3afniCreateScreen, Es3afniEditScreen                |
| حقل الأولوية (urgency)         | ✅ مُنفذ (low, normal, urgent, critical)                 |
| قائمة طلبات + فلترة            | ✅ Es3afniListScreen (bloodType, urgency)                |
| تاب "بلاغاتي"                  | ✅ مُنفذ (getMyEs3afni)                                  |
| عرض "ينتهي بعد" وشارة عاجل     | ✅ Es3afniCard, Es3afniDetailsScreen                     |
| تسجيل متبرع / ملف المتبرع      | ✅ Es3afniDonorRegisterScreen, Es3afniDonorProfileScreen |
| زر "سجّل متبرع" من القائمة     | ✅ مُنفذ                                                 |
| زر "أستطيع التبرع" في التفاصيل | ✅ يُنشئ محادثة وينتقل إلى Es3afniChat                   |
| قائمة محادثات اسعفني           | ✅ Es3afniChatListScreen                                 |
| شاشة محادثة                    | ✅ Es3afniChatScreen                                     |
| التنقل (donor + chat)          | ✅ مسارات مسجّلة في navigation                           |
| إشعارات push للطلبات العاجلة   | ❌ غير مُنفذ                                             |

---

## 9. الموقع (bthwani-web)

| الميزة في الخطة            | الحالة في اسعفني                            |
| -------------------------- | ------------------------------------------- |
| قائمة طلبات + فلترة        | ✅ Es3afniList (bloodType, status, urgency) |
| تاب "بلاغاتي"              | ✅ مُنفذ                                    |
| عرض "ينتهي بعد" وشارة عاجل | ✅ Es3afniCard, Es3afniDetails              |
| إنشاء/تعديل طلب + urgency  | ✅ Es3afniForm (URGENCY_LEVELS)             |
| صفحة "سجّل كمتبرع"         | ✅ Es3afniDonor (GET/POST/PATCH donors/me)  |
| زر "سجّل متبرع" من القائمة | ✅ مُنفذ                                    |
| مسار /es3afni/donor        | ✅ مُنفذ                                    |

---

## 10. لوحة التحكم (admin-dashboard)

| الميزة في الخطة                              | الحالة في اسعفني                              |
| -------------------------------------------- | --------------------------------------------- |
| قائمة بلاغات                                 | ✅ Es3afniListPage                            |
| فلترة (حالة، فصيلة، أولوية)                  | ✅ مُنفذ (من السيرفر)                         |
| عمود الأولوية وعمود انتهاء الصلاحية          | ✅ مُنفذ                                      |
| إحصائيات (نشطة، مكتملة، منتهية)              | ✅ مُنفذ (بطاقات في الصفحة)                   |
| تفاصيل بلاغ (urgency, expiresAt)             | ✅ Es3afniDetailsPage                         |
| قائمة المتبرعين (قراءة فقط)                  | ✅ Es3afniDonorsPage (جدول، فلترة فصيلة/توفر) |
| GET admin/es3afni/donors                     | ✅ مُنفذ                                      |
| زر "قائمة المتبرعين" + رابط القائمة الجانبية | ✅ مُنفذ                                      |
| عرض تنبيهات بلاغ (DonorAlerts)               | ❌ غير مُنفذ                                  |
| فلتر "قريب من الانتهاء"                      | ⚠️ غير مُنفذ (يعتمد على status فقط)           |

---

## 11. الخصوصية والقيود

| المتطلب في الخطة               | الحالة في اسعفني                      |
| ------------------------------ | ------------------------------------- |
| عدم تكامل مستشفيات / لا CSV    | ✅ ملتزم (لا لوحة مستشفى ولا رفع CSV) |
| بيانات المتبرعين (موقع دقيق)   | ✅ لا يُعرض للأدمن (مدينة/محافظة فقط) |
| إخفاء هوية المتبرع في المحادثة | ✅ مُنفذ ("متبرع")                    |

---

## 12. ملخص التنفيذ

### ✅ ما تم تنفيذه بنجاح

| الفئة               | الميزات                                                                                                                                                                       |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Backend**         | Entity (urgency, expiresAt, publishedAt, locationGeo, expired)، Donor + DonorAlert، فلترة وبلاغاتي وبحث، Cron 48 ساعة، donors/nearby، es3afni-chat، Admin list + donors + :id |
| **app-user**        | إنشاء/تعديل/قائمة/تفاصيل مع urgency و expiresAt، فلترة وبلاغاتي، تسجيل/ملف متبرع، "أستطيع التبرع" → محادثة، قائمة محادثات وشاشة محادثة، تنقل كامل                             |
| **bthwani-web**     | قائمة وفلترة وبلاغاتي، بطاقة وتفاصيل مع "ينتهي بعد" والأولوية، نموذج مع urgency، صفحة سجّل كمتبرع                                                                             |
| **admin-dashboard** | قائمة مع فلترة وأعمدة urgency/expiresAt وإحصائيات، تفاصيل مع أولوية وانتهاء، صفحة قائمة المتبرعين و API donors                                                                |

### ⚠️ ما قد يُحسّن لاحقاً

| الميزة                               | الوصف                                                     |
| ------------------------------------ | --------------------------------------------------------- |
| **إرسال الإشعارات الفعلية**          | ربط DonorAlert بخدمة FCM/push (وربما SMS للحرج) للمتبرعين |
| **تحقق رقم الهاتف**                  | التحقق من هاتف المستخدم قبل السماح بنشر الطلب (اختياري)   |
| **عرض DonorAlerts في تفاصيل البلاغ** | قائمة تنبيهات البلاغ في صفحة تفاصيل البلاغ (أدمن)         |
| **فلتر "قريب من الانتهاء"**          | في أدمن: فلتر حسب expiresAt (مثلاً خلال 24 ساعة)          |

### ❌ ما لم يُنفذ (غير حرج أو مُستبعد)

| الميزة                   | التقييم                            |
| ------------------------ | ---------------------------------- |
| تكامل المستشفيات / CSV   | مُستبعد حسب الخطة (اعتبارات أمنية) |
| لوحة تحكم خاصة بمستشفيات | مُستبعد                            |

---

## 13. الخلاصة

**خدمة اسعفني** تنفذ **معظم** متطلبات **قسم بنك الدم (V7 – Find Blood)** من خطة الإكمال ووثائق التسليم:

- ✅ **طلبات الدم:** CRUD، urgency، expiresAt، انتهاء تلقائي 48 ساعة، فلترة وبلاغاتي وبحث
- ✅ **المتبرعون:** سجل متبرعين، تسجيل/تحديث/ملف، متبرعون قريبون، DonorAlert (تسجيل فقط)
- ✅ **المحادثة:** وحدة es3afni-chat مع إغلاق بعد 48 ساعة وإخفاء هوية المتبرع
- ✅ **المنصات:** app-user، bthwani-web، admin-dashboard مع قائمة المتبرعين وفلترة وإحصائيات

الفروقات الباقية هي أساساً: **إرسال الإشعارات الفعلية** (push/SMS) للمتبرعين، **تحقق الهاتف** (اختياري)، وعرض **DonorAlerts** في تفاصيل البلاغ بالأدمن، ويمكن إضافتها في مراحل لاحقة.

---

_تم إعداد هذا المستند بناءً على:_

- _خطة إكمال خدمة اسعفني – التبرع بالدم العاجل (PLAN_ES3AFNI_SERVICE_COMPLETION.md)_
- _مواصفات قسم بنك الدم (V7 – Find Blood) في وثائق التسليم_
- _تنفيذ خدمة اسعفني في backend-nest، app-user، bthwani-web، admin-dashboard_
