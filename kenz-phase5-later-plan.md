# خطة تنفيذ المرحلة اللاحقة لخدمة كنز (المرحلة 5)

هذا الملف يحدد **خطة التنفيذ التفصيلية** للميزات المؤجلة لخدمة كنز (V2 – Marketplace / Haraj) وفق مستند التسليم: **الإيكرو، توصيل/لقاء، نشر بالنيابة، والمزادات**.

---

## المراجع

- **المستند:** Full Handover Documents for bThwani Super App & Web Development
- **الخطة الأساسية:** `kenz-completion-plan.md`
- **المشاريع:** `backend-nest` | `admin-dashboard` | `bthwani-web` | `app-user`
- **المحفظة الحالية:** `backend-nest/src/modules/wallet` (يدعم `holdFunds`, `releaseFunds`, معاملات `escrow`)

---

## ترتيب التنفيذ المقترح

| الترتيب | الميزة       | التعقيد | التبعيات        | أولوية |
| ------- | ------------ | ------- | --------------- | ------ |
| 1       | نشر بالنيابة | منخفض   | لا              | عالية  |
| 2       | توصيل / لقاء | متوسط   | لا              | عالية  |
| 3       | الإيكرو      | عالي    | محفظة (موجودة)  | عالية  |
| 4       | المزادات     | عالي    | إيكرو (اختياري) | متوسطة |

---

# 1. نشر بالنيابة (Post on Behalf)

## الوصف

تمكين المستخدم من نشر إعلان **نيابة عن شخص آخر** (عائلة، صديق) مع تسجيل رقم الهاتف أو المستخدم الذي يُنشر الإعلان باسمه.

## 1.1 الباك اند (backend-nest)

| المهمة              | الوصف                                                                             | الملفات                                            |
| ------------------- | --------------------------------------------------------------------------------- | -------------------------------------------------- |
| إضافة حقول للإعلان  | `postedOnBehalfOfPhone?: string`, `postedOnBehalfOfUserId?: ObjectId` (اختياريان) | `modules/kenz/entities/kenz.entity.ts`             |
| تحديث DTOs          | إضافة الحقلين في Create و Update (اختياري)                                        | `dto/create-kenz.dto.ts`, `dto/update-kenz.dto.ts` |
| منطق التحقق         | إن رغبت: منع التعديل من غير المالك أو الأدمن                                      | `kenz.service.ts`                                  |
| إرجاع الحقول في API | عرض الحقول في التفاصيل والقائمة (أو إخفاؤها من القائمة حسب السياسة)               | `kenz.service.ts`                                  |

**تفاصيل تقنية:**

- في `kenz.entity.ts`:  
  `@Prop() postedOnBehalfOfPhone?: string;`  
  `@Prop({ type: Types.ObjectId, ref: 'User' }) postedOnBehalfOfUserId?: Types.ObjectId;`
- في الـ DTOs: الحقلان اختياريان؛ إن وُجد أحدهما يُعرض في التفاصيل كـ "نُشر بالنيابة عن".

## 1.2 لوحة التحكم (admin-dashboard)

| المهمة                | الوصف                                              | الملفات                             |
| --------------------- | -------------------------------------------------- | ----------------------------------- |
| عمود/حقل في قائمة كنز | عرض "نشر بالنيابة" ورقم الهاتف أو المستخدم إن وُجد | `pages/admin/kenz/KenzListPage.tsx` |
| في تفاصيل الإعلان     | عرض من نُشر الإعلان باسمه                          | `KenzDetailsPage.tsx` (إن وُجد)     |

## 1.3 الويب (bthwani-web) وتطبيق المستخدم (app-user)

| المهمة          | الوصف                                                      | الملفات                                       |
| --------------- | ---------------------------------------------------------- | --------------------------------------------- |
| نموذج النشر     | خيار "نشر بالنيابة عن" + حقل هاتف (أو بحث مستخدم)          | `KenzForm.tsx`, نموذج إنشاء/تعديل الإعلان     |
| أنواع البيانات  | إضافة الحقلين في types و payloads                          | `features/kenz/types.ts`, API                 |
| عرض في التفاصيل | نص مثل "نُشر بالنيابة عن: 77xxx" دون كشف كامل الرقم إن لزم | `KenzDetails.tsx` / شاشة التفاصيل في app-user |

---

# 2. توصيل / لقاء (Delivery or Meet-up)

## الوصف

إعطاء البائع خيار **طريقة التسليم**: إما **توصيل** (عبر منصة أو ذاتي) أو **لقاء يداً بيد** (استلام من البائع). المستند: _"Delivery + Escrow Option | Buyer selects delivery agent or meet-up"_.

## 2.1 الباك اند (backend-nest)

| المهمة              | الوصف                                                                                 | الملفات                                 |
| ------------------- | ------------------------------------------------------------------------------------- | --------------------------------------- |
| حقل طريقة التسليم   | `deliveryOption?: 'meetup' \| 'delivery' \| 'both'` (لقاء فقط، توصيل فقط، أو الاثنان) | `kenz.entity.ts`, DTOs                  |
| حقل اختياري للتوصيل | إن كان توصيل: `deliveryFee?: number` أو ربط لاحق بخدمة التوصيل                        | `kenz.entity.ts`, DTOs                  |
| فلتر في القائمة     | `GET /kenz?deliveryOption=delivery` لعرض إعلانات تقبل التوصيل                         | `kenz.controller.ts`, `kenz.service.ts` |

**تفاصيل تقنية:**

- في الـ entity:  
  `@Prop({ enum: ['meetup', 'delivery', 'both'] }) deliveryOption?: 'meetup' | 'delivery' | 'both';`  
  `@Prop() deliveryFee?: number;`
- القيمة الافتراضية يمكن أن تكون `meetup` للتوافق مع الإعلانات الحالية.

## 2.2 لوحة التحكم (admin-dashboard)

| المهمة            | الوصف                                              | الملفات                 |
| ----------------- | -------------------------------------------------- | ----------------------- |
| فلتر في قائمة كنز | ترشيح حسب "طريقة التسليم" (لقاء / توصيل / الاثنان) | `KenzListPage.tsx`, API |

## 2.3 الويب (bthwani-web) وتطبيق المستخدم (app-user)

| المهمة                  | الوصف                                                                  | الملفات                          |
| ----------------------- | ---------------------------------------------------------------------- | -------------------------------- |
| نموذج النشر             | اختيار: لقاء، توصيل، أو الاثنان؛ وإظهار حقل رسوم التوصيل إن لزم        | `KenzForm` / نموذج الإعلان       |
| فلتر في القائمة         | شريط فلتر: "لقاء فقط"، "توصيل متاح"، إلخ                               | `KenzList`, `KenzFilters`, types |
| عرض في البطاقة/التفاصيل | أيقونة أو نص: "لقاء"، "توصيل"، "لقاء أو توصيل" + رسوم التوصيل إن وُجدت | `KenzCard`, `KenzDetails`        |

---

# 3. الإيكرو (Escrow)

## الوصف

**احتجاز مبلغ الشراء في المحفظة** حتى يتم تأكيد الاستلام (أو الاتفاق على الإلغاء)، ثم تحويل المبلغ للبائع أو إرجاعه للمشتري. المحفظة الحالية تدعم `holdFunds(userId, amount, orderId)` و `releaseFunds`.

## 3.1 الباك اند (backend-nest)

| المهمة                  | الوصف                                                                                                                                | الملفات                                           |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------- |
| خيار الإيكرو في الإعلان | `acceptsEscrow?: boolean` (افتراضي false)                                                                                            | `kenz.entity.ts`, DTOs                            |
| جدول/مجموعة صفقات كنز   | `kenz_deals`: `kenzId`, `buyerId`, `sellerId`, `amount`, `status`, `escrowTransactionId?`, `createdAt`, `completedAt?`               | وحدة جديدة `kenz-deal` أو داخل `kenz`             |
| إنشاء صفقة + حجز مبلغ   | المشتري يطلب الشراء بالإيكرو → إنشاء سجل صفقة → استدعاء `walletService.holdFunds(buyerId, amount, dealId)`                           | `kenz-deal.service.ts`, تكامل مع `WalletService`  |
| تأكيد الاستلام / إلغاء  | حالة الصفقة: `pending`, `completed`, `cancelled`. عند التأكيد: تحويل للمشتري (إطلاق حجز + ائتمان للبائع). عند الإلغاء: إرجاع للمشتري | `kenz-deal.service.ts`, `wallet.service.ts`       |
| Endpoints               | `POST /kenz/:id/buy-with-escrow` (إنشاء صفقة + حجز)، `POST /kenz/deals/:dealId/confirm-received`, `POST /kenz/deals/:dealId/cancel`  | `kenz.controller.ts` أو `kenz-deal.controller.ts` |
| صلاحيات                 | فقط المشتري يؤكد الاستلام؛ البائع أو المشتري يلغي (حسب السياسة)                                                                      | في الـ service                                    |

**تفاصيل تقنية:**

- **KenzDeal entity:**  
  `kenzId`, `buyerId`, `sellerId` (من الإعلان), `amount`, `status: 'pending' | 'completed' | 'cancelled'`, `walletHoldTransactionId?`, `createdAt`, `completedAt?`, `cancelledAt?`
- ربط الحجز: استخدام `meta: { orderId: dealId }` أو ما يعادله في معاملات المحفظة لربط الإطلاق/الإرجاع بنفس الصفقة.
- إطلاق للمشتري: استدعاء `releaseFunds` ثم تحويل المبلغ من المشتري إلى البائع (أو خصم من المشتري وائتمان للبائع حسب تصميم المحفظة).

## 3.2 لوحة التحكم (admin-dashboard)

| المهمة                   | الوصف                                                       | الملفات                              |
| ------------------------ | ----------------------------------------------------------- | ------------------------------------ |
| صفحة صفقات كنز (اختياري) | قائمة صفقات بالإيكرو: إعلان، مشتري، بائع، مبلغ، حالة، تاريخ | `pages/admin/kenz/KenzDealsPage.tsx` |
| تدخل في النزاعات         | إن وُجدت سياسة نزاعات: عرض صفقة وتغيير حالتها أو إرجاع يدوي | حسب الحاجة لاحقاً                    |

## 3.3 الويب (bthwani-web) وتطبيق المستخدم (app-user)

| المهمة             | الوصف                                                                                  | الملفات                                     |
| ------------------ | -------------------------------------------------------------------------------------- | ------------------------------------------- |
| زر "شراء بالإيكرو" | في تفاصيل الإعلان إن كان `acceptsEscrow === true`؛ يفتح تأكيد المبلغ والدفع من المحفظة | `KenzDetails`, API                          |
| صفحة "صفقاتي"      | قائمة صفقات المستخدم (كمشتري أو بائع) مع أزرار "تم الاستلام" و "إلغاء" حسب الحالة      | صفحة جديدة أو تبويب في الطلبات/الملف الشخصي |
| إشعارات            | إشعار عند إنشاء صفقة، عند التأكيد أو الإلغاء                                           | FCM/Web Push إن مُفعّل                      |

---

# 4. المزادات (Auctions)

## الوصف

إعلان يمكن أن يكون **مزاداً**: له **وقت انتهاء** ويقبل **مزايدات**. عند انتهاء الوقت يُحدد الفائز (أعلى مزايدة) ويمكن ربطه لاحقاً بالإيكرو.

## 4.1 الباك اند (backend-nest)

| المهمة               | الوصف                                                                                                                                                         | الملفات                                                      |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| حقول الإعلان         | `isAuction?: boolean`, `auctionEndAt?: Date` (مطلوب إن كان `isAuction === true`)                                                                              | `kenz.entity.ts`, DTOs                                       |
| جدول المزايدات       | `kenz_bids`: `kenzId`, `bidderId`, `amount`, `createdAt`؛ فهرس مركب لضمان عدم تكرار مزايدة من نفس المستخدم بنفس الوقت                                         | وحدة `kenz-bid`                                              |
| قواعد المزايدة       | المبلغ > آخر مزايدة (أو > السعر الافتتاحي إن وُجد)، والوقت قبل `auctionEndAt`                                                                                 | `kenz-bid.service.ts`                                        |
| Endpoints            | `POST /kenz/:id/bid`, `GET /kenz/:id/bids` (للمزايدات الحالية، مع حماية بيانات المستخدمين إن لزم)                                                             | `kenz.controller.ts` أو `kenz-bid.controller.ts`             |
| Cron إغلاق المزاد    | مهمة دورية: إعلانات `isAuction === true` و `auctionEndAt <= now` → تحديث حالة الإعلان (مثلاً `status = completed`) وتحديد الفائز (أعلى مزايدة) وإرسال إشعارات | `kenz-auction.processor.ts` أو داخل `kenz.service.ts` + Cron |
| اختياري: سعر افتتاحي | `startingPrice?: number` في الإعلان                                                                                                                           | `kenz.entity.ts`, DTOs                                       |

**تفاصيل تقنية:**

- **KenzBid entity:**  
  `kenzId`, `bidderId`, `amount`, `createdAt`  
  فهرس: `{ kenzId: 1, amount: -1 }` لاستعلام "أعلى مزايدة".
- عند إغلاق المزاد: حفظ `winnerId` و `winningBidAmount` في الإعلان أو في جدول الصفقات لربط لاحق بالإيكرو.

## 4.2 لوحة التحكم (admin-dashboard)

| المهمة        | الوصف                                                      | الملفات               |
| ------------- | ---------------------------------------------------------- | --------------------- |
| فلتر "مزاد"   | في قائمة كنز: إظهار إعلانات المزادات فقط                   | `KenzListPage.tsx`    |
| عرض المزايدات | في تفاصيل إعلان مزاد: جدول المزايدات (مبلغ، مستخدم، تاريخ) | `KenzDetailsPage.tsx` |

## 4.3 الويب (bthwani-web) وتطبيق المستخدم (app-user)

| المهمة                         | الوصف                                                          | الملفات                    |
| ------------------------------ | -------------------------------------------------------------- | -------------------------- |
| إنشاء إعلان مزاد               | تفعيل "مزاد" + تحديد وقت النهاية (وسعر افتتاحي إن وُجد)        | نموذج النشر                |
| عرض المزاد في القائمة/التفاصيل | شارة "مزاد" + عد تنازلي لـ `auctionEndAt`                      | `KenzCard`, `KenzDetails`  |
| واجهة المزايدة                 | حقل إدخال المبلغ + زر "مزايدة" مع التحقق من الحد الأدنى والوقت | `KenzDetails` أو مكون فرعي |
| قائمة المزايدات                | عرض المزايدات (أعلى مزايدة، عدد المزايدات، آخر وقت)            | نفس صفحة التفاصيل          |

---

# 5. ملخص التكامل والتبعيات

| الميزة       | الباك اند                       | لوحة التحكم             | الويب / التطبيق                 |
| ------------ | ------------------------------- | ----------------------- | ------------------------------- |
| نشر بالنيابة | حقول + DTOs + منطق اختياري      | عرض في القائمة/التفاصيل | نموذج نشر + عرض في التفاصيل     |
| توصيل/لقاء   | حقول + فلتر                     | فلتر                    | نموذج + فلتر + عرض              |
| الإيكرو      | صفقات + تكامل محفظة + endpoints | صفحة صفقات (اختياري)    | شراء بالإيكرو + صفحة صفقاتي     |
| المزادات     | حقول + جدول مزايدات + Cron      | فلتر + عرض مزايدات      | إنشاء مزاد + مزايدة + عد تنازلي |

**تبعيات تقنية:**

- الإيكرو يعتمد على **WalletModule** (موجود) وواجهات `holdFunds` / `releaseFunds` (أو ما يُضاف للإرجاع).
- المزادات مستقلة عن الإيكرو في المرحلة الأولى؛ ربط "الشراء بالإيكرو" لفائز المزاد يمكن أن يكون مرحلة تالية.

---

# 6. Checklist تنفيذ مقترح (ترتيب التنفيذ)

## 6.1 نشر بالنيابة

- [x] **الباك اند:** إضافة `postedOnBehalfOfPhone`, `postedOnBehalfOfUserId` في entity و DTOs
- [x] **لوحة التحكم:** عرض الحقول في قائمة وتفاصيل كنز
- [x] **الويب:** خيار "نشر بالنيابة" + حقل هاتف في النموذج، وعرض في التفاصيل
- [x] **التطبيق:** نفس المنطق في نموذج النشر وتفاصيل الإعلان

## 6.2 توصيل / لقاء

- [x] **الباك اند:** إضافة `deliveryOption`, `deliveryFee` في entity و DTOs + فلتر في list
- [x] **لوحة التحكم:** فلتر طريقة التسليم
- [x] **الويب:** اختيار في النموذج + فلتر + عرض في البطاقة/التفاصيل
- [x] **التطبيق:** نفس المنطق

## 6.3 الإيكرو

- [x] **الباك اند:** حقل `acceptsEscrow` في كنز؛ إنشاء وحدة/جدول صفقات (KenzDeal)؛ تكامل hold/release مع المحفظة؛ endpoints إنشاء صفقة، تأكيد استلام، إلغاء
- [x] **لوحة التحكم:** (اختياري) صفحة صفقات كنز
- [x] **الويب:** زر شراء بالإيكرو + صفحة/تبويب "صفقاتي"
- [x] **التطبيق:** نفس المنطق

## 6.4 المزادات

- [ ] **الباك اند:** حقول `isAuction`, `auctionEndAt`, (اختياري) `startingPrice`؛ جدول مزايدات + endpoints مزايدة وجلب مزايدات؛ Cron إغلاق المزاد وإشعارات
- [ ] **لوحة التحكم:** فلتر مزاد + عرض المزايدات في التفاصيل
- [ ] **الويب:** إنشاء إعلان مزاد + واجهة مزايدة + عد تنازلي وعرض مزايدات
- [ ] **التطبيق:** نفس المنطق

---

_تم إعداد هذه الخطة لاستخدامها عند الشروع في تنفيذ المرحلة اللاحقة لخدمة كنز. يمكن تعديل الأولويات والتفاصيل حسب موارد الفريق والجدول الزمني._
