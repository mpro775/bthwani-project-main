# خطة إصلاح وتوافق: تطبيق السائق × كنز (بدلاً من حراج)

> **التاريخ:** 11 فبراير 2025  
> **الغرض:** فحص rider-app ومقارنته بالباك اند، إنشاء خطة إصلاح وتوافق بعد تغيير حراج إلى كنز  
> **ملاحظة:** كنز يعمل نفس عمل حراج (السوق المفتوح / التوصيل الخفيف)  
> **ملاحظة:** بدلاً من women صارت أماني (خدمة النقل النسائي)

---

## 1. ملخص التنفيذ

| المرحلة | الوصف | الأولوية |
|---------|-------|----------|
| 1 | إعادة تسمية حراج → كنز في rider-app | عالية |
| 2 | توافق واجهات كنز مع الباك اند | عالية |
| 3 | ربط توصيل كنز بسائق light_driver (إن رُغب) | متوسطة |
| 4 | تطبيق بنود PLAN_RIDER_APP_BACKEND_ALIGNMENT | عالية |

---

## 2. الحالة الحالية

### 2.1 rider-app — شاشة حراج

| العنصر | الحالة الحالية |
|--------|----------------|
| **الملف** | `app/(driver)/haraj.tsx` |
| **العنوان** | "مرحباً بك في قسم التوصيل الخفيف (Haraj)" |
| **الأزرار** | طلبات (type=light_driver)، محفظة، حساب |
| **التوجيه** | `/orders?type=light_driver` |
| **الروابط** | `/wallet`, `/profile` |

### 2.2 الباك اند — كنز

| العنصر | الحالة |
|--------|--------|
| **الموديول** | `kenz` — كامل (إعلانات، فئات، صفقات، إيكرو، مزادات) |
| **API** | `/kenz`, `/kenz/deals`, `/kenz/:id/bid` إلخ |
| **التوصيل** | `deliveryOption`, `deliveryFee` في كيان Kenz |
| **تعيين سائق** | ❌ غير موجود — لا يوجد `deliveryId` ولا `assign-delivery` |

### 2.3 مقارنة معروف (للتوحيد)

| الميزة | معروف | كنز |
|--------|-------|-----|
| `deliveryToggle` | ✅ | ❌ |
| `deliveryId` | ✅ | ❌ |
| `POST :id/assign-delivery` | ✅ | ❌ |
| `GET deliveries/list` (للسائق) | ✅ | ❌ |

---

## 3. إعادة التسمية: حراج → كنز

### 3.1 الملفات المطلوب تعديلها

| الملف | التعديل |
|-------|---------|
| `app/(driver)/haraj.tsx` | إعادة تسمية الملف إلى `kanz.tsx` وتحديث المحتوى |
| `تقرير_تطبيق_السائق_للتسليم_للعميل.md` | استبدال "حراج" بـ "كنز" |

### 3.2 محتوى الشاشة الجديد (كنز)

```tsx
// app/(driver)/kanz.tsx
// قسم كنز — التوصيل الخفيف ( market place / إعلانات)
- العنوان: "مرحباً بك في قسم كنز"
- الزر: "طلبات التوصيل" → /orders?type=light_driver
- الزر: "المحفظة" → /wallet
- الزر: "الحساب" → /profile
```

### 3.3 روابط التنقل

- التأكد من وجود رابط لشاشة كنز في القائمة/الملف الشخصي (حسب role السائق).
- لو كان التوجيه يتم من `profile` أو `home` حسب `driver.role === 'light_driver'`، تحديث النصوص والأيقونات لاستخدام "كنز".

---

## 4. توافق الطلبات مع نوع السائق

### 4.1 المشكلة الحالية

| العنصر | rider-app | الباك اند |
|--------|-----------|-----------|
| **استدعاء الطلبات** | `getDriverOrders()` → `/drivers/orders/available` | يعيد طلبات `Order` بحالة READY بدون سائق |
| **فلترة حسب role** | يمرر `type=light_driver` للواجهة فقط | ❌ لا يفلتر حسب `driver.role` |
| **نوع الطلب** | لا يمرر `orderType` | `Order.orderType`: marketplace, errand, utility |

### 4.2 الحل المقترح

#### في الباك اند (`driver.service.ts`)

```ts
// في getAvailableOrders — إضافة فلترة حسب role السائق
async getAvailableOrders(driverId: string) {
  const driver = await this.driverModel.findById(driverId);
  // ...
  const query: any = {
    status: OrderStatus.READY,
    driver: { $exists: false },
  };
  // فلترة حسب role السائق
  if (driver.role === 'light_driver') {
    query.orderType = OrderType.MARKETPLACE; // أو نوع مخصص لكنز
  } else if (driver.role === 'women_driver') {
    // طلبات أماني (خدمة النقل النسائي)
  }
  // ...
}
```

#### في rider-app

- تمرير `type` إلى API إن أضيف دعمه:
  ```ts
  getDriverOrders(type?: 'rider_driver' | 'light_driver' | 'women_driver') {
    const params = type ? { driverType: type } : {};
    return axios.get("/drivers/orders/available", { params });
  }
  ```

---

## 5. ربط توصيل كنز بسائق light_driver (مرحلة لاحقة)

### 5.1 الخيار أ: نمط معروف

إضافة حقول وتعيين توصيل في كنز مثل معروف:

| التعديل | الملف | الوصف |
|---------|-------|-------|
| `deliveryToggle` | `kenz.entity.ts` | تفعيل طلب توصيل للإعلان |
| `deliveryId` | `kenz.entity.ts` | معرف السائق المعيّن |
| `POST /kenz/:id/assign-delivery` | `kenz.controller.ts` | تعيين سائق |
| `GET /kenz/deliveries/list` | `kenz.controller.ts` | قائمة مهام التوصيل لـ light_driver |

### 5.2 الخيار ب: استخدام Order

- إنشاء طلب توصيل `Order` عند شراء إعلان كنز بخيار توصيل.
- `orderType` جديد مثل `kenz_delivery` أو استخدام `MARKETPLACE` مع `meta.kenzDealId`.
- يساهم السائق في نظام الطلبات الحالي.

### 5.3 التوصية

- البدء بالخيار أ (نمط معروف) للتماسك مع معروف.
- إضافة `deliveryToggle` و `deliveryId` في كيان كنز و endpoint تعيين توصيل.

---

## 6. تطبيق خطة التوافق السابقة (PLAN_RIDER_APP_BACKEND_ALIGNMENT)

يُفضّل تنفيذ بنود الخطة السابقة مع التعديلات الحالية:

| البند | الحالة |
|-------|--------|
| Auth: مسار `/auth/driver/login` | ✅ rider-app يستخدمه بالفعل |
| Auth: دعم `phone` في الباك اند | مراجعة |
| walletApi: استخدام v1 بدل v2 | مراجعة |
| axiosInstance | يوجد `axiosInstance.ts` — التحقق من الاستخدام |

---

## 7. ملخص الملفات المطلوب تعديلها

### rider-app

| الملف | التعديل |
|-------|---------|
| `app/(driver)/haraj.tsx` | إعادة تسمية → `kanz.tsx` وتحديث النصوص |
| `app/(driver)/haraj` (إن وُجد في routing) | تحديث المسار إلى `kanz` |
| `src/api/driver.ts` | إضافة معامل `driverType` لـ `getDriverOrders` عند دعم الباك اند |
| `تقرير_تطبيق_السائق_للتسليم_للعميل.md` | استبدال حراج بـ كنز |

### backend-nest

| الملف | التعديل |
|-------|---------|
| `driver.service.ts` | فلترة `getAvailableOrders` حسب `driver.role` (عند الحاجة) |
| `kenz.entity.ts` | (اختياري) إضافة `deliveryToggle`, `deliveryId` |
| `kenz.controller.ts` | (اختياري) `assign-delivery`, `deliveries/list` |

### إزالة/تحديث

- إزالة أي مرجع لـ "haraj" في الـ UI والوثائق.
- استبدال "حراج" بـ "كنز" في جميع النصوص.

---

## 8. ترتيب التنفيذ المقترح

1. **مرحلة 1 — إعادة التسمية**
   - إعادة تسمية `haraj.tsx` → `kanz.tsx`
   - تحديث النصوص والعناوين
   - تحديث الوثائق والروابط

2. **مرحلة 2 — توافق الطلبات**
   - إضافة فلترة حسب `driver.role` في الباك اند (إن لزم)
   - تمرير `type` من rider-app عند طلب الطلبات

3. **مرحلة 3 — توصيل كنز (اختياري)**
   - إضافة دعم التوصيل في كنز على نمط معروف
   - إنشاء مسارات التوصيل في rider-app لسائق كنز

4. **مرحلة 4 — المتابعة**
   - تنفيذ بنود `PLAN_RIDER_APP_BACKEND_ALIGNMENT` المتبقية
   - اختبار تسجيل الدخول، المحفظة، والطلبات

---

## 9. ملاحظة: women → أماني

| القديم | الجديد |
|--------|--------|
| women / سائقة | **أماني** (خدمة النقل النسائي) |
| `women.tsx` | يمكن إبقاء الاسم أو توحيد المحتوى مع شاشات أماني |

- شاشة `women.tsx` تعرض "أهلاً بك، سائقة التوصيل" مع روابط: رحلاتي، طلبات أماني، الرصيد، الإعدادات.
- طلبات أماني الفعلية تظهر من `(driver)/amani` — قائمة أماني المخصصة.
- يُفضّل توحيد العناوين والنصوص لاستخدام "أماني" بدلاً من "women" في الواجهة.

---

## 10. ملاحظات

- **كنز = حراج** من ناحية الوظيفة (سوق مفتوح، إعلانات، توصيل اختياري).
- **light_driver** = سائق توصيل خفيف لإعلانات السوق.
- **women_driver** = سائقة أماني (خدمة النقل النسائي) — بدلاً من "women" صارت "أماني".
- الباك اند لكنز مكتمل (إعلانات، صفقات، إيكرو، مزادات)؛ الربط مع تطبيق السائق ما زال ناقصاً.
- معروف يوفّر نموذج جاهز للتوصيل (`deliveryToggle`, `deliveryId`, `assign-delivery`) يمكن تقليده في كنز.
- **أماني:** الاسم الجديد لخدمة النقل النسائي (بدلاً من women).
