# خطة إكمال خدمة أماني – النقل النسائي للعائلات

هذه الخطة لإكمال **خدمة أماني** وربطها بشكل صحيح بين:

- **تطبيق المستخدم** (app-user)
- **تطبيق السائقات** (rider-app)
- **لوحة التحكم** (admin-dashboard)
- **الخادم** (backend-nest)

---

## الوضع الحالي vs الهدف

| الجانب                        | الوضع الحالي                                            | الهدف                                                |
| ----------------------------- | ------------------------------------------------------- | ---------------------------------------------------- |
| **خيار سائقة أنثى فقط**       | غير موجود في واجهة المستخدم                             | إضافة خيار واضح عند إنشاء الطلب                      |
| **تعيين السائق**              | Auto-assign يُعيّن أقرب سائق (بدون فلتر جنس)            | فلتر حسب `womenOnly` + دعم قبول يدوي من السائقة      |
| **API طلبات السائق**          | `GET /amani/driver/my-orders` يرمي استثناء              | تنفيذ كامل مع مصادقة السائق                          |
| **قبول الطلب في rider-app**   | يستدعي `getAvailableAmaniOrders` بدل `acceptAmaniOrder` | استدعاء API قبول صحيح مع تعيين السائق                |
| **تعيين سائق من لوحة التحكم** | غير موجود                                               | إضافة واجهة تعيين سائق يدوياً (مثل أكرمني)           |
| **عرض الطلبات للسائقات فقط**  | كل السائقين يرون طلبات أماني                            | عرض الطلبات المتاحة للسائقات فقط (role=women_driver) |

---

## المرحلة 1: Backend – تحسين منطق التعيين وخيار سائقة أنثى

### 1.1 إضافة حقل `womenOnly` في الطلب

| #     | المهمة                                    | الملف                     | التفاصيل                                                                                   |
| ----- | ----------------------------------------- | ------------------------- | ------------------------------------------------------------------------------------------ |
| 1.1.1 | إضافة `womenOnly` في metadata أو حقل مخصص | `amani.entity.ts`         | إضافة `metadata?.womenOnly: boolean` أو حقل `preferredDriverType: 'women_driver' \| 'any'` |
| 1.1.2 | تحديث CreateAmaniDto                      | `dto/create-amani.dto.ts` | دعم `metadata.womenOnly` أو `preferredDriverType`                                          |
| 1.1.3 | تحديث UpdateAmaniDto                      | `dto/update-amani.dto.ts` | نفس التعديل                                                                                |

### 1.2 فلتر السائقين في assignDriverAuto

| #     | المهمة                    | الملف                                     | التفاصيل                                                                                                                                     |
| ----- | ------------------------- | ----------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.2.1 | فلتر حسب womenOnly        | `amani.service.ts` → `assignDriverAuto()` | عند `amani.metadata?.womenOnly === true`: إضافة شرط `$or: [{ role: 'women_driver' }, { isFemaleDriver: true }]` في استعلام السائقين المتاحين |
| 1.2.2 | رسالة عند عدم توفر سائقات | نفس الدالة                                | إذا لم يوجد سائقون مطابقون: `NotFoundException('لا توجد سائقات متاحات حالياً')`                                                              |

### 1.3 تنفيذ `getMyDriverOrders` مع مصادقة السائق

| #     | المهمة                                  | الملف                 | التفاصيل                                                                                                                      |
| ----- | --------------------------------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| 1.3.1 | إنشاء/استخدام Guard أو Decorator للسائق | `auth` أو `guards`    | استخراج `driverId` من التوكن أو من علاقة Driver-User                                                                          |
| 1.3.2 | تنفيذ getMyDriverOrders                 | `amani.controller.ts` | استدعاء `amaniService.getDriverOrders(driverId, status)` بدل رمي الاستثناء                                                    |
| 1.3.3 | إضافة getDriverOrders في Service        | `amani.service.ts`    | دالة `getDriverOrders(driverId: string, status?: string)` تعيد طلبات حيث `driver = driverId`                                  |
| 1.3.4 | تحديد آلية ربط Driver بـ User           | وثائق/تطبيق           | إذا كان السائق يسجل دخوله بتوكن مستخدم: نحتاج ربط `Driver.userId` أو استخدام `driverId` من التوكن (حسب بنية المصادقة الحالية) |

### 1.3.5 فلتر الطلبات المتاحة حسب status

| #       | المهمة                        | الملف                                      | التفاصيل                                                                                                                                    |
| ------- | ----------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.3.5.1 | إضافة فلتر status إلى findAll | `amani.controller.ts` + `amani.service.ts` | rider-app يرسل `?status=pending` لكن findAll لا يطبقه. إضافة `@Query('status')` واستخدامه في الاستعلام لفلترة الطلبات غير المعينة (pending) |
| 1.3.5.2 | فلتر الطلبات المعينة فقط      | عند الحاجة                                 | للطلبات المتاحة للسائقات: `status=pending` و `driver` غير موجود                                                                             |

### 1.4 API قبول الطلب من السائقة (تعيين يدوي)

| #     | المهمة                        | الملف                              | التفاصيل                                                                                                                                            |
| ----- | ----------------------------- | ---------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.4.1 | استحداث endpoint تعيين ذاتي   | `amani.controller.ts`              | `POST /amani/:id/accept` — السائق الحالي يقبل الطلب ويُعيَّن له (بدل auto الذي يعيّن الأقرب)                                                        |
| 1.4.2 | التحقق من دور السائق          | Guard/Service                      | التأكد أن السائق له `role === 'women_driver'` أو `isFemaleDriver === true` لقبول طلبات أماني                                                        |
| 1.4.3 | فلتر الطلبات المتاحة للسائقات | `amani.controller.ts` أو `findAll` | عند طلب السائق للطلبات المتاحة: إرجاع طلبات `status=pending` فقط (غير معينة). اختياري: فلتر بحسب `womenOnly` إذا أردنا عرض طلبات معينة للسائقات فقط |

### 1.5 إصلاح تعارض المسارات (Route Order)

| #     | المهمة                       | الملف                 | التفاصيل                                                                                                                                                                                                            |
| ----- | ---------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.5.1 | ترتيب المسارات في Controller | `amani.controller.ts` | **حرج**: `Get('driver/my-orders')` مُعرَّف حالياً **بعد** `Get(':id')`، لذا الطلب `GET /amani/driver/my-orders` يطابق `:id` ويُفسَّر كـ `id='driver'`. يجب نقل `Get('driver/my-orders')` ليكون **قبل** `Get(':id')` |

---

## المرحلة 2: تطبيق المستخدم (app-user)

### 2.1 خيار «سائقة أنثى فقط» في نموذج الطلب

| #     | المهمة                   | الملف                   | التفاصيل                                                       |
| ----- | ------------------------ | ----------------------- | -------------------------------------------------------------- |
| 2.1.1 | إضافة Toggle/Checkbox    | `AmaniCreateScreen.tsx` | خيار «أفضل سائقة أنثى» أو «سائقة أنثى فقط» مع نص توضيحي        |
| 2.1.2 | تخزين القيمة في metadata | نفس الملف               | `metadata: { ...metadata, womenOnly: true/false }` عند الإرسال |
| 2.1.3 | نفس الخيار في التعديل    | `AmaniEditScreen.tsx`   | عرض وتحديث القيمة                                              |

### 2.2 عرض حالة «سائقة أنثى» في تفاصيل الطلب

| #     | المهمة                          | الملف                    | التفاصيل                                                           |
| ----- | ------------------------------- | ------------------------ | ------------------------------------------------------------------ |
| 2.2.1 | عرض Badge أو نص                 | `AmaniDetailsScreen.tsx` | إذا `metadata?.womenOnly` عرض «سائقة أنثى فقط»                     |
| 2.2.2 | عرض معلومات السائقة عند التعيين | نفس الملف                | اسم السائقة، هاتف (إن كان مسموحاً). الربط مع Socket للتحديث الفوري |

### 2.3 المسار والتنقل

| #     | المهمة                                          | الملف                       | التفاصيل                                              |
| ----- | ----------------------------------------------- | --------------------------- | ----------------------------------------------------- |
| 2.3.1 | التحقق من وجود أماني في القائمة/التبويب الرئيسي | `navigation` أو `Home`      | التأكد أن المستخدم يصل لـ «أماني» من الواجهة الرئيسية |
| 2.3.2 | تكامل Socket للتحديث الفوري                     | `useAmaniSocket` أو ما شابه | تحديث التفاصيل عند تغيير الحالة أو تعيين السائق       |

---

## المرحلة 3: تطبيق السائقات (rider-app)

### 3.1 إصلاح منطق قبول الطلب

| #     | المهمة                    | الملف                 | التفاصيل                                                                                     |
| ----- | ------------------------- | --------------------- | -------------------------------------------------------------------------------------------- |
| 3.1.1 | استدعاء API قبول صحيح     | `AmaniListScreen.tsx` | في `handleAcceptOrder`: استدعاء `acceptAmaniOrder(item._id)` بدل `getAvailableAmaniOrders()` |
| 3.1.2 | التعامل مع API تعيين ذاتي | `amani.ts` (API)      | إذا أضفنا `POST /amani/:id/accept`: إنشاء `acceptAmaniOrder(amaniId)` يستدعي هذا المسار      |
| 3.1.3 | تحديث القائمة بعد القبول  | `AmaniListScreen.tsx` | بعد نجاح القبول: إزالة الطلب من «متاحة» وإضافته لـ «طلباتي»، أو إعادة تحميل كلا التبويبين    |

### 3.2 عرض الطلبات للسائقات فقط

| #     | المهمة                          | الملف                                | التفاصيل                                                                                                             |
| ----- | ------------------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------------------- |
| 3.2.1 | التحقق من دور السائق عند الدخول | `(driver)/amani/index.tsx` أو Layout | التأكد أن المستخدم سائق/سائقة قبل عرض شاشة أماني                                                                     |
| 3.2.2 | فلتر الطلبات حسب الدور          | Backend                              | `GET /amani?status=pending` قد يبقى كما هو. الطلبات المتاحة = غير معينة. السائقات فقط يرون أماني (من شاشة women.tsx) |
| 3.2.3 | ربط women.tsx بالتنقل           | `women.tsx`                          | زر «طلبات أماني» يوجه لـ `/amani` — التحقق من صحة المسار في expo-router                                              |

### 3.3 استكمال getMyAmaniOrders

| #     | المهمة                                  | الملف                  | التفاصيل                                                                                  |
| ----- | --------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------- |
| 3.3.1 | ضبط استجابة API                         | `amani.ts` (rider-app) | التأكد أن `getMyAmaniOrders` يتعامل مع الصيغة الصحيحة للاستجابة (مثلاً `data` أو `items`) |
| 3.3.2 | التعامل مع خطأ «يجب تسجيل الدخول كسائق» | rider-app              | عرض رسالة واضحة وإعادة توجيه لتسجيل الدخول كسائق إن لزم                                   |

### 3.4 تحسين شاشة تفاصيل الطلب للسائقة

| #     | المهمة                        | الملف                                | التفاصيل                                                      |
| ----- | ----------------------------- | ------------------------------------ | ------------------------------------------------------------- |
| 3.4.1 | عرض العنوان والوجهة على خريطة | `AmaniDetailsScreen.tsx` (rider-app) | إن أمكن: عرض نقطة الانطلاق والوصول                            |
| 3.4.2 | أزرار تغيير الحالة            | نفس الملف                            | أزرار: «بدء الرحلة» → in_progress، «إنهاء الرحلة» → completed |
| 3.4.3 | زر SOS                        | نفس الملف                            | ربط بـ `triggerSOS` أو خدمة الطوارئ المدمجة                   |
| 3.4.4 | تحديث الموقع الحالي           | Socket / API                         | إرسال `driverLocation` عند التحرك (إن وُجد endpoint)          |

---

## المرحلة 4: لوحة التحكم (admin-dashboard)

### 4.1 تعيين سائق يدوياً

| #     | المهمة                 | الملف                              | التفاصيل                                                                       |
| ----- | ---------------------- | ---------------------------------- | ------------------------------------------------------------------------------ |
| 4.1.1 | إضافة زر «تعيين سائق»  | `AmaniDetailsPage.tsx`             | عند الحالة pending أو confirmed، عرض زر لفتح نافذة تعيين                       |
| 4.1.2 | Dialog تعيين السائق    | نفس الملف                          | قائمة منسدلة أو بحث عن السائقين. فلتر حسب `role=women_driver` لطلبات womenOnly |
| 4.1.3 | استدعاء API التعيين    | `api/amani.ts`                     | `assignDriver(amaniId, driverId)` → `POST /amani/:id/assign-driver`            |
| 4.1.4 | إنشاء API جلب السائقات | `api/amani.ts` أو `api/drivers.ts` | `getWomenDrivers()` أو `getDrivers({ role: 'women_driver' })`                  |
| 4.1.5 | عرض السائق المعين      | `AmaniDetailsPage.tsx`             | عند وجود `driver`، عرض اسمه وبياناته. إمكانية تغيير السائق في حالات معينة      |

### 4.2 تحسين صفحة القائمة

| #     | المهمة            | الملف               | التفاصيل                                               |
| ----- | ----------------- | ------------------- | ------------------------------------------------------ |
| 4.2.1 | عمود «سائقة أنثى» | `AmaniListPage.tsx` | إظهار badge أو أيقونة إن كان الطلب `womenOnly`         |
| 4.2.2 | عمود «السائق»     | نفس الملف           | عرض اسم السائق إن وُجد                                 |
| 4.2.3 | فلتر حسب الحالة   | نفس الملف           | فلتر: الكل، pending، confirmed، in_progress، completed |

### 4.3 صفحة التسعير

| #     | المهمة                     | الملف                  | التفاصيل                                                                         |
| ----- | -------------------------- | ---------------------- | -------------------------------------------------------------------------------- |
| 4.3.1 | التحقق من عمل صفحة التسعير | `AmaniPricingPage.tsx` | التأكد أن `getAmaniPricing` و `updateAmaniPricing` يعملان بشكل صحيح مع الإعدادات |

---

## المرحلة 5: Websocket والتحديث الفوري

### 5.1 بوابة أماني (Amani Gateway)

| #     | المهمة                   | الملف                       | التفاصيل                                                                                   |
| ----- | ------------------------ | --------------------------- | ------------------------------------------------------------------------------------------ |
| 5.1.1 | التحقق من الربط          | `gateways/amani.gateway.ts` | التأكد من أحداث: `amani:driver_assigned`، `amani:status_updated`، `amani:location_updated` |
| 5.1.2 | انضمام السائق للغرفة     | نفس الملف                   | عند تعيين السائق: دعوة `driver_${driverId}` لاستقبال `amani:new_assignment`                |
| 5.1.3 | ربط app-user بالـ Socket | `app-user`                  | الاشتراك في `amani:join` مع `amaniId` واستقبال التحديثات                                   |

### 5.2 ربط rider-app بالـ Socket

| #     | المهمة                  | الملف                     | التفاصيل                                                                   |
| ----- | ----------------------- | ------------------------- | -------------------------------------------------------------------------- |
| 5.2.1 | إعداد Socket client     | rider-app                 | استخدام `socket.io-client` مع نفس الـ namespace `/amani`                   |
| 5.2.2 | الاستماع لتعيينات جديدة | AmaniListScreen أو Layout | عند `amani:new_assignment` تحديث قائمة «طلباتي» وإظهار إشعار               |
| 5.2.3 | إرسال الموقع            | AmaniDetailsScreen        | عند وجود طلب قيد التنفيذ: إرسال الموقع عبر `amani:update_location` إن وُجد |

---

## المرحلة 6: المصادقة وربط السائق بالمستخدم

### 6.1 تحديد آلية تسجيل دخول السائق

| #     | المهمة                 | التفاصيل                                                                                                   |
| ----- | ---------------------- | ---------------------------------------------------------------------------------------------------------- |
| 6.1.1 | مراجعة Auth الحالي     | هل السائق يسجل دخوله كـ User عادي؟ أم لديه تطبيق rider-app منفصل وتوكن خاص؟                                |
| 6.1.2 | ربط Driver بـ User     | إذا كان السائق = User: نحتاج `Driver.userId` أو جدول ربط. إذا كان منفصل: `driverId` يُستخرج من توكن السائق |
| 6.1.3 | Guard للتحقق من السائق | إنشاء `DriverGuard` أو `@CurrentDriver()` يستخرج `driverId` من التوكن ويحقنها في الطلب                     |

### 6.2 قاعدة البيانات

| #     | المهمة                  | الملف              | التفاصيل                                                              |
| ----- | ----------------------- | ------------------ | --------------------------------------------------------------------- |
| 6.2.1 | التحقق من Driver entity | `driver.entity.ts` | التأكد من وجود `userId` أو آلية ربط بالـ User إن لزم                  |
| 6.2.2 | فهرس لطلبات السائق      | `amani` collection | `AmaniSchema.index({ driver: 1, status: 1 })` — قد يكون موجوداً فعلاً |

---

## ملخص أولويات التنفيذ

| الأولوية | المرحلة | المهام الحرجة                                                      |
| -------- | ------- | ------------------------------------------------------------------ |
| **P0**   | 1.3     | تنفيذ `getMyDriverOrders` — بدونها rider-app لا يعرض طلبات السائقة |
| **P0**   | 3.1     | إصلاح `handleAcceptOrder` — استدعاء `acceptAmaniOrder` الصحيح      |
| **P1**   | 1.4     | إضافة `POST /amani/:id/accept` لقبول يدوي من السائقة               |
| **P1**   | 1.2     | فلتر womenOnly في assignDriverAuto                                 |
| **P1**   | 2.1     | خيار سائقة أنثى في app-user                                        |
| **P2**   | 4.1     | تعيين سائق يدوي من لوحة التحكم                                     |
| **P2**   | 1.1     | حقول womenOnly في Entity/DTO                                       |
| **P3**   | 5.x     | تحسينات Socket والتحديث الفوري                                     |
| **P3**   | 3.4     | تحسين تفاصيل الطلب للسائقة                                         |

---

## الملفات المتأثرة (مرجع سريع)

| المكون          | الملفات الرئيسية                                                                    |
| --------------- | ----------------------------------------------------------------------------------- |
| Backend         | `amani.service.ts`, `amani.controller.ts`, `create-amani.dto.ts`, `amani.entity.ts` |
| app-user        | `AmaniCreateScreen.tsx`, `AmaniEditScreen.tsx`, `AmaniDetailsScreen.tsx`            |
| rider-app       | `AmaniListScreen.tsx`, `AmaniDetailsScreen.tsx`, `api/amani.ts`, `women.tsx`        |
| admin-dashboard | `AmaniDetailsPage.tsx`, `AmaniListPage.tsx`, `api/amani.ts`                         |

---

## ملاحظات تقنية

1. **إصدار API**: rider-app يستخدم `baseURL: api.bthwani.com/api/v1`. التحقق من أن مسارات أماني ضمن `v1` أو توحيد النسخة.
2. **ترتيب المسارات**: في NestJS تأكد أن `Get('driver/my-orders')` يسبق `Get(':id')` لتجنب تفسير `driver` كـ id.
3. **صلاحيات**: التحقق من أن المستخدم العادي لا يستطيع استدعاء `driver/my-orders` أو `accept` — فقط السائقون المسجلون.

---

تم إعداد هذه الخطة بناءً على فحص الكود الحالي. يُنصح بمراجعتها مع الفريق قبل البدء في التنفيذ.
