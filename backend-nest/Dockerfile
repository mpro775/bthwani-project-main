# ===================================
# Build Stage
# ===================================
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./

# ØªØ«Ø¨ÙŠØª ÙƒÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ dev) Ù„Ù„Ø¨Ù†Ø§Ø¡ â€” legacy-peer-deps Ù„ØªØ¬Ø§ÙˆØ² ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
RUN npm install --legacy-peer-deps && npm cache clean --force

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
COPY tsconfig*.json ./
COPY nest-cli.json ./

# Ù†Ø³Ø® Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
COPY . .

# Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
RUN echo "ðŸ”¨ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡..." && \
    npm run build && \
    echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¬Ø­!" || \
    (echo "âŒ Build failed!" && exit 1)

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù dist/main.js
RUN echo "ðŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡..." && \
    ls -la /app/dist/ && \
    test -f /app/dist/main.js || \
    (echo "âŒ dist/main.js not found!" && ls -la /app/dist/ && exit 1)

# ===================================
# Production Stage
# ===================================
FROM node:20-alpine AS production

ENV NODE_ENV=production
WORKDIR /app

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
  adduser -S nestjs -u 1001

COPY package*.json ./

# Ù‡Ù†Ø§ ÙÙ‚Ø· Ù†Ø«Ø¨Øª Ø­Ø²Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (npm install + legacy-peer-deps Ù„ØªØ¬Ø§ÙˆØ² ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª)
RUN npm install --production --legacy-peer-deps && npm cache clean --force

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
COPY --from=builder --chown=nestjs:nodejs /app/dist ./dist

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø®
RUN test -f /app/dist/main.js || (echo "âŒ dist/main.js not found after copy!" && exit 1)
RUN ls -la /app/dist/ || (echo "âŒ dist directory is empty!" && exit 1)

USER nestjs

EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health/liveness', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["node", "dist/main"]