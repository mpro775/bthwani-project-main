# خطة إكمال خدمة معروف – المفقودات والموجودات

هذه الخطة لإكمال **خدمة معروف** (المفقودات والموجودات) وفق مواصفات V6 – Lost & Found (FindMe) في وثائق التسليم، وربطها بشكل صحيح بين:

- **تطبيق المستخدم** (app-user)
- **الموقع** (bthwani-web)
- **لوحة التحكم** (admin-dashboard)
- **الخادم** (backend-nest)
- **تطبيق السائقين** (rider-app) — عند إضافة التوصيل

---

## الوضع الحالي vs الهدف (ملخص)

| الجانب                | الوضع الحالي       | الهدف                                 |
| --------------------- | ------------------ | ------------------------------------- |
| **صور الإعلانات**     | غير موجودة         | إضافة media_id[] ومرفقات صور          |
| **المكافأة**          | غير موجودة         | حقل reward اختياري + Escrow           |
| **الموقع الجغرافي**   | نص في metadata فقط | إحداثيات lat/lng                      |
| **التصنيف**           | tags فقط           | category (Pets, Phones, IDs...)       |
| **خيار التوصيل**      | غير موجود          | toggle + ربط بتطبيق السائقين          |
| **المطابقة**          | يدوية (محادثة فقط) | نظام مطابقة (phase 3)                 |
| **النشر anonymously** | غير موجود          | خيار إخفاء رقم الهاتف                 |
| **تأكيد الاستلام**    | غير موجود          | OTP / Proof of Return لإطلاق المكافأة |

---

## المرحلة 1: Backend – حقول أساسية وميزات أساسية

### 1.1 إضافة حقول جديدة في Entity

| #     | المهمة                 | الملف               | التفاصيل                                                                                                                                               |
| ----- | ---------------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1.1.1 | إضافة `mediaIds`       | `maarouf.entity.ts` | `@Prop({ type: [Types.ObjectId], ref: 'Media', default: [] }) mediaIds?: Types.ObjectId[]`                                                             |
| 1.1.2 | إضافة `category`       | `maarouf.entity.ts` | `@Prop({ enum: ['phone','pet','id','wallet','keys','bag','other'], default: 'other' }) category?: string`                                              |
| 1.1.3 | إضافة `reward`         | `maarouf.entity.ts` | `@Prop({ type: Number, default: 0 }) reward?: number` (بالريال أو العملة الأساسية)                                                                     |
| 1.1.4 | إضافة `location` (geo) | `maarouf.entity.ts` | `@Prop({ type: { type: String, enum: ['Point'], coordinates: [Number] }, default: null }) location?: { type: 'Point'; coordinates: [number, number] }` |
| 1.1.5 | إضافة `deliveryToggle` | `maarouf.entity.ts` | `@Prop({ default: false }) deliveryToggle?: boolean`                                                                                                   |
| 1.1.6 | إضافة `matchedToId`    | `maarouf.entity.ts` | `@Prop({ type: Types.ObjectId, ref: 'Maarouf' }) matchedToId?: Types.ObjectId`                                                                         |
| 1.1.7 | إضافة `isAnonymous`    | `maarouf.entity.ts` | `@Prop({ default: false }) isAnonymous?: boolean`                                                                                                      |
| 1.1.8 | إضافة `expiresAt`      | `maarouf.entity.ts` | `@Prop({ type: Date }) expiresAt?: Date` للانتهاء التلقائي                                                                                             |

### 1.2 تحديث DTOs

| #     | المهمة                 | الملف                       | التفاصيل                                                                            |
| ----- | ---------------------- | --------------------------- | ----------------------------------------------------------------------------------- |
| 1.2.1 | تحديث CreateMaaroufDto | `dto/create-maarouf.dto.ts` | إضافة: mediaIds, category, reward, location, deliveryToggle, isAnonymous, expiresAt |
| 1.2.2 | تحديث UpdateMaaroufDto | `dto/update-maarouf.dto.ts` | نفس الحقول كاختيارية                                                                |
| 1.2.3 | التحقق من الصلاحية     | `create-maarouf.dto.ts`     | `@IsOptional() @IsNumber() @Min(0) reward?`                                         |

### 1.3 إنشاء جدول/Entity reward_holds

| #     | المهمة                  | الملف                            | التفاصيل                                                                                      |
| ----- | ----------------------- | -------------------------------- | --------------------------------------------------------------------------------------------- |
| 1.3.1 | إنشاء RewardHold entity | `entities/reward-hold.entity.ts` | حقول: founderId, claimerId, maaroufId, amount, status (pending/released/refunded), walletTxId |
| 1.3.2 | تسجيل في Module         | `maarouf.module.ts`              | إضافة RewardHold في MongooseModule                                                            |
| 1.3.3 | خدمة RewardHold         | `reward-hold.service.ts`         | create, release, refund — تتكامل مع wallet عند توفرها                                         |

### 1.4 رفع الملفات (Media)

| #     | المهمة                 | الملف                      | التفاصيل                                                            |
| ----- | ---------------------- | -------------------------- | ------------------------------------------------------------------- |
| 1.4.1 | التحقق من media upload | `media` أو `upload` module | إذا وُجد: ربط mediaIds. إذا لم يوجد: إنشاء endpoint `/media/upload` |
| 1.4.2 | ربط media بالـ Maarouf | `maarouf.service.ts`       | عند create/update: التحقق من صحة mediaIds                           |

### 1.5 تحديث API Controller

| #     | المهمة            | الملف                | التفاصيل                                                   |
| ----- | ----------------- | -------------------- | ---------------------------------------------------------- |
| 1.5.1 | populate mediaIds | `maarouf.service.ts` | في findOne و list: `.populate('mediaIds', 'url thumbUrl')` |
| 1.5.2 | populate location | نفس الملف            | إرجاع location مع الإحداثيات عند الطلب                     |
| 1.5.3 | فلتر category     | `maarouf.service.ts` | في list: دعم `?category=phone`                             |
| 1.5.4 | فلتر reward       | نفس الملف            | دعم `?hasReward=true`                                      |

---

## المرحلة 2: تطبيق المستخدم (app-user)

### 2.1 نموذج إنشاء/تعديل الإعلان

| #     | المهمة                       | الملف                     | التفاصيل                                                    |
| ----- | ---------------------------- | ------------------------- | ----------------------------------------------------------- |
| 2.1.1 | إضافة رفع الصور              | `MaaroufCreateScreen.tsx` | معرض صور أو component لالتقاط/رفع صور (حتى 5 صور)           |
| 2.1.2 | إضافة خيار المكافأة          | نفس الملف                 | حقل رقمي اختياري للمكافأة + نص "مكافأة اختيارية"            |
| 2.1.3 | إضافة التصنيف (category)     | نفس الملف                 | قائمة منسدلة: هاتف، حيوان، هوية، محفظة، مفاتيح، حقيبة، أخرى |
| 2.1.4 | إضافة الموقع الجغرافي        | نفس الملف                 | زر "تحديد الموقع" يفتح خريطة أو يستخدم GPS لحفظ lat/lng     |
| 2.1.5 | إضافة خيار التوصيل           | نفس الملف                 | Toggle "أريد توصيل العنصر"                                  |
| 2.1.6 | إضافة خيار النشر anonymously | نفس الملف                 | Toggle "نشر بدون رقم هاتف"                                  |
| 2.1.7 | نفس التعديلات في التعديل     | `MaaroufEditScreen.tsx`   | عرض وتحديث كل الحقول الجديدة                                |

### 2.2 شاشة تفاصيل الإعلان

| #     | المهمة                        | الملف                      | التفاصيل                                                   |
| ----- | ----------------------------- | -------------------------- | ---------------------------------------------------------- |
| 2.2.1 | عرض الصور                     | `MaaroufDetailsScreen.tsx` | معرض صور أو Carousel للصور المرفقة                         |
| 2.2.2 | عرض المكافأة                  | نفس الملف                  | badge "مكافأة: X ريال" إن وُجدت                            |
| 2.2.3 | عرض التصنيف                   | نفس الملف                  | Chip أو نص واضح للتصنيف                                    |
| 2.2.4 | عرض الموقع على خريطة          | نفس الملف                  | إن وُجدت إحداثيات: عرض نقطة على خريطة صغيرة                |
| 2.2.5 | إخفاء رقم الهاتف في anonymous | نفس الملف                  | إن isAnonymous: عدم عرض رقم صاحب الإعلان في الواجهة العامة |

### 2.3 قائمة الإعلانات

| #     | المهمة                  | الملف                                   | التفاصيل                      |
| ----- | ----------------------- | --------------------------------------- | ----------------------------- |
| 2.3.1 | عرض صورة مصغرة          | `MaaroufListScreen.tsx` / `MaaroufCard` | أول صورة من mediaIds إن وُجدت |
| 2.3.2 | فلتر حسب التصنيف        | نفس الملف                               | فلتر by category              |
| 2.3.3 | فلتر "عرض المكافآت فقط" | نفس الملف                               | Checkbox أو toggle            |

### 2.4 تحديث Types و API

| #     | المهمة                     | الملف                         | التفاصيل                                                                                         |
| ----- | -------------------------- | ----------------------------- | ------------------------------------------------------------------------------------------------ |
| 2.4.1 | تحديث MaaroufItem          | `types/types.ts`              | إضافة: mediaIds, category, reward, location, deliveryToggle, matchedToId, isAnonymous, expiresAt |
| 2.4.2 | تحديث CreateMaaroufPayload | نفس الملف                     | إضافة الحقول الجديدة                                                                             |
| 2.4.3 | استدعاء رفع الصور          | `maaroufApi.ts` أو `mediaApi` | رفع الصور قبل create/update ثم تمرير mediaIds                                                    |

---

## المرحلة 3: الموقع (bthwani-web)

### 3.1 نموذج النشر

| #     | المهمة                     | الملف             | التفاصيل                                             |
| ----- | -------------------------- | ----------------- | ---------------------------------------------------- |
| 3.1.1 | رفع الصور                  | `MaaroufForm.tsx` | Drag & drop أو اختيار ملفات للصور                    |
| 3.1.2 | حقل المكافأة               | نفس الملف         | Input رقمي اختياري                                   |
| 3.1.3 | قائمة التصنيف              | نفس الملف         | Select أو Radio group للـ category                   |
| 3.1.4 | خريطة الموقع               | نفس الملف         | زر لاختيار الموقع على خريطة (Google Maps أو Leaflet) |
| 3.1.5 | Toggle التوصيل و anonymous | نفس الملف         | Checkbox أو Switch                                   |

### 3.2 عرض التفاصيل والقائمة

| #     | المهمة                | الملف                | التفاصيل             |
| ----- | --------------------- | -------------------- | -------------------- |
| 3.2.1 | معرض الصور            | `MaaroufDetails.tsx` | عرض mediaIds كمعرض   |
| 3.2.2 | عرض المكافأة والتصنيف | نفس الملف            | Badge و Chip         |
| 3.2.3 | خريطة الموقع          | نفس الملف            | عرض نقطة على الخريطة |
| 3.2.4 | فلاتر القائمة         | `MaaroufList.tsx`    | category, hasReward  |

### 3.3 تحديث Types و API

| #     | المهمة      | الملف                       | التفاصيل                           |
| ----- | ----------- | --------------------------- | ---------------------------------- |
| 3.3.1 | تحديث types | `features/maarouf/types.ts` | إضافة الحقول الجديدة               |
| 3.3.2 | ربط API     | `features/maarouf/api.ts`   | دعم mediaIds و location في الطلبات |

---

## المرحلة 4: لوحة التحكم (admin-dashboard)

### 4.1 صفحة القائمة

| #     | المهمة             | الملف                 | التفاصيل                 |
| ----- | ------------------ | --------------------- | ------------------------ |
| 4.1.1 | عمود الصورة        | `MaaroufListPage.tsx` | عمود يعرض أول صورة مصغرة |
| 4.1.2 | عمود التصنيف       | نفس الملف             | عرض category             |
| 4.1.3 | عمود المكافأة      | نفس الملف             | عرض reward إن وُجد       |
| 4.1.4 | فلتر حسب category  | نفس الملف             | dropdown للتصنيف         |
| 4.1.5 | فلتر حسب hasReward | نفس الملف             | checkbox                 |

### 4.2 صفحة التفاصيل

| #     | المهمة                | الملف                    | التفاصيل                           |
| ----- | --------------------- | ------------------------ | ---------------------------------- |
| 4.2.1 | عرض معرض الصور        | `MaaroufDetailsPage.tsx` | جميع الصور المرفقة                 |
| 4.2.2 | عرض المكافأة والتصنيف | نفس الملف                |                                    |
| 4.2.3 | عرض الموقع            | نفس الملف                | إن وُجد: عرض على خريطة أو إحداثيات |
| 4.2.4 | حالة anonymous        | نفس الملف                | إظهار أن الإعلان anonymous         |

### 4.3 إدارة reward_holds (when applicable)

| #     | المهمة               | الملف                    | التفاصيل                       |
| ----- | -------------------- | ------------------------ | ------------------------------ |
| 4.3.1 | عرض المكافآت المعلقة | `MaaroufDetailsPage.tsx` | قائمة reward_holds المرتبطة    |
| 4.3.2 | زر إطلاق/استرداد     | نفس الملف                | إن وُجدت واجهة إدارية للمكافآت |

### 4.4 تحديث API و Types

| #     | المهمة                      | الملف              | التفاصيل             |
| ----- | --------------------------- | ------------------ | -------------------- |
| 4.4.1 | تحديث MaaroufItem           | `types/maarouf.ts` | إضافة الحقول الجديدة |
| 4.4.2 | تحديث getMaaroufList params | `api/maarouf.ts`   | category, hasReward  |

---

## المرحلة 5: التوصيل و rider-app (اختياري – مرحلة متقدمة)

### 5.1 Backend – ربط التوصيل

| #     | المهمة              | الملف                   | التفاصيل                                                                       |
| ----- | ------------------- | ----------------------- | ------------------------------------------------------------------------------ |
| 5.1.1 | إنشاء delivery_id   | `maarouf.entity.ts`     | `@Prop({ type: Types.ObjectId, ref: 'Delivery' }) deliveryId?: Types.ObjectId` |
| 5.1.2 | إنشاء طلب توصيل     | `maarouf.service.ts`    | عند deliveryToggle: إنشاء طلب توصيل (إن وُجد delivery module)                  |
| 5.1.3 | endpoint تعيين موصل | `maarouf.controller.ts` | `POST /maarouf/:id/assign-delivery`                                            |

### 5.2 rider-app

| #     | المهمة              | الملف               | التفاصيل                                  |
| ----- | ------------------- | ------------------- | ----------------------------------------- |
| 5.2.1 | تبويب توصيلات معروف | شاشة جديدة أو تبويب | عرض طلبات توصيل المفقودات/الموجودات       |
| 5.2.2 | تفاصيل التوصيل      | شاشة التفاصيل       | عرض عنوان الاستلام والتسليم + OTP للمستلم |
| 5.2.3 | تأكيد الاستلام      | نفس الملف           | زر "تم التسليم" → إطلاق المكافأة إن وُجدت |

### 5.3 تأكيد الاستلام (Proof of Return)

| #     | المهمة            | الملف                    | التفاصيل                                         |
| ----- | ----------------- | ------------------------ | ------------------------------------------------ |
| 5.3.1 | OTP / PIN للمستلم | backend                  | توليد OTP يعطى للمستلم، الموصل يدخله عند التسليم |
| 5.3.2 | إطلاق المكافأة    | `reward-hold.service.ts` | عند تأكيد التسليم: release reward إلى المطابق    |

---

## المرحلة 6: المطابقة والتنبيهات (Phase 3 – Smart)

### 6.1 Match Service (مبسط)

| #     | المهمة            | الملف                   | التفاصيل                                                          |
| ----- | ----------------- | ----------------------- | ----------------------------------------------------------------- |
| 6.1.1 | endpoint المطابقة | `maarouf.controller.ts` | `POST /maarouf/match` — يبحث بالـ category + tags + location قريب |
| 6.1.2 | إشعار المطابقة    | notification            | عند وجود match محتمل: إشعار لصاحب الإعلان                         |
| 6.1.3 | ربط يدوي          | `maarouf.service.ts`    | `PATCH /maarouf/:id/link` — ربط matchedToId بين lost و found      |

### 6.2 Geo-Matching (مبسط)

| #     | المهمة                | الملف                | التفاصيل                                                        |
| ----- | --------------------- | -------------------- | --------------------------------------------------------------- |
| 6.2.1 | تنبيهات جغرافية       | notification module  | عند نشر found: إشعار للمستخدمين الذين نشروا lost قريب من الموقع |
| 6.2.2 | فلتر location في list | `maarouf.service.ts` | `?near=lat,lng&radius=km`                                       |

### 6.3 Auto-expiry

| #     | المهمة       | الملف                             | التفاصيل                                                               |
| ----- | ------------ | --------------------------------- | ---------------------------------------------------------------------- |
| 6.3.1 | Cron job     | `maarouf.service.ts` أو scheduler | يومياً: تحديث status إعلانات `expiresAt < now` إلى expired أو archived |
| 6.3.2 | حالة expired | `maarouf.entity.ts`               | إضافة `expired` في status أو استخدام expiresAt للفلترة                 |

---

## المرحلة 7: المحادثة Anonymous

### 7.1 Backend

| #     | المهمة              | الملف          | التفاصيل                                             |
| ----- | ------------------- | -------------- | ---------------------------------------------------- |
| 7.1.1 | إخفاء بيانات الهاتف | `maarouf-chat` | عند isAnonymous: عدم إرجاع phone في populate ownerId |
| 7.1.2 | Nickname بدل الاسم  | نفس الملف      | إرجاع nickname أو "مستخدم" للمعلنين anonymous        |

### 7.2 تطبيقات الواجهة

| #     | المهمة             | الملف                  | التفاصيل                                                             |
| ----- | ------------------ | ---------------------- | -------------------------------------------------------------------- |
| 7.2.1 | إخفاء رقم الهاتف   | `MaaroufDetailsScreen` | إن isAnonymous: عدم عرض زر الاتصال أو إظهار "تواصل عبر المحادثة فقط" |
| 7.2.2 | نفس الشيء في الويب | `MaaroufDetails.tsx`   |                                                                      |

---

## ملخص أولويات التنفيذ

| الأولوية | المرحلة | المهام                                                           |
| -------- | ------- | ---------------------------------------------------------------- |
| **P0**   | 1.1–1.2 | إضافة حقول mediaIds, category, reward, location في Entity و DTOs |
| **P0**   | 1.4     | ربط رفع الصور أو التأكد من وجود media upload                     |
| **P1**   | 2.1     | نموذج إنشاء/تعديل في app-user مع الصور والمكافأة والتصنيف        |
| **P1**   | 2.2     | عرض الصور والمكافأة في التفاصيل                                  |
| **P1**   | 3.1–3.2 | نفس التعديلات في bthwani-web                                     |
| **P1**   | 4.1–4.2 | تحديث لوحة التحكم                                                |
| **P2**   | 1.3     | reward_holds و Escrow (يتطلب wallet)                             |
| **P2**   | 5.x     | التوصيل و rider-app (يتطلب delivery module)                      |
| **P3**   | 6.x     | المطابقة والتنبيهات الجغرافية                                    |
| **P3**   | 7.x     | المحادثة Anonymous                                               |

---

## الملفات المتأثرة (مرجع سريع)

| المكون          | الملفات الرئيسية                                                                                                                           |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| Backend         | `maarouf.entity.ts`, `create-maarouf.dto.ts`, `update-maarouf.dto.ts`, `maarouf.service.ts`, `maarouf.controller.ts`                       |
| app-user        | `MaaroufCreateScreen.tsx`, `MaaroufEditScreen.tsx`, `MaaroufDetailsScreen.tsx`, `MaaroufListScreen.tsx`, `types/types.ts`, `maaroufApi.ts` |
| bthwani-web     | `MaaroufForm.tsx`, `MaaroufDetails.tsx`, `MaaroufList.tsx`, `features/maarouf/types.ts`, `features/maarouf/api.ts`                         |
| admin-dashboard | `MaaroufListPage.tsx`, `MaaroufDetailsPage.tsx`, `api/maarouf.ts`, `types/maarouf.ts`                                                      |
| rider-app       | شاشات جديدة أو تبويبات (عند إضافة التوصيل)                                                                                                 |

---

## ملاحظات تقنية

1. **Media Upload**: التحقق من وجود `media` أو `upload` module. إن لم يوجد، يمكن استخدام Cloudinary أو S3 مباشرة مع endpoint بسيط.
2. **Location**: يمكن استخدام `GeoJSON` في MongoDB مع فهرس 2dsphere للبحث الجغرافي.
3. **Wallet**: خدمة reward_holds تحتاج تكامل مع wallet/escrow. إن لم يكن متوفراً، يمكن تأجيل Escrow والاكتفاء بعرض المكافأة كنص فقط.
4. **Delivery**: التوصيل يتطلب وجود delivery module أو تكامل مع خدمة توصيل خارجية. يمكن تأجيله للمرحلة المتقدمة.

---

تم إعداد هذه الخطة بناءً على مقارنة خدمة معروف الحالية بمواصفات V6 – Lost & Found في وثائق التسليم.
