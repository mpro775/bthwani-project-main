# مقارنة متطلبات السوق المفتوح (V2 Marketplace) مع تنفيذ خدمة كنز

> **المرجع:** Full Handover Documents for bThwani Super App & Web Development  
> **التاريخ:** فبراير 2025  
> **الغرض:** شرح ما تم تنفيذه في خدمة كنز بشكل صحيح بناءً على متطلبات السوق المفتوح (V2 – Marketplace / Haraj)

---

## الفهرس

1. [نظرة عامة](#1-نظرة-عامة)
2. [المقارنة حسب الباك اند](#2-المقارنة-حسب-الباك-اند)
3. [المقارنة حسب لوحة التحكم](#3-المقارنة-حسب-لوحة-التحكم)
4. [المقارنة حسب التطبيق (app-user)](#4-المقارنة-حسب-التطبيق-app-user)
5. [المقارنة حسب الويب (bthwani-web)](#5-المقارنة-حسب-الويب-bthwani-web)
6. [ملخص تنفيذ الميزات](#6-ملخص-تنفيذ-الميزات)

---

## 1. نظرة عامة

### 1.1 متطلبات السوق المفتوح (V2 – Marketplace / Haraj)

وفق مستند التسليم، الخدمة تتضمن:

| المتطلبات             | الوصف                                  |
| --------------------- | -------------------------------------- |
| **Ad Posting**        | نشر إعلان: صورة، عنوان، فئة، سعر، موقع |
| **Auctions**          | نظام مزايدات اختياري مع وقت انتهاء     |
| **Mark as Sold**      | تعليم الإعلان كمباع → أرشفة 90 يوم     |
| **Contact Options**   | محادثة، اتصال، واتساب (قابل للتفعيل)   |
| **Delivery + Escrow** | خيار توصيل أو لقاء + دفع آمن بالإيكرو  |

### 1.2 الخدمات الأساسية المطلوبة (معمارية الباك اند)

| الخدمة            | الوصف                                     |
| ----------------- | ----------------------------------------- |
| listing-service   | إنشاء إعلان، انتهاء الصلاحية، تتبع الحالة |
| category-service  | شجرة فئات (رئيسي → فرعي → فرعي فرعي)      |
| boost-service     | ترويج الإعلانات (highlight, pin, top)     |
| escrow-service    | دفع آمن عبر المحفظة                       |
| reporting-service | الإبلاغ عن الإعلانات، منع الإساءة         |
| archival-service  | أرشفة الإعلانات المباعة بعد 90 يوم        |

---

## 2. المقارنة حسب الباك اند

### 2.1 جدول المقارنة التفصيلي

| الميزة              | المتطلب (السوق المفتوح)          | الموضع في الباك اند                                                     | الحالة  |
| ------------------- | -------------------------------- | ----------------------------------------------------------------------- | ------- |
| **نشر إعلان**       | POST إعلان بصور وعنوان وفئة وسعر | `POST /kenz` — `CreateKenzDto`                                          | ✅ منفذ |
| **قائمة الإعلانات** | GET إعلانات مع فلاتر             | `GET /kenz` — cursor، فلاتر، ترتيب                                      | ✅ منفذ |
| **تعليم كمباع**     | PUT mark as sold                 | `PATCH /kenz/:id/sold`                                                  | ✅ منفذ |
| **الإبلاغ**         | POST report                      | `POST /kenz/:id/report` — جدول `kenz_reports`                           | ✅ منفذ |
| **شجرة الفئات**     | فئات متداخلة 3 مستويات           | `GET /kenz/categories` — `KenzCategory`                                 | ✅ منفذ |
| **أرشفة 90 يوم**    | نقل المباع إلى أرشيف بعد 90 يوم  | Cron يومي + `archivedAt`                                                | ✅ منفذ |
| **المفضلة**         | حفظ إعلانات                      | `POST/DELETE /kenz/:id/favorite`، `GET /kenz/favorites`                 | ✅ منفذ |
| **ترويج (Boost)**   | highlight، pin، top              | `kenz_boosts` + دمج في القائمة                                          | ✅ منفذ |
| **بحث نصي**         | بحث في العنوان والوصف            | `GET /kenz?search=` (title, description, keywords)                      | ✅ منفذ |
| **ترتيب**           | newest، price، views             | `sort=newest\|price_asc\|price_desc\|views_desc`                        | ✅ منفذ |
| **حالة السلعة**     | جديد، مستعمل، مجدد               | `condition: new \| used \| refurbished`                                 | ✅ منفذ |
| **نشر بالنيابة**    | Post on behalf of others         | `postedOnBehalfOfPhone`, `postedOnBehalfOfUserId`                       | ✅ منفذ |
| **توصيل / لقاء**    | Delivery أو Meet-up              | `deliveryOption`, `deliveryFee`                                         | ✅ منفذ |
| **الإيكرو**         | حجز مبلغ حتى تأكيد الاستلام      | `buyWithEscrow`, `KenzDeal`, تكامل المحفظة                              | ✅ منفذ |
| **المزادات**        | مزايدات + وقت انتهاء             | `isAuction`, `auctionEndAt`, `POST /kenz/:id/bid`, `GET /kenz/:id/bids` | ✅ منفذ |

### 2.2 نقاط الـ API المنفذة

| Endpoint                               | الطريقة | الوصف                                     |
| -------------------------------------- | ------- | ----------------------------------------- |
| `/kenz`                                | POST    | إنشاء إعلان                               |
| `/kenz`                                | GET     | قائمة إعلانات (فلاتر، بحث، ترتيب، cursor) |
| `/kenz/categories`                     | GET     | شجرة الفئات                               |
| `/kenz/favorites`                      | GET     | إعلاناتي المفضلة                          |
| `/kenz/:id/favorite`                   | POST    | إضافة للمفضلة                             |
| `/kenz/:id/favorite`                   | DELETE  | إزالة من المفضلة                          |
| `/kenz/deals`                          | GET     | صفقاتي (كمشتري/بائع)                      |
| `/kenz/deals/:dealId`                  | GET     | تفاصيل صفقة                               |
| `/kenz/:id/buy-with-escrow`            | POST    | شراء بالإيكرو                             |
| `/kenz/deals/:dealId/confirm-received` | POST    | تأكيد الاستلام                            |
| `/kenz/deals/:dealId/cancel`           | POST    | إلغاء صفقة                                |
| `/kenz/:id/bid`                        | POST    | مزايدة                                    |
| `/kenz/:id/bids`                       | GET     | مزايدات الإعلان                           |
| `/kenz/:id`                            | GET     | تفاصيل إعلان (مع زيادة viewCount)         |
| `/kenz/:id/sold`                       | PATCH   | تعليم كمباع                               |
| `/kenz/:id/report`                     | POST    | الإبلاغ عن إعلان                          |
| `/kenz/:id`                            | PATCH   | تحديث إعلان                               |
| `/kenz/:id`                            | DELETE  | حذف إعلان                                 |

### 2.3 Entities المنفذة

| Entity         | الوصف                                                                           |
| -------------- | ------------------------------------------------------------------------------- |
| `Kenz`         | إعلان: عنوان، وصف، سعر، فئة، صور، مدينة، حالة، إيكرو، توصيل، مزاد، نشر بالنيابة |
| `KenzCategory` | فئة مع `parentId` لشجرة الفئات                                                  |
| `KenzReport`   | بلاغات الإعلانات                                                                |
| `KenzFavorite` | المفضلة                                                                         |
| `KenzBoost`    | ترويج الإعلانات                                                                 |
| `KenzDeal`     | صفقات الإيكرو                                                                   |
| `KenzBid`      | مزايدات المزادات                                                                |

---

## 3. المقارنة حسب لوحة التحكم (admin-dashboard)

| الميزة                  | المتطلب                             | التنفيذ                                                                | الحالة  |
| ----------------------- | ----------------------------------- | ---------------------------------------------------------------------- | ------- |
| **قائمة إعلانات كنز**   | عرض إعلانات مع فلاتر                | `KenzListPage.tsx` — بحث، ترتيب، فئات، حالة، مدينة، توصيل، إيكرو، مزاد | ✅ منفذ |
| **تفاصيل إعلان**        | عرض كامل بيانات الإعلان             | `KenzDetailsPage.tsx` — نشر بالنيابة، توصيل، إيكرو، مزاد               | ✅ منفذ |
| **تحديث حالة إعلان**    | مسودة، معلق، مؤكد، مكتمل، ملغي      | زر تحديث الحالة من القائمة أو التفاصيل                                 | ✅ منفذ |
| **بلاغات الإعلانات**    | قائمة بلاغات، مراجعة، إجراء         | `KenzReportsPage.tsx`                                                  | ✅ منفذ |
| **فئات كنز**            | إدارة شجرة فئات (إضافة، تعديل، حذف) | `KenzCategoriesPage.tsx`                                               | ✅ منفذ |
| **ترويج الإعلانات**     | إنشاء/إلغاء Boost                   | `KenzBoostPage.tsx`                                                    | ✅ منفذ |
| **صفقات كنز (الإيكرو)** | قائمة صفقات بالإيكرو                | `KenzDealsPage.tsx`                                                    | ✅ منفذ |
| **إحصائيات**            | نظرة عامة على كنز                   | `GET /admin/kenz/stats/overview`                                       | ✅ منفذ |

### روابط القائمة الجانبية (كنز)

- إعلانات الكنز → `/admin/kenz`
- فئات كنز → `/admin/kenz/categories`
- بلاغات الإعلانات → `/admin/kenz/reports`
- ترويج الإعلانات → `/admin/kenz/boost`
- صفقات كنز → `/admin/kenz/deals`

---

## 4. المقارنة حسب التطبيق (app-user)

| الميزة            | المتطلب                             | التنفيذ                   | الحالة  |
| ----------------- | ----------------------------------- | ------------------------- | ------- |
| **قائمة إعلانات** | تصفح، فلاتر، ترتيب                  | `KenzListScreen.tsx`      | ✅ منفذ |
| **تفاصيل إعلان**  | عرض كامل، زر اتصال/محادثة           | `KenzDetailsScreen.tsx`   | ✅ منفذ |
| **إنشاء إعلان**   | صورة، عنوان، فئة، سعر، موقع، خيارات | `KenzCreateScreen.tsx`    | ✅ منفذ |
| **تعديل إعلان**   | تحديث بيانات الإعلان                | `KenzEditScreen.tsx`      | ✅ منفذ |
| **تعليم كمباع**   | زر للمالك                           | في صفحة التفاصيل          | ✅ منفذ |
| **الإبلاغ**       | نموذج سبب + ملاحظات                 | في صفحة التفاصيل          | ✅ منفذ |
| **المفضلة**       | زر قلب + صفحة إعلاناتي المفضلة      | `KenzFavoritesScreen.tsx` | ✅ منفذ |
| **المحادثات**     | محادثة مع البائع/المشتري            | `kenz-chat` (Socket.IO)   | ✅ منفذ |
| **شراء بالإيكرو** | زر شراء + صفحة صفقاتي               | `KenzDealsScreen.tsx`     | ✅ منفذ |
| **المزادات**      | مزايدة + عد تنازلي                  | API + واجهة               | ✅ منفذ |
| **نشر بالنيابة**  | خيار في النموذج                     | في نموذج الإنشاء/التعديل  | ✅ منفذ |
| **توصيل/لقاء**    | اختيار في النموذج                   | في نموذج الإنشاء/التعديل  | ✅ منفذ |
| **إعلانات مميزة** | شارة "مميز" في البطاقة              | `KenzCard` مع `isBoosted` | ✅ منفذ |

### شاشات كنز في التطبيق

- `KenzListScreen.tsx` — قائمة الإعلانات
- `KenzDetailsScreen.tsx` — تفاصيل إعلان
- `KenzCreateScreen.tsx` — إنشاء إعلان
- `KenzEditScreen.tsx` — تعديل إعلان
- `KenzFavoritesScreen.tsx` — إعلاناتي المفضلة
- `KenzDealsScreen.tsx` — صفقاتي (الإيكرو)

---

## 5. المقارنة حسب الويب (bthwani-web)

| الميزة                | المتطلب                                | التنفيذ                                               | الحالة  |
| --------------------- | -------------------------------------- | ----------------------------------------------------- | ------- |
| **قائمة إعلانات**     | تصفح، فلاتر، ترتيب                     | `KenzList.tsx`, `KenzFilters.tsx`                     | ✅ منفذ |
| **تفاصيل إعلان**      | عرض كامل، أزرار اتصال                  | `KenzDetails.tsx`                                     | ✅ منفذ |
| **إنشاء/تعديل إعلان** | نموذج كامل                             | `KenzForm.tsx`                                        | ✅ منفذ |
| **تعليم كمباع**       | زر للمالك                              | في `KenzDetails`                                      | ✅ منفذ |
| **الإبلاغ**           | نموذج                                  | في `KenzDetails`                                      | ✅ منفذ |
| **المفضلة**           | زر قلب + صفحة مفضلة                    | `KenzFavoritesView.tsx`                               | ✅ منفذ |
| **محادثات كنز**       | مسارات `/kenz/chat` و `/kenz/chat/:id` | `KenzChatList.tsx`, `KenzChatPage.tsx`, `api-chat.ts` | ✅ منفذ |
| **صفقاتي**            | صفحة صفقات الإيكرو                     | `KenzDealsView.tsx`                                   | ✅ منفذ |
| **إعلانات مميزة**     | شارة "مميز"                            | `KenzCard` مع `isBoosted`                             | ✅ منفذ |

### المكونات في bthwani-web

- `KenzList.tsx` — قائمة الإعلانات
- `KenzCard.tsx` — بطاقة إعلان
- `KenzDetails.tsx` — تفاصيل إعلان
- `KenzForm.tsx` — نموذج إنشاء/تعديل
- `KenzFilters.tsx` — فلاتر البحث
- `KenzFavoritesView.tsx` — إعلاناتي المفضلة
- `KenzDealsView.tsx` — صفقاتي
- `api-chat.ts` — محادثات كنز

---

## 6. ملخص تنفيذ الميزات

### 6.1 ملخص حسب النوع

| النوع                | الميزات المطلوبة                                          | المنفذة | النسبة |
| -------------------- | --------------------------------------------------------- | ------- | ------ |
| **أساسي (Core)**     | نشر إعلان، قائمة، تفاصيل، فئات، محادثة، مفضلة، مشاهدات    | ✅ الكل | 100%   |
| **متقدم (Advanced)** | مزايدات، نشر بالنيابة، تم البيع، إيكرو، توصيل/لقاء، ترويج | ✅ الكل | 100%   |
| **ذكي (Smart)**      | بحث، ترتيب، تنبيهات انخفاض السعر، "مزيد من هذا"           | جزئي    | ~70%   |

### 6.2 الميزات المكتملة بالكامل

1. **نشر إعلان** — صور، عنوان، وصف، فئة، سعر، مدينة، كلمات مفتاحية، حالة السلعة
2. **قائمة إعلانات** — بحث، ترتيب، فلاتر (فئة، مدينة، حالة، توصيل، إيكرو، مزاد)
3. **تعليم كمباع** — مع أرشفة تلقائية بعد 90 يوم
4. **الإبلاغ** — جدول بلاغات + مراجعة من الأدمن
5. **فئات متداخلة** — شجرة فئات مع إدارة كاملة
6. **المفضلة** — إضافة/إزالة + صفحة إعلاناتي المفضلة
7. **ترويج (Boost)** — إنشاء/إلغاء من الأدمن + عرض "مميز"
8. **حالة السلعة** — جديد، مستعمل، مجدد
9. **نشر بالنيابة** — حقول + عرض في القائمة/التفاصيل
10. **توصيل/لقاء** — خيارات + فلتر
11. **الإيكرو** — صفقات، حجز، تأكيد استلام، إلغاء
12. **المزادات** — إنشاء مزاد، مزايدة، جلب المزايدات
13. **محادثات كنز** — إنشاء محادثة، قائمة محادثاتي، واجهة دردشة

### 6.3 خريطة التطابق مع المتطلبات

```
متطلبات السوق المفتوح (V2)          ←→          خدمة كنز المنفذة
─────────────────────────────────────────────────────────────────
listing-service                    ←→          KenzService + Kenz entity
category-service                   ←→          KenzCategoryService
boost-service                      ←→          KenzBoost (جدول + دمج)
escrow-service                     ←→          KenzDealService + Wallet
reporting-service                  ←→          KenzReport (جدول + POST)
archival-service                   ←→          Cron + archivedAt
```

---

## الخلاصة

تم تنفيذ **خدمة كنز** بشكل مطابق تقريباً لمتطلبات **السوق المفتوح (V2 – Marketplace / Haraj)** في مستند التسليم، وتشمل:

- **الباك اند:** جميع الخدمات الأساسية (listing، category، boost، escrow، reporting، archival) مع وحدات منفصلة أو مدمجة.
- **لوحة التحكم:** إدارة الإعلانات، الفئات، البلاغات، الترويج، الصفقات.
- **التطبيق:** نشر، تصفح، تفاصيل، مفضلة، محادثات، إيكرو، مزادات.
- **الويب:** نفس الميزات مع واجهة ويب كاملة.

الميزات المؤجلة سابقاً (الإيكرو، توصيل/لقاء، نشر بالنيابة، والمزادات) تم تنفيذها وفق خطة المرحلة اللاحقة (`kenz-phase5-later-plan.md`).
