# مقارنة خدمة الحجوزات: المتطلبات (V5 – Offers & Bookings) مقابل تنفيذ خدمة عربون

**التاريخ:** فبراير 2025  
**المرجع:** Full Handover Documents for bThwani Super App & Web Development, final to Mohammed  
**الغرض:** توضيح ما تم تنفيذه في خدمة عربون (العروض والحجوزات بعربون) مقارنةً بمتطلبات V5 – Offers & Bookings في وثائق التسليم.

---

## 1. نظرة عامة

| البند              | الوصف                                                   |
| ------------------ | ------------------------------------------------------- |
| **المتطلبات (V5)** | V5 – Offers & Bookings: عيادات، صالونات، دورات، فعاليات |
| **التنفيذ الحالي** | خدمة عربون (Arabon) — العروض والحجوزات بعربون           |
| **النطاق**         | تطبيق المستخدم، الويب، لوحة التحكم، الباك إند           |

---

## 2. المتطلبات من وثائق التسليم (V5 – Offers & Bookings)

### 2.1 حالات الاستخدام

| المتطلب                | الوصف                                       |
| ---------------------- | ------------------------------------------- |
| **Use Cases**          | عيادات، صالونات، دورات، فعاليات             |
| **Booking Options**    | مجاني / مدفوع (الرسوم تُخصم من الإجمالي)    |
| **Slot Manager**       | الأدمن يحدد التوفر عبر واجهة التقويم        |
| **Wallet Integration** | الرسوم تُحجز في الإيكرو، تُسترد حسب السياسة |
| **No-show Logic**      | لا استرداد عند وضع "لا حضور"                |

### 2.2 الميزات الأساسية (Core)

| الميزة          | الوصف                        |
| --------------- | ---------------------------- |
| Booking Slots   | فترات يومية/ساعية            |
| Booking Types   | مجاني/مدفوع                  |
| Calendar View   | عرض التقويم                  |
| Profiles        | صفحات عيادات/فعاليات/صالونات |
| Booking History | سجل الحجوزات                 |

### 2.3 الميزات المتقدمة (Advanced)

| الميزة                          | الوصف                        |
| ------------------------------- | ---------------------------- |
| Booking Fee Deducted from Total | رسوم الحجز تُخصم من الإجمالي |
| No-Show Flagging                | وضع علامة عدم حضور           |
| Coupons for First Booking       | كوبونات لأول حجز             |
| Venue Videos                    | فيديوهات للمكان              |

### 2.4 واجهات API المرجعية

| Endpoint                    | Method | الوصف                      |
| --------------------------- | ------ | -------------------------- |
| /offers/post                | POST   | إنشاء عرض عيادة/صالون/دورة |
| /bookings/slots/:providerId | GET    | عرض الأوقات المتاحة        |
| /bookings/confirm           | POST   | تأكيد الحجز (مدفوع/مجاني)  |
| /bookings/status/:id        | GET    | عرض حالة الحجز             |

### 2.5 الخدمات المرجعية (Backend Services)

| الخدمة                | الوصف                                        |
| --------------------- | -------------------------------------------- |
| booking-offer-service | نشر عيادات، صالونات، فعاليات                 |
| slot-service          | منطق التوفر القائم على التقويم               |
| fee-escrow-service    | حجز وإرجاع رسوم الحجز تلقائياً               |
| venue-profile-service | صفحات مقدمي الخدمة، السير الذاتية، التقييمات |
| short-video-service   | وسائط اختبارية لكل عرض (اختياري)             |

### 2.6 مؤشرات الأداء (KPIs)

| مؤشر                    | الهدف                      |
| ----------------------- | -------------------------- |
| Booking Conversion Rate | ≥ 35% ممن ينقرون على العرض |
| Paid Bookings           | 5,000+/شهر                 |
| Calendar Compliance     | 95% دقة الفترات            |
| No-Show Rate            | < 8%                       |

---

## 3. ما تم تنفيذه في خدمة عربون

### 3.1 الباك إند (NestJS)

#### الأنطمة (Entities)

| الكيان              | الوصف                                                                                                                                             |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Arabon**          | العروض (title, description, depositAmount, images, videos, offerType: clinic/salon/event/venue/other, bookingPrice, bookingPeriod: hour/day/week) |
| **BookingSlot**     | فترات الحجز (datetime, durationMinutes, isBooked, bookedBy)                                                                                       |
| **Booking**         | الحجوزات (userId, arabonId, slotId, status, depositAmount, walletTxId)                                                                            |
| **ArabonRequest**   | طلبات الحجز (نموذج طلب → قبول/رفض من المالك)                                                                                                      |
| **ArabonStatusLog** | سجل تغييرات حالة العربون                                                                                                                          |

#### حالات العربون والحجز

| العربون                                         | الحجز                                                     |
| ----------------------------------------------- | --------------------------------------------------------- |
| draft, pending, confirmed, completed, cancelled | pending_payment, confirmed, completed, cancelled, no_show |

#### الخدمات (Services)

| الخدمة                 | الوظيفة                                                                      |
| ---------------------- | ---------------------------------------------------------------------------- |
| **ArabonService**      | CRUD للعروض، البحث، الإحصائيات، طلبات العربون (تقديم/قبول/رفض)               |
| **BookingSlotService** | إنشاء slots، الأوقات المتاحة، حجز/إطلاق slot                                 |
| **BookingService**     | تأكيد الحجز، حجز المبلغ من المحفظة، تحديث الحالة، الاسترداد، الكوبونات، KPIs |

#### التكامل مع المحفظة

| العملية     | السلوك                                    |
| ----------- | ----------------------------------------- |
| تأكيد الحجز | `holdFunds` — حجز مبلغ العربون في المحفظة |
| إلغاء       | استرداد كامل للمستخدم + تحرير الـ slot    |
| إكمال       | تحويل المبلغ للمالك                       |
| no_show     | لا استرداد، تحويل للمالك + تحرير الـ slot |

#### الكوبونات

- دعم كوبونات الخصم (بما فيها كوبونات أول حجز)
- `validateCouponForBooking` و `apply` عبر CouponService

#### API Endpoints (REST)

| المسار                                 | الطريقة | الوصف                    |
| -------------------------------------- | ------- | ------------------------ |
| /arabon                                | POST    | إنشاء عربون              |
| /arabon                                | GET     | قائمة العربونات          |
| /arabon/my                             | GET     | عربوناتي                 |
| /arabon/search                         | GET     | البحث                    |
| /arabon/stats                          | GET     | إحصائيات                 |
| /arabon/:id                            | GET     | تفاصيل عربون             |
| /arabon/:id                            | PATCH   | تحديث عربون              |
| /arabon/:id                            | DELETE  | حذف عربون                |
| /arabon/:id/status                     | PATCH   | تحديث الحالة             |
| /arabon/:id/activity                   | GET     | سجل النشاط               |
| /arabon/:id/slots                      | GET     | الأوقات المتاحة          |
| /arabon/:id/slots                      | POST    | إنشاء أوقات حجز (للمالك) |
| /arabon/:id/book                       | POST    | تأكيد حجز                |
| /arabon/:id/validate-coupon            | GET     | التحقق من الكوبون        |
| /arabon/:id/requests                   | GET     | طلبات العربون (للمالك)   |
| /arabon/:id/request                    | POST    | تقديم طلب                |
| /arabon/:id/requests/:requestId/accept | PATCH   | قبول طلب                 |
| /arabon/:id/requests/:requestId/reject | PATCH   | رفض طلب                  |
| /arabon/:id/bookings                   | GET     | حجوزات العربون (للمالك)  |
| /arabon/bookings/my                    | GET     | حجوزاتي                  |
| /arabon/bookings/:bookingId            | GET     | تفاصيل حجز               |
| /arabon/bookings/:bookingId/status     | PATCH   | تحديث حالة الحجز         |

### 3.2 لوحة التحكم (Admin Dashboard)

| الصفحة                | الوظيفة                                                                                 |
| --------------------- | --------------------------------------------------------------------------------------- |
| **ArabonListPage**    | قائمة العربونات، فلترة، بحث، تغيير الحالة، حذف                                          |
| **ArabonDetailsPage** | تفاصيل العربون، حجوزات العربون، KPIs، تحديث حالة الحجوزات (completed/cancelled/no_show) |

#### API لوحة التحكم

| المسار                                   | الوظيفة                |
| ---------------------------------------- | ---------------------- |
| /admin/arabon                            | قائمة                  |
| /admin/arabon/:id                        | تفاصيل                 |
| /admin/arabon/:id/status                 | تغيير الحالة           |
| /admin/arabon/:id                        | حذف                    |
| /admin/arabon/:id/bookings               | حجوزات العربون         |
| /admin/arabon/bookings/:bookingId/status | تحديث حالة الحجز       |
| /admin/arabon/bookings/kpis              | مؤشرات أداء الحجوزات   |
| /admin/arabon/:id/kpis                   | مؤشرات أداء عربون محدد |

### 3.3 تطبيق المستخدم (App-User)

| الشاشة                     | الوظيفة                            |
| -------------------------- | ---------------------------------- |
| **ArabonListScreen**       | استعراض العروض                     |
| **ArabonSearchScreen**     | البحث في العروض                    |
| **ArabonDetailsScreen**    | تفاصيل عرض، الأوقات المتاحة، الحجز |
| **ArabonBookScreen**       | تأكيد الحجز والدفع                 |
| **ArabonCreateScreen**     | إنشاء عرض (للمالك)                 |
| **ArabonEditScreen**       | تعديل عرض                          |
| **ArabonMyListScreen**     | عروضي                              |
| **ArabonMyBookingsScreen** | حجوزاتي                            |

### 3.4 الويب (bthwani-web)

| المكون                                                         | الوظيفة              |
| -------------------------------------------------------------- | -------------------- |
| **ArabonList**                                                 | عرض قائمة العروض     |
| **ArabonCard**                                                 | بطاقة عرض            |
| **ArabonFilters**                                              | فلترة (حالة، فئة)    |
| **ArabonSearch**                                               | البحث                |
| **ArabonDetails**                                              | تفاصيل العرض والحجز  |
| **ArabonForm**                                                 | نموذج إنشاء/تعديل    |
| **ArabonMyList**                                               | عروضي                |
| **useArabonList, useArabon, useArabonMyList, useArabonSearch** | Hooks لاستدعاءات API |

---

## 4. جدول المقارنة الرئيسي

| المتطلب من الوثائق                             | التنفيذ في عربون                                        | الحالة  |
| ---------------------------------------------- | ------------------------------------------------------- | ------- |
| **Use Cases: عيادات، صالونات، دورات، فعاليات** | offerType: clinic, salon, event, venue, other           | ✅ منفذ |
| **Booking Options: مجاني/مدفوع**               | depositAmount (0 = مجاني)                               | ✅ منفذ |
| **Slot Manager**                               | BookingSlotService + إنشاء slots عبر نطاق زمني أو قائمة | ✅ منفذ |
| **Wallet Integration**                         | holdFunds, release, transfer للمالك                     | ✅ منفذ |
| **No-show Logic**                              | BookingStatus.NO_SHOW، لا استرداد، تحويل للمالك         | ✅ منفذ |
| **Booking Slots (يومي/ساعي)**                  | durationMinutes، hourly/daily عبر slots                 | ✅ منفذ |
| **Booking Types (مجاني/مدفوع)**                | depositAmount                                           | ✅ منفذ |
| **Calendar View**                              | عرض slots مع from/to                                    | ✅ منفذ |
| **Clinic/Event/Salon Profiles**                | Arabon مع offerType و category                          | ✅ منفذ |
| **Booking History**                            | /arabon/bookings/my، فلترة تاريخ وحالة                  | ✅ منفذ |
| **Booking Fee Deducted from Total**            | العربون يُحجز؛ عند الإكمال يُحوّل للمالك                | ✅ منفذ |
| **No-Show Flagging**                           | no_show + سياسة استرداد                                 | ✅ منفذ |
| **Coupons for First Booking**                  | CouponService + hasPreviousBooking                      | ✅ منفذ |
| **Venue Videos**                               | videos[] في Arabon                                      | ✅ منفذ |
| **Admin sees booking stats**                   | KPIs في لوحة التحكم                                     | ✅ منفذ |

---

## 5. تبعية API: المتطلبات مقابل التنفيذ

| مرجع الوثائق                    | التنفيذ الفعلي                  |
| ------------------------------- | ------------------------------- |
| POST /offers/post               | POST /arabon                    |
| GET /bookings/slots/:providerId | GET /arabon/:id/slots           |
| POST /bookings/confirm          | POST /arabon/:id/book           |
| GET /bookings/status/:id        | GET /arabon/bookings/:bookingId |

**ملاحظة:** الـ API الحالي أكثر تفصيلاً (مثل: عربوناتي، طلبات، إنشاء slots، إحصائيات، إلخ).

---

## 6. إضافات وتوسعات في التنفيذ

| الميزة                    | الوصف                                                                              |
| ------------------------- | ---------------------------------------------------------------------------------- |
| **نموذج الطلب (Request)** | المستخدم يقدم طلبًا → المالك يقبل أو يرفض → عند القبول يتم إنشاء الحجز وحجز المبلغ |
| **صور وفيديو**            | images[], videos[] في Arabon                                                       |
| **معلومات التواصل**       | contactPhone, socialLinks (whatsapp, facebook, instagram)                          |
| **فترة الحجز**            | bookingPeriod (hour/day/week), pricePerPeriod, bookingPrice                        |
| **سجل النشاط**            | ArabonStatusLog لسجل تغييرات الحالة                                                |
| **دعم Cursor للتنقل**     | pagination مع nextCursor في معظم القوائم                                           |
| **Swagger توثيق عربي**    | توثيق كامل بالعربية                                                                |

---

## 7. سياسة الاسترداد

| الحالة        | الاسترداد             | المبلغ المحجوز              |
| ------------- | --------------------- | --------------------------- |
| **cancelled** | استرداد كامل للمستخدم | يُرجع للمستخدم + تحرير slot |
| **completed** | -                     | يُحوّل للمالك               |
| **no_show**   | لا استرداد            | يُحوّل للمالك + تحرير slot  |

(مُطبّقة في `booking-refund-policy.config.ts` و `BookingService.updateStatus`)

---

## 8. الخلاصة

خدمة عربون تنفّذ متطلبات V5 – Offers & Bookings بشكل كامل من حيث:

- ✅ العروض (عيادات، صالونات، فعاليات، إلخ)
- ✅ فترات الحجز (slots) والتقويم
- ✅ الحجز المجاني والمدفوع
- ✅ تكامل المحفظة (حجز، استرداد، تحويل للمالك)
- ✅ منطق no-show والاسترداد
- ✅ كوبونات أول حجز
- ✅ فيديوهات للمكان
- ✅ إحصائيات وإدارة الحجوزات في لوحة التحكم
- ✅ تطبيق المستخدم، الويب، لوحة التحكم، والباك إند

مع إضافات مثل نموذج الطلب (Request) وبيانات التواصل لفائدة المستخدم والمقدمين.

---

## 9. مراجع الملفات

| المكون                 | المسار                                                                                        |
| ---------------------- | --------------------------------------------------------------------------------------------- |
| Backend – Arabon       | `backend-nest/src/modules/arabon/`                                                            |
| Backend – Admin Arabon | `backend-nest/src/modules/admin/arabon.admin.controller.ts`                                   |
| Admin Dashboard        | `admin-dashboard/src/pages/admin/arabon/`                                                     |
| App-User               | `app-user/src/screens/arabon/`                                                                |
| Web                    | `bthwani-web/src/features/arabon/`                                                            |
| وثائق التسليم          | `Full Handover Documents for bThwani Super App & Web Development, final to Mohammed .docx.md` |
