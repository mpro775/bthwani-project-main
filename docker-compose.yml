services:
  # =========================================
  # üåê 1. Nginx Proxy Manager (The Gateway)
  # =========================================
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: bthwani-proxy
    restart: unless-stopped
    ports:
      - '80:80'     # HTTP
      - '443:443'   # HTTPS
      - '81:81'     # Admin Panel
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - ./npm-data:/data
      - ./npm-letsencrypt:/etc/letsencrypt
    networks:
      - bthwani-network
    healthcheck:
      test: ["CMD", "/bin/check-health"]
      interval: 10s
      timeout: 3s

  # =========================================
  # üî¥ 2. Redis (Cache & Queues)
  # =========================================
  redis:
    image: redis:7-alpine
    container_name: bthwani-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass "CHANGE_THIS_PASSWORD"
    volumes:
      - redis-data:/data
    networks:
      - bthwani-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "CHANGE_THIS_PASSWORD", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================
  # ‚öôÔ∏è 3. Backend API (NestJS - backend-nest)
  # =========================================
  backend:
    build:
      context: ./backend-nest
      dockerfile: Dockerfile
    container_name: bthwani-backend
    restart: unless-stopped
    env_file: ./backend-nest/.env
    environment:
      # ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑÿØÿßÿÆŸÑŸäÿ©
      - REDIS_HOST=bthwani-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=CHANGE_THIS_PASSWORD
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - bthwani-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health/liveness', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================
  # üíª 4. Website (Dashboard & Landing)
  # =========================================
  admin-dashboard:
    build:
      context: ./admin-dashboard
      dockerfile: Dockerfile
    container_name: bthwani-admin-dashboard
    restart: unless-stopped
    env_file: ./admin-dashboard/.env
    networks:
      - bthwani-network

  # =========================================
  # üì± 5. Web App (User Application)
  # =========================================
  bthwani-web:
    build:
      context: ./bthwani-web
      dockerfile: Dockerfile
    container_name: bthwani-webapp
    restart: unless-stopped
    env_file: ./bthwani-web/.env
    networks:
      - bthwani-network

# =========================================
# üï∏Ô∏è Network & Volumes
# =========================================
networks:
  bthwani-network:
    driver: bridge

volumes:
  npm-data:
  npm-letsencrypt:
  redis-data: