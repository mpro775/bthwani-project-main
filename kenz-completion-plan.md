# خطة إكمال خدمة كنز (السوق المفتوح)

هذا الملف يحدد **النواقص** المطلوب تنفيذها لإكمال خدمة كنز وفق مستند التسليم (V2 – Marketplace / Haraj)، مع **التركيز على الباك اند، لوحة التحكم، والتطبيق**.

---

## المراجع

- **المستند:** Full Handover Documents for bThwani Super App & Web Development
- **الوضع الحالي:** مقارنة كنز مع مواصفات V2 Marketplace في `kenz-completion-plan.md` (أو المحادثة السابقة)
- **المشاريع:** `backend-nest` | `admin-dashboard` | `bthwani-web` | `app-user`

---

## أولويات التنفيذ (مراحل مقترحة)

| المرحلة | المحتوى                                    | الأولوية     | الحالة   |
| ------- | ------------------------------------------ | ------------ | -------- |
| **1**   | بحث نصي + ترتيب + تم البيع + الإبلاغ       | عالية        | ✅ منفذة |
| **2**   | فئات متداخلة + أرشفة 90 يوم                | عالية        | ✅ منفذة |
| **3**   | المفضلة + تحسينات الواجهة                  | متوسطة       | ✅ منفذة |
| **4**   | ترويج الإعلان (Boost)                      | متوسطة       | ✅ منفذة |
| **5**   | إيكرو + توصيل/لقاء + نشر بالنيابة + مزادات | منخفضة/لاحقة | —        |

---

# 1. الباك اند (backend-nest)

## 1.1 وحدة كنز الحالية (`src/modules/kenz`)

### 1.1.1 بحث نصي (Search)

| المهمة                                   | الوصف                                                         | الملفات                                 |
| ---------------------------------------- | ------------------------------------------------------------- | --------------------------------------- |
| إضافة معامل `search` لـ `GET /kenz`      | البحث في `title`, `description`, `keywords` (نص عربي/إنجليزي) | `kenz.controller.ts`, `kenz.service.ts` |
| دعم البحث مع الـ cursor والفلترة الحالية | عدم كسر الـ API الحالي                                        | `kenz.service.ts`                       |

**تفاصيل تقنية (مقترحة):**

- في `KenzController.list()`: إضافة `@Query('search') search?: string`.
- في `KenzService.list()`: إذا وُجد `search` استخدم `$regex` على `title`, `description`, `keywords` (مع escape وبدون case sensitivity إن أمكن).

---

### 1.1.2 ترتيب النتائج (Sort)

| المهمة                            | الوصف                                                                                                         | الملفات                                 |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| إضافة معامل `sort` لـ `GET /kenz` | قيم مقترحة: `newest` (افتراضي), `price_asc`, `price_desc`, `views_desc`, `nearest` (لاحقاً عند وجود إحداثيات) | `kenz.controller.ts`, `kenz.service.ts` |
| تطبيق الترتيب في الاستعلام        | `.sort(...)` حسب القيمة المختارة                                                                              | `kenz.service.ts`                       |

**ملاحظة:** `nearest` يتطلب إضافة حقل موقع (إحداثيات) للإعلان أو الاعتماد على `city` فقط في المرحلة الأولى.

---

### 1.1.3 تم البيع (Mark as Sold)

| المهمة                                                             | الوصف                                                | الملفات                                 |
| ------------------------------------------------------------------ | ---------------------------------------------------- | --------------------------------------- |
| إضافة endpoint مخصص `PUT /kenz/:id/sold` أو `PATCH /kenz/:id/sold` | يضع `status = completed` ويسجل تاريخ البيع (اختياري) | `kenz.controller.ts`, `kenz.service.ts` |
| اختياري: حقل `soldAt?: Date` في الـ entity                         | لتقارير وإحصائيات "تم البيع خلال 14 يوم"             | `entities/kenz.entity.ts`               |

---

### 1.1.4 الإبلاغ عن إعلان (Report)

| المهمة                           | الوصف                                                                  | الملفات                                             |
| -------------------------------- | ---------------------------------------------------------------------- | --------------------------------------------------- |
| إنشاء جدول/مجموعة `kenz_reports` | حقول: `kenzId`, `reporterId`, `reason`, `notes`, `status`, `createdAt` | وحدة جديدة أو داخل `kenz`                           |
| endpoint `POST /kenz/:id/report` | Body: `reason`, `notes?` — يتطلب مستخدم مصادق                          | `kenz.controller.ts` أو `kenz-report.controller.ts` |
| منع التكرار                      | عدم السماح لنفس المستخدم بالإبلاغ أكثر من مرة على نفس الإعلان          | في الـ service                                      |

---

### 1.1.5 فلتر حالة السلعة (Condition)

| المهمة                                                                | الوصف                       | الملفات                                 |
| --------------------------------------------------------------------- | --------------------------- | --------------------------------------- |
| إضافة حقل `condition?: 'new' \| 'used' \| 'refurbished'` في إعلان كنز | اختياري في الإنشاء والتحديث | `entities/kenz.entity.ts`, DTOs         |
| إضافة فلتر `condition` لـ `GET /kenz`                                 | اختياري                     | `kenz.controller.ts`, `kenz.service.ts` |

---

## 1.2 فئات متداخلة (Categories)

| المهمة                                         | الوصف                                                                                                              | الملفات                                                   |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------- |
| إنشاء مجموعة/جدول `kenz_categories`            | حقول: `nameAr`, `nameEn`, `parentId` (مرجع ذاتي), `slug`, `order`                                                  | `modules/kenz-category/` (أو داخل kenz)                   |
| CRUD للفئات (للوحة التحكم)                     | إنشاء، تحديث، حذف، قائمة شجرية                                                                                     | `kenz-category.controller.ts`, `kenz-category.service.ts` |
| endpoint عام `GET /kenz/categories`            | يرجع شجرة الفئات (للتطبيق والويب)                                                                                  | لا يحتاج صلاحيات أدمن                                     |
| ربط إعلان كنز بـ `categoryId` (مرجع إلى الفئة) | بدلاً من أو بالإضافة إلى النص الحر `category` الحالي (مرحلة انتقالية: الإبقاء على النص + إضافة categoryId اختياري) | `entities/kenz.entity.ts`, DTOs                           |

---

## 1.3 أرشفة الإعلانات المباعة (Archival – 90 يوم)

| المهمة                                              | الوصف                                                                                                                       | الملفات                                         |
| --------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| Cron أو Queue مهمة دورية                            | تشغيل يومي: إعلانات `status=completed` و `soldAt` (أو `updatedAt`) أقدم من 90 يوم → نقل إلى أرشيف أو تحديث `archived: true` | `src/modules/kenz/` أو `src/queues/processors/` |
| اختياري: مجموعة `kenz_archived` أو حقل `archivedAt` | لتقارير والاحتفاظ بالبيانات دون عرضها في القائمة الافتراضية                                                                 | حسب التصميم المفضل                              |
| استبعاد المؤرشفة من `GET /kenz` الافتراضي           | الفلتر الافتراضي `archived != true` أو عدم تضمينها في الاستعلام                                                             | `kenz.service.ts`                               |

---

## 1.4 المفضلة (Favorites)

| المهمة                                           | الوصف                                        | الملفات                           |
| ------------------------------------------------ | -------------------------------------------- | --------------------------------- |
| مجموعة `kenz_favorites`                          | حقول: `userId`, `kenzId`, `createdAt`        | وحدة `kenz-favorite` أو داخل kenz |
| `POST /kenz/:id/favorite`                        | إضافة للمفضلة (مستخدم مصادق)                 | controller + service              |
| `DELETE /kenz/:id/favorite`                      | إزالة من المفضلة                             | controller + service              |
| `GET /kenz/favorites` أو داخل profile            | قائمة إعلانات المستخدم المفضلة               | controller + service              |
| دعم معامل `favoritedBy` في `GET /kenz` (اختياري) | لمعرفة إن كان المستخدم الحالي قد حفظ الإعلان | service                           |

---

## 1.5 ترويج الإعلان (Boost)

| المهمة                              | الوصف                                                                                                   | الملفات                                        |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| مجموعة `kenz_boosts` أو `ad_boosts` | حقول: `kenzId`, `startDate`, `endDate`, `boostType` (مثلاً: highlight, pin, top), `createdBy`, `status` | وحدة `kenz-boost`                              |
| خدمة Boost                          | إنشاء boost، التحقق من الصلاحية، إيقاف منتهي الصلاحية                                                   | `kenz-boost.service.ts`                        |
| endpoints للأدمن والتطبيق           | أدمن: إنشاء/إلغاء boost. تطبيق: قائمة الإعلانات تعرض المروّجة أولاً أو بعلامة "مميز"                    | `kenz-boost.controller.ts`, دمج في `GET /kenz` |
| دمج قائمة كنز مع Boost              | ترتيب النتائج: المروّجة أولاً ثم الباقي (مع احترام الترتيب المطلوب: سعر، مشاهدة، إلخ)                   | `kenz.service.ts`                              |

---

## 1.6 الإيكرو والتوصيل (مرحلة لاحقة)

| المهمة                                                       | الوصف                                                       |
| ------------------------------------------------------------ | ----------------------------------------------------------- |
| تكامل مع خدمة المحفظة/الإيكرو الموجودة                       | ربط صفقة كنز بمعاملة إيكرو (احتجاز مبلغ حتى تأكيد الاستلام) |
| حقل في الإعلان: خيار الدفع بالإيكرو + خيار التوصيل أو اللقاء | في الـ entity و DTOs وواجهات التطبيق                        |

---

## 1.7 نشر بالنيابة (مرحلة لاحقة)

| المهمة                                                                      | الوصف                        |
| --------------------------------------------------------------------------- | ---------------------------- |
| حقل اختياري في الإعلان: `postedOnBehalfOfPhone` أو `postedOnBehalfOfUserId` | لتسجيل من نُشر الإعلان باسمه |
| التحقق من الصلاحيات إن لزم (أدمن فقط أو أي مستخدم)                          | حسب السياسة                  |

---

## 1.8 المزادات (مرحلة لاحقة)

| المهمة                                                             | الوصف                               |
| ------------------------------------------------------------------ | ----------------------------------- |
| جدول/مجموعة للمزايدات + حقل `isAuction`, `auctionEndAt` في الإعلان | تصميم منفصل لجدول العروض والمزايدين |
| منطق إغلاق المزاد عند `auctionEndAt` وإشعارات                      | Cron أو Queue                       |

---

# 2. لوحة التحكم (admin-dashboard)

## 2.1 تحسينات على الصفحات الحالية

| المهمة                                                             | الوصف                                                                     | الملفات                                            |
| ------------------------------------------------------------------ | ------------------------------------------------------------------------- | -------------------------------------------------- |
| ربط فلتر البحث بـ API البحث الجديد                                 | إرسال `search` إلى `GET /admin/kenz` أو `/kenz` مع دعم البحث في الباك اند | `api/kenz.ts`, `pages/admin/kenz/KenzListPage.tsx` |
| إضافة فلتر الترتيب (الأحدث، السعر، المشاهدات)                      | إرسال `sort` للباك اند                                                    | نفس الصفحة + API                                   |
| زر أو إجراء "تم البيع" سريع من القائمة/التفاصيل                    | استدعاء `PUT /kenz/:id/sold` أو تحديث الحالة                              | `KenzListPage.tsx`, `KenzDetailsPage.tsx`          |
| إضافة فلتر "حالة السلعة" (جديد/مستعمل/مجدد) عند دعمها في الباك اند | إرسال `condition`                                                         | `KenzListPage.tsx`, `api/kenz.ts`                  |

---

## 2.2 الإبلاغ عن الإعلانات

| المهمة                         | الوصف                                                                  | الملفات                                                           |
| ------------------------------ | ---------------------------------------------------------------------- | ----------------------------------------------------------------- |
| صفحة قائمة البلاغات            | جدول: إعلان، مبلّغ، سبب، تاريخ، حالة (قيد المراجعة، مرفوض، تم الإجراء) | `pages/admin/kenz/KenzReportsPage.tsx` (جديد)                     |
| API جلب وتحديث حالة البلاغات   | `GET /admin/kenz/reports`, `PATCH /admin/kenz/reports/:id` (أدمن فقط)  | `backend-nest` admin controller + `admin-dashboard` `api/kenz.ts` |
| إضافة رابط في القائمة الجانبية | تحت قسم كنز: "بلاغات الإعلانات"                                        | `AdminNavigation.tsx` أو `Sidebar`                                |

---

## 2.3 إدارة الفئات (عند تنفيذ الفئات المتداخلة)

| المهمة                   | الوصف                                               | الملفات                                            |
| ------------------------ | --------------------------------------------------- | -------------------------------------------------- |
| صفحة إدارة فئات كنز      | شجرة فئات: إضافة/تعديل/حذف، ترتيب، اسم عربي/إنجليزي | `pages/admin/kenz/KenzCategoriesPage.tsx` (جديد)   |
| API CRUD للفئات (أدمن)   | `GET/POST/PATCH/DELETE /admin/kenz/categories`      | باك اند + `api/kenz.ts` أو `api/kenzCategories.ts` |
| رابط في القائمة الجانبية | "فئات كنز" تحت قسم كنز                              | نفس ما سبق                                         |

---

## 2.4 ترويج الإعلانات (Boost)

| المهمة                                      | الوصف                                      | الملفات                                                           |
| ------------------------------------------- | ------------------------------------------ | ----------------------------------------------------------------- |
| صفحة قائمة العروض المروّجة أو إدارة الترويج | اختيار إعلان، نوع ترويج، تاريخ بداية/نهاية | `pages/admin/kenz/KenzBoostPage.tsx` أو تبويب داخل تفاصيل الإعلان |
| API إنشاء/إلغاء Boost                       | باك اند + استدعاء من لوحة التحكم           | `api/kenz.ts` أو `api/kenzBoost.ts`                               |

---

## 2.5 إحصائيات وإعدادات (اختياري)

| المهمة                                                            | الوصف                                                   |
| ----------------------------------------------------------------- | ------------------------------------------------------- |
| لوحة كنز: عدد البلاغات المعلقة، إعلانات تم بيعها خلال 14 يوم، إلخ | استخدام `GET /admin/kenz/stats/overview` وتوسيعه إن لزم |
| إعدادات عامة لكنز (مدة الأرشفة، سياسة الإبلاغ)                    | إن وُجدت في الباك اند                                   |

---

# 3. التطبيق (bthwani-web + app-user)

## 3.1 الويب (bthwani-web)

| المهمة                                                        | الوصف                                                                                                            | الملفات                                                                                               |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| ربط البحث النصي بالـ API                                      | إرسال `search` في `getKenzList` واستخدامه في الفلاتر                                                             | `features/kenz/api.ts`, `KenzList.tsx`, `KenzFilters.tsx`                                             |
| إضافة خيارات الترتيب في الواجهة                               | قائمة/تاب: الأحدث، السعر (أقل–أعلى)، الأكثر مشاهدة                                                               | `features/kenz/types.ts`, `KenzList.tsx` أو `KenzFilters.tsx`                                         |
| زر "تم البيع" في صفحة تفاصيل الإعلان (للمالك)                 | استدعاء `PUT /kenz/:id/sold` أو تحديث الحالة ثم إعادة التوجيه أو تحديث العرض                                     | `KenzDetails.tsx`, `api.ts`                                                                           |
| زر "الإبلاغ عن إعلان" في صفحة التفاصيل                        | نموذج صغير: سبب + ملاحظات، ثم `POST /kenz/:id/report`                                                            | `KenzDetails.tsx`, إضافة دالة في `api.ts`                                                             |
| المفضلة: زر قلب في البطاقة/التفاصيل + صفحة "إعلاناتي المفضلة" | إضافة/إزالة مفضلة، وجلب قائمة المفضلة                                                                            | `features/kenz/api.ts`, مكونات جديدة أو توسيع الحالية، route للمفضلة                                  |
| عرض الفئات من الـ API (عند توفر شجرة الفئات)                  | استبدال أو دمج القائمة الثابتة مع `GET /kenz/categories`                                                         | `features/kenz/types.ts`, مكون الفئات                                                                 |
| فلتر "حالة السلعة" (جديد/مستعمل/مجدد) عند دعمها               | في شريط الفلاتر                                                                                                  | `KenzFilters.tsx`, types, api                                                                         |
| تفعيل واجهة المحادثات على الويب                               | تم: مسارات `/kenz/chat` و `/kenz/chat/:conversationId`، زر المحادثة ينشئ محادثة ويوجّه، زر "محادثاتي" في القائمة | `App.tsx`, `pages/kenz/Kenz.tsx`, `KenzChatList.tsx`, `KenzChatPage.tsx`, `features/kenz/api-chat.ts` |
| عرض الإعلانات المروّجة (علامة "مميز" أو قسم منفصل)            | عند دمج Boost في قائمة كنز                                                                                       | `KenzCard.tsx`, `KenzList.tsx`                                                                        |

---

## 3.2 تطبيق المستخدم (app-user)

| المهمة                                   | الوصف                                             | الملفات                             |
| ---------------------------------------- | ------------------------------------------------- | ----------------------------------- |
| ربط البحث والترتيب بالـ API              | نفس منطق الويب: `search`, `sort` في طلبات القائمة | `api/kenzApi.ts`, شاشات كنز         |
| زر "تم البيع" في تفاصيل الإعلان (للمالك) | استدعاء endpoint تم البيع                         | شاشة التفاصيل                       |
| الإبلاغ عن إعلان                         | نموذج + `POST /kenz/:id/report`                   | شاشة التفاصيل + API                 |
| المفضلة                                  | زر في البطاقة/التفاصيل + شاشة "المفضلة" إن لزم    | `api/kenzApi.ts`, شاشات/مكونات كنز  |
| دعم الفئات من الـ API عند توفرها         | استبدال القائمة الثابتة                           | types + API + شاشات الإنشاء/الفلاتر |
| فلتر حالة السلعة عند دعمها               | في الفلاتر                                        | نفس الشاشات                         |
| عرض الإعلانات المروّجة                   | كقسم أو علامة "مميز"                              | قائمة كنز وبطاقة الإعلان            |

---

# 4. ملخص نقاط التكامل بين المشاريع

| الميزة            | الباك اند                                | لوحة التحكم                   | الويب                                 | التطبيق (app-user)    |
| ----------------- | ---------------------------------------- | ----------------------------- | ------------------------------------- | --------------------- |
| بحث نصي           | معامل `search` في GET /kenz              | فلتر بحث يرسل search          | إرسال search من الفلاتر               | نفس المنطق            |
| ترتيب             | معامل `sort` في GET /kenz                | فلتر ترتيب                    | خيارات ترتيب في الواجهة               | نفس المنطق            |
| تم البيع          | PUT/PATCH /kenz/:id/sold                 | زر سريع + تحديث الحالة        | زر للمالك في التفاصيل                 | زر للمالك في التفاصيل |
| الإبلاغ           | POST /kenz/:id/report + جدول بلاغات      | صفحة بلاغات + مراجعة          | زر "الإبلاغ" + نموذج                  | زر "الإبلاغ" + نموذج  |
| فئات متداخلة      | جدول categories + GET /kenz/categories   | صفحة إدارة فئات               | جلب فئات وعرضها في النشر/الفلاتر      | نفس المنطق            |
| أرشفة 90 يوم      | Cron/Queue + استبعاد المؤرشفة من القائمة | عرض المؤرشفة إن لزم في الأدمن | —                                     | —                     |
| المفضلة           | جدول favorites + endpoints               | —                             | زر مفضلة + صفحة مفضلة                 | زر مفضلة + صفحة مفضلة |
| Boost             | جدول boosts + دمج في قائمة كنز           | صفحة/تبويب إدارة الترويج      | عرض "مميز" في القائمة                 | عرض "مميز" في القائمة |
| حالة السلعة       | حقل condition + فلتر                     | فلتر في القائمة               | فلتر في الفلاتر                       | فلتر في الفلاتر       |
| محادثات على الويب | موجود (kenz-chat)                        | —                             | مكتمل (مسارات + زر محادثة + محادثاتي) | موجود مسبقاً          |

---

# 5. ترتيب تنفيذ مقترح (Checklist)

- [x] **الباك اند:** بحث نصي في GET /kenz
- [x] **الباك اند:** ترتيب (sort) في GET /kenz
- [x] **الباك اند:** endpoint تم البيع + حقل soldAt (اختياري)
- [x] **الباك اند:** الإبلاغ عن إعلان (جدول + POST /kenz/:id/report)
- [x] **لوحة التحكم:** ربط البحث والترتيب وتم البيع
- [x] **الويب:** ربط البحث والترتيب + زر تم البيع + زر الإبلاغ
- [x] **التطبيق:** نفس الربط + تم البيع + الإبلاغ
- [x] **الباك اند:** فئات متداخلة (جدول + CRUD + GET /kenz/categories)
- [x] **الباك اند:** أرشفة 90 يوم (Cron/Queue)
- [x] **لوحة التحكم:** صفحة بلاغات كنز + صفحة فئات كنز
- [x] **الباك اند:** المفضلة (جدول kenz_favorites + POST/DELETE /kenz/:id/favorite + GET /kenz/favorites)
- [x] **الويب والتطبيق:** المفضلة (زر قلب في البطاقة/التفاصيل + صفحة إعلاناتي المفضلة)
- [x] **فلتر حالة السلعة** (الباك اند + لوحة التحكم + الويب + التطبيق)
- [x] **الباك اند:** Boost (جدول kenz_boosts + إنشاء/إلغاء + دمج في قائمة كنز مع isBoosted/boostType)
- [x] **لوحة التحكم:** إدارة الترويج (صفحة ترويج الإعلانات + إنشاء/إلغاء)
- [x] **الويب والتطبيق:** عرض إعلان مميز (شارة "مميز" في البطاقة والتفاصيل)
- [x] **الويب:** محادثات كنز (واجهة kenz-chat: مسارات /kenz/chat و /kenz/chat/:conversationId، ربط زر المحادثة بإنشاء المحادثة والتوجيه، زر "محادثاتي" في القائمة)
- [ ] (لاحقاً) إيكرو، توصيل/لقاء، نشر بالنيابة، مزادات — **خطة تفصيلية:** `kenz-phase5-later-plan.md`

---

_تم إعداد هذه الخطة بناءً على مقارنة خدمة كنز الحالية مع مواصفات V2 – Marketplace في مستند التسليم. يمكن تعديل الأولويات والمراحل حسب موارد الفريق والجدول الزمني._
