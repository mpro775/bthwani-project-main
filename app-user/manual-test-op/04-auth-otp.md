# اختبار المصادقة - التحقق من OTP

## نظرة عامة

هذا الملف يغطي اختبار عمليات التحقق من OTP (One-Time Password) في التطبيق.

---

## المتطلبات الأساسية

- رقم هاتف مسجل في النظام
- إمكانية الوصول للرسائل النصية
- حساب مستخدم موجود

---

## البيئة

- **Base URL:** `http://localhost:3000`
- **API Version:** v1 أو v2
- **Content-Type:** `application/json`

---

## العمليات

### 1. التحقق من رمز OTP

**الهدف:** التحقق من صحة رمز OTP المرسل إلى رقم الهاتف

**Endpoint:** `POST /auth/verify-otp`

**Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+967777123456",
  "otp": "123456"
}
```

**خطوات الاختبار:**

1. احصل على رمز OTP من الرسالة النصية
2. أرسل طلب POST إلى `/auth/verify-otp`
3. أرسل phone و otp في body
4. تحقق من الرد

**Expected Response (200 OK):**
```json
{
  "success": true,
  "message": "تم التحقق من الرمز بنجاح",
  "data": {
    "verified": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "507f1f77bcf86cd799439011",
      "phone": "+967777123456",
      "name": "أحمد محمد"
    }
  }
}
```

**حالات الاختبار:**

✅ **حالة النجاح:**
- رقم الهاتف موجود في النظام
- رمز OTP صحيح
- يجب أن يعيد verified: true و token

❌ **حالة الفشل (400 Bad Request):**
- رمز OTP غير صحيح
- Request body غير مكتمل

❌ **حالة الفشل (404 Not Found):**
- المستخدم غير موجود
- رقم الهاتف غير مسجل

**Rate Limiting:**
- 5 محاولات في الدقيقة الواحدة

---

## التحقق

بعد كل عملية، تحقق من:

1. ✅ وصول رمز OTP إلى رقم الهاتف
2. ✅ صحة الرمز عند التحقق
3. ✅ الحصول على token صالح
4. ✅ إمكانية استخدام الـ token في الطلبات التالية

---

## ملاحظات مهمة

1. **مدة صلاحية OTP:** رمز OTP له مدة صلاحية محددة (عادة 5-10 دقائق)
2. **تنسيق رقم الهاتف:** يجب أن يكون رقم الهاتف بالتنسيق الدولي (+967...)
3. **Rate Limiting:** احترم حدود Rate Limiting لتجنب الحظر
4. **الأمان:** لا تشارك رموز OTP

---

## أمثلة باستخدام curl

```bash
# التحقق من رمز OTP
curl -X POST http://localhost:3000/auth/verify-otp \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+967777123456",
    "otp": "123456"
  }'
```

---

## حالات الاختبار الإضافية

### اختبار دورة OTP الكاملة

1. اطلب رمز OTP (عادة يتم إرساله تلقائياً عند الحاجة)
2. تحقق من وصول الرمز
3. تحقق من صحة الرمز
4. استخدم الـ token في طلبات محمية

### اختبار الرمز المنتهي الصلاحية

1. احصل على رمز OTP
2. انتظر انتهاء صلاحية الرمز
3. حاول استخدام الرمز
4. يجب أن يفشل

### اختبار Rate Limiting

1. أرسل 6 محاولات تحقق في أقل من دقيقة
2. يجب أن يعيد المحاولة السادسة 429 Too Many Requests

### اختبار رمز OTP خاطئ

1. احصل على رمز OTP صحيح
2. حاول استخدام رمز خاطئ
3. يجب أن يفشل مع رسالة خطأ مناسبة

---

## سيناريوهات الاستخدام

### سيناريو 1: تسجيل الدخول باستخدام OTP

1. أدخل رقم الهاتف
2. احصل على رمز OTP
3. أدخل الرمز
4. سجّل الدخول بنجاح

### سيناريو 2: التحقق من رقم الهاتف

1. أثناء التسجيل أو تحديث الملف الشخصي
2. أدخل رقم هاتف جديد
3. احصل على رمز OTP
4. تحقق من الرمز
5. يتم تأكيد رقم الهاتف

---

**الملف السابق:** [03-auth-password-reset.md](03-auth-password-reset.md)  
**الملف التالي:** [05-user-profile.md](05-user-profile.md)
