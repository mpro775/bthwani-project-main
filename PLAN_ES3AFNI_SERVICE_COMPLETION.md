# خطة إكمال خدمة اسعفني – التبرع بالدم العاجل (V7)

هذه الخطة لإكمال **خدمة اسعفني** (شبكة تبرع بالدم العاجلة) وفق مواصفات V7 – Find Blood في وثائق التسليم، **بدون تكامل مع المستشفيات** بسبب الاعتبارات الأمنية.

الربط بين:

- **الخادم** (backend-nest)
- **تطبيق المستخدم** (app-user)
- **الموقع** (bthwani-web)
- **لوحة التحكم** (admin-dashboard)

---

## الوضع الحالي vs الهدف (ملخص)

| الجانب                | الوضع الحالي                   | الهدف                                              |
| --------------------- | ------------------------------ | -------------------------------------------------- |
| **طلبات الدم**        | موجود (CRUD، قائمة، تفاصيل)    | إضافة urgency، expiresAt، انتهاء تلقائي 48 ساعة    |
| **سجل المتبرعين**     | غير موجود                      | كيان donors + تسجيل/تحديث/إيقاف التوفر             |
| **مطابقة جغرافية**    | غير موجود                      | API متبرعون قريبون (حسب الموقع وفصيلة الدم)        |
| **تنبيهات للمتبرعين** | غير موجود                      | إشعار push (وربما SMS للعاجل) عند نشر طلب مطابق    |
| **بلاغاتي / بحث**     | endpoints موجودة لكن غير منفذة | تنفيذ GET my و GET search وترتيب المسارات          |
| **محادثة الطلب**      | غير موجود                      | محادثة اختيارية مرتبطة بالطلب (48 ساعة ثم إغلاق)   |
| **تحقق الهاتف**       | غير موجود                      | تحقق رقم هاتف قبل السماح بنشر الطلب (اختياري)      |
| **لوحة الأدمن**       | قائمة + تحديث حالة + حذف       | فلترة urgency، إحصائيات، عرض المتبرعين (قراءة فقط) |

---

## المرحلة 1: Backend – طلبات الدم وسجل المتبرعين

### 1.1 إضافة حقول لطلب الدم (Es3afni Entity)

| #     | المهمة              | الملف               | التفاصيل                                                                                                                                     |
| ----- | ------------------- | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.1.1 | إضافة `urgency`     | `es3afni.entity.ts` | `@Prop({ enum: ['low','normal','urgent','critical'], default: 'normal' }) urgency?: string`                                                  |
| 1.1.2 | إضافة `expiresAt`   | `es3afni.entity.ts` | `@Prop({ type: Date }) expiresAt?: Date` — للانتهاء التلقائي بعد 48 ساعة من النشر                                                            |
| 1.1.3 | إضافة GeoJSON للبحث | `es3afni.entity.ts` | `@Prop({ type: { type: String, enum: ['Point'], coordinates: [Number] } }) locationGeo?: GeoJSON.Point` (اختياري، يُملأ من location.lat/lng) |
| 1.1.4 | إضافة `publishedAt` | `es3afni.entity.ts` | `@Prop({ type: Date }) publishedAt?: Date` — وقت تحويل الحالة إلى pending (لحساب 48 ساعة)                                                    |

### 1.2 تحديث DTOs الطلبات

| #     | المهمة                    | الملف                                             | التفاصيل                                                                     |
| ----- | ------------------------- | ------------------------------------------------- | ---------------------------------------------------------------------------- |
| 1.2.1 | إضافة urgency             | `create-es3afni.dto.ts` و `update-es3afni.dto.ts` | `@IsOptional() @IsIn(['low','normal','urgent','critical']) urgency?: string` |
| 1.2.2 | إضافة expiresAt (اختياري) | `create-es3afni.dto.ts`                           | إن لم يُمرَّر يُحسب تلقائياً: publishedAt + 48h                              |
| 1.2.3 | التحقق من bloodType       | `create-es3afni.dto.ts`                           | `@IsIn(['A+','A-','B+','B-','AB+','AB-','O+','O-'])` عند الإرسال             |

### 1.3 إنشاء كيان المتبرع (Donor Registry)

| #     | المهمة             | الملف                                                | التفاصيل                                                                                                                                                                     |
| ----- | ------------------ | ---------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.3.1 | إنشاء Donor entity | `es3afni/entities/es3afni-donor.entity.ts`           | حقول: userId (ObjectId ref User), bloodType (string), lastDonation (Date), available (boolean), location (lat/lng/address أو GeoJSON), city/governorate (string)، timestamps |
| 1.3.2 | تسجيل في Module    | `es3afni.module.ts`                                  | إضافة Es3afniDonor في MongooseModule                                                                                                                                         |
| 1.3.3 | DTOs المتبرع       | `dto/create-donor.dto.ts`, `dto/update-donor.dto.ts` | bloodType, lastDonation?, available, location?, city?                                                                                                                        |

### 1.4 إنشاء كيان تنبيهات المتبرعين (Donor Alerts)

| #     | المهمة                  | الملف                                            | التفاصيل                                                                                                          |
| ----- | ----------------------- | ------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------- |
| 1.4.1 | إنشاء DonorAlert entity | `es3afni/entities/es3afni-donor-alert.entity.ts` | requestId (ref Es3afni), donorId (ref Es3afniDonor أو userId), delivered (boolean), sentAt (Date), readAt? (Date) |
| 1.4.2 | تسجيل في Module         | `es3afni.module.ts`                              | إضافة Es3afniDonorAlert في MongooseModule                                                                         |

### 1.5 خدمة المتبرعين والتنبيهات

| #     | المهمة                 | الملف                                              | التفاصيل                                                                                                                                   |
| ----- | ---------------------- | -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| 1.5.1 | Donor CRUD + "بلاغاتي" | `es3afni.service.ts` أو `es3afni-donor.service.ts` | registerDonor, updateDonor, getMyDonorProfile, setAvailability; ربط بالمستخدم الحالي من الـ JWT                                            |
| 1.5.2 | GET donors/nearby      | نفس الخدمة                                         | استعلام بالموقع (lat, lng)، نصف قطر (km)، وفصيلة الدم؛ إرجاع متبرعين available فقط (بدون بيانات حساسة: مدينة/محافظة فقط إن لزم)            |
| 1.5.3 | عند إنشاء طلب عاجل     | `es3afni.service.ts`                               | بعد create طلب status=pending: استدعاء alert-engine للمتبرعين المطابقين القريبين، إنشاء DonorAlert، إرسال push (واختياري SMS للـ critical) |
| 1.5.4 | تكامل الإشعارات        | استخدام `notification-service` أو FCM              | دالة sendEs3afniAlertToDonors(requestId, donorIds[], title, body)                                                                          |

### 1.6 إصلاح ترتيب المسارات وتنفيذ my و search

| #     | المهمة           | الملف                             | التفاصيل                                                                                 |
| ----- | ---------------- | --------------------------------- | ---------------------------------------------------------------------------------------- |
| 1.6.1 | ترتيب المسارات   | `es3afni.controller.ts`           | وضع `@Get('my')` و `@Get('search')` **قبل** `@Get(':id')` حتى لا يُفسَّر my/search كـ id |
| 1.6.2 | تنفيذ GET my     | `es3afni.service.ts`              | find بالـ ownerId = المستخدم الحالي (من الـ guard)، مع cursor pagination                 |
| 1.6.3 | تنفيذ GET search | `es3afni.service.ts`              | فلترة حسب q (نص في title/description)، bloodType، status؛ مع cursor pagination           |
| 1.6.4 | فلترة في GET /   | `es3afni.controller.ts` + service | إضافة query params: bloodType, status, urgency (اختياري)                                 |

### 1.7 انتهاء الطلبات تلقائياً بعد 48 ساعة

| #     | المهمة                   | الملف                                      | التفاصيل                                                                                                                                                                        |
| ----- | ------------------------ | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.7.1 | Cron أو Scheduler        | `es3afni.service.ts` + `es3afni.module.ts` | استخدام `@nestjs/schedule`: كل ساعة (أو كل 15 دقيقة) استعلام الطلبات التي `status === 'pending'` و `expiresAt <= now` وتحديث status إلى `expired` أو إبقاء completed فقط يدوياً |
| 1.7.2 | حساب expiresAt عند النشر | `es3afni.service.ts`                       | عند تحويل الطلب إلى pending: `expiresAt = new Date(Date.now() + 48 * 60 * 60 * 1000)`                                                                                           |

### 1.8 تحقق رقم الهاتف (اختياري)

| #     | المهمة                  | الملف                               | التفاصيل                                                                                                                                         |
| ----- | ----------------------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1.8.1 | التحقق من هاتف المستخدم | قبل `create` في controller أو guard | إذا كان التحقق مطلوباً: التحقق من أن المستخدم لديه phoneVerified أو حقل مشابه في User؛ إن لم يكن: 403 مع رسالة "يرجى التحقق من رقم الهاتف أولاً" |
| 1.8.2 | ربط بـ User entity      | حسب نموذج المستخدم الحالي           | إضافة حقل phoneVerified في User إن لم يكن موجوداً، وتحديثه عند إتمام التحقق (OTP أو غيره)                                                        |

---

## المرحلة 2: Backend – محادثة الطلب (اختيارية)

يمكن إما استنساخ نموذج معروف-شات مع context = es3afni و requestId، أو إنشاء وحدة es3afni-chat مخصصة.

| #   | المهمة                   | الملف                          | التفاصيل                                                                                        |
| --- | ------------------------ | ------------------------------ | ----------------------------------------------------------------------------------------------- |
| 2.1 | إنشاء محادثة مرتبطة بطلب | وحدة chat عامة أو es3afni-chat | context: 'es3afni', contextId: requestId؛ المشاركون: صاحب الطلب + متبرع قبلها موافقة من المتبرع |
| 2.2 | إغلاق تلقائي بعد 48 ساعة | خدمة المحادثة أو cron          | بعد 48 ساعة من إنشاء المحادثة: تعطيل إرسال رسائل جديدة أو وضع المحادثة closed                   |
| 2.3 | إخفاء الهوية (اختياري)   | حسب المواصفات                  | عدم إظهار اسم/رقم المتبرع حتى يقبل الدخول في المحادثة                                           |

---

## المرحلة 3: تطبيق المستخدم (app-user)

### 3.1 طلبات الدم (الموجودة – تحسينات)

| #     | المهمة                       | الملف                                              | التفاصيل                                                    |
| ----- | ---------------------------- | -------------------------------------------------- | ----------------------------------------------------------- |
| 3.1.1 | إضافة حقل الأولوية (urgency) | `Es3afniCreateScreen.tsx`, `Es3afniEditScreen.tsx` | قائمة: عادي، عاجل، حرج؛ مع لون أو أيقونة لكل مستوى          |
| 3.1.2 | عرض expiresAt و urgency      | `Es3afniDetailsScreen.tsx`, `Es3afniCard`          | عرض "ينتهي بعد …" وشارة الأولوية                            |
| 3.1.3 | فلترة حسب فصيلة وأولوية      | `Es3afniListScreen.tsx`                            | شريط فلترة: bloodType، urgency (إن دعمها الـ API)           |
| 3.1.4 | ربط "بلاغاتي"                | تنقل أو تاب                                        | زر أو تاب "بلاغاتي" يستدعي getMyEs3afni ويعرض النتائج       |
| 3.1.5 | تحديث Types و API            | `types/types.ts`, `api/es3afniApi.ts`              | إضافة urgency, expiresAt, publishedAt في الأنواع و payloads |

### 3.2 سجل المتبرعين (جديد)

| #     | المهمة                    | الملف                                                   | التفاصيل                                                                                                               |
| ----- | ------------------------- | ------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| 3.2.1 | شاشة تسجيل متبرع          | `screens/es3afni/Es3afniDonorRegisterScreen.tsx` (جديد) | نموذج: فصيلة الدم، آخر تبرع (تاريخ)، الموقع (اختياري)، toggle "متاح للتبرع الآن"؛ استدعاء POST donors أو PUT donors/me |
| 3.2.2 | شاشة "ملف المتبرع"        | `screens/es3afni/Es3afniDonorProfileScreen.tsx` (جديد)  | عرض بيانات المتبرع الحالي وتعديلها (توفر، آخر تبرع، موقع)؛ GET donors/me و PATCH donors/me                             |
| 3.2.3 | زر من القائمة أو التفاصيل | `Es3afniListScreen` أو التبويب اسعفني                   | "سجّل كمتبرع" ينتقل إلى Es3afniDonorRegister أو Es3afniDonorProfile إن كان مسجلاً                                      |
| 3.2.4 | API المتبرع في التطبيق    | `api/es3afniApi.ts`                                     | getDonorProfile(), registerDonor(), updateDonor(), setDonorAvailability()                                              |

### 3.3 تفاصيل الطلب والإجراءات

| #     | المهمة                  | الملف                      | التفاصيل                                                                                                   |
| ----- | ----------------------- | -------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 3.3.1 | زر "أستطيع التبرع"      | `Es3afniDetailsScreen.tsx` | للمستخدم المتبرع: يفتح محادثة مع صاحب الطلب (إن وُجدت وحدة المحادثة) أو يعرض رقم تواصل إن وُجد في metadata |
| 3.3.2 | إشعارات الطلبات العاجلة | تكامل مع FCM/notifications | عند استلام إشعار طلب عاجل مطابق لفصيلتي: فتح تفاصيل الطلب أو القائمة مع فلتر                               |

### 3.4 التنقل (Navigation)

| #     | المهمة               | الملف                                           | التفاصيل                                  |
| ----- | -------------------- | ----------------------------------------------- | ----------------------------------------- |
| 3.4.1 | إضافة مسارات المتبرع | `navigation/index.tsx`, `types/navigation.d.ts` | Es3afniDonorRegister, Es3afniDonorProfile |
| 3.4.2 | روابط من اسعفني      | من قائمة اسعفني أو تفاصيل الطلب                 | الانتقال إلى تسجيل متبرع أو ملف المتبرع   |

---

## المرحلة 4: الموقع (bthwani-web)

| #   | المهمة                     | الملف                                         | التفاصيل                               |
| --- | -------------------------- | --------------------------------------------- | -------------------------------------- |
| 4.1 | إضافة urgency و expiresAt  | `features/es3afni/types.ts`, النماذج والقوائم | نفس المنطق كما في التطبيق              |
| 4.2 | فلترة حسب urgency          | `Es3afniFilters.tsx` أو مكافئ                 | إضافة اختيار أولوية                    |
| 4.3 | صفحة "سجّل كمتبرع"         | صفحة جديدة في es3afni                         | نموذج تسجيل/تحديث متبرع مع نفس الـ API |
| 4.4 | عرض "ينتهي بعد" وشارة عاجل | بطاقة البلاغ وتفاصيله                         | مطابق لـ app-user                      |

---

## المرحلة 5: لوحة التحكم (admin-dashboard)

### 5.1 طلبات الدم

| #     | المهمة                              | الملف                        | التفاصيل                                                         |
| ----- | ----------------------------------- | ---------------------------- | ---------------------------------------------------------------- |
| 5.1.1 | فلترة حسب urgency                   | `Es3afniListPage.tsx` أو API | إضافة فلتر أولوية (عادي / عاجل / حرج)                            |
| 5.1.2 | فلترة حسب تاريخ الانتهاء            | نفس الصفحة                   | عرض الطلبات المنتهية (expiresAt < now) أو القريبة من الانتهاء    |
| 5.1.3 | عمود الأولوية وعمود انتهاء الصلاحية | جدول القائمة                 | عرض urgency و expiresAt في الجدول                                |
| 5.1.4 | إحصائيات بسيطة                      | صفحة القائمة أو داشبورد      | عدد الطلبات النشطة، المكتملة، المنتهية (اختياري: رسم بياني بسيط) |

### 5.2 المتبرعون (قراءة فقط – بدون تكامل مستشفيات)

| #     | المهمة                             | الملف                                               | التفاصيل                                                                                          |
| ----- | ---------------------------------- | --------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| 5.2.1 | قائمة المتبرعين                    | صفحة جديدة `Es3afniDonorsPage.tsx` أو تاب في اسعفني | جدول: مستخدم، فصيلة، متاح، آخر تبرع، مدينة (بدون تفاصيل موقع دقيقة حفاظاً على الخصوصية)           |
| 5.2.2 | API الأدمن للمتبرعين               | backend: admin controller لـ es3afni                | GET admin/es3afni/donors مع فلترة (bloodType, available)، بدون تعديل أو حذف (أو تعديل محدود جداً) |
| 5.2.3 | عدم استيراد CSV أو حسابات مستشفيات | —                                                   | لا تطوير لوحة مستشفى ولا رفع CSV (ملغي كما طُلِب)                                                 |

### 5.3 التنبيهات (اختياري للأدمن)

| #     | المهمة                | الملف                 | التفاصيل                                                   |
| ----- | --------------------- | --------------------- | ---------------------------------------------------------- |
| 5.3.1 | عرض تنبيهات بلاغ معين | في صفحة تفاصيل البلاغ | قائمة DonorAlerts للطلب: من أُرسل له، هل تم التسليم، الوقت |

---

## ترتيب التنفيذ المقترح

1. **Backend (أساسي):** 1.1–1.4 (حقول الطلب + كيانات المتبرع والتنبيهات) → 1.5 (خدمة المتبرعين + nearby + تنبيه عند النشر) → 1.6 (إصلاح my/search والفلترة) → 1.7 (انتهاء 48 ساعة).
2. **Backend (اختياري):** 1.8 (تحقق الهاتف)، 2.x (محادثة الطلب).
3. **app-user:** 3.1 (تحسينات الطلبات) → 3.2 (سجل المتبرعين) → 3.3–3.4 (أزرار وتنقل).
4. **bthwani-web:** 4.1–4.4 بالتوازي أو بعد app-user.
5. **admin-dashboard:** 5.1 (طلبات) → 5.2 (قائمة متبرعين قراءة فقط) → 5.3 إن رغبت.

---

## ملخص الـ APIs المستهدفة (Backend)

| Method | المسار                 | الوصف                                              |
| ------ | ---------------------- | -------------------------------------------------- |
| POST   | /es3afni               | إنشاء طلب (مع urgency، وحساب expiresAt عند النشر)  |
| GET    | /es3afni               | قائمة مع فلترة: cursor, bloodType, status, urgency |
| GET    | /es3afni/my            | بلاغاتي (قبل :id)                                  |
| GET    | /es3afni/search        | بحث q, bloodType, status, cursor (قبل :id)         |
| GET    | /es3afni/:id           | تفاصيل طلب                                         |
| PATCH  | /es3afni/:id           | تحديث طلب                                          |
| DELETE | /es3afni/:id           | حذف طلب                                            |
| GET    | /es3afni/donors/nearby | متبرعون قريبون (lat, lng, radiusKm, bloodType)     |
| GET    | /es3afni/donors/me     | ملف المتبرع الحالي                                 |
| POST   | /es3afni/donors/me     | تسجيل كمتبرع                                       |
| PATCH  | /es3afni/donors/me     | تحديث ملف المتبرع (توفر، آخر تبرع، موقع)           |
| GET    | /admin/es3afni         | قائمة طلبات مع فلترة urgency و expiresAt           |
| GET    | /admin/es3afni/donors  | قائمة متبرعين (قراءة فقط، بيانات محدودة)           |

---

## ملاحظات

- **تكامل المستشفيات:** غير مشمول في هذه الخطة (لا لوحة مستشفى، لا CSV، لا حسابات Role 6 خاصة بمستشفيات).
- **الخصوصية:** بيانات المتبرعين (موقع دقيق، اسم) لا تُعرض للجميع؛ للمطابقة والإشعارات فقط، وللأدمن عرض محدود (مثل المدينة).
- **الإشعارات:** يعتمد على وجود خدمة إشعارات (FCM/SMS) في المشروع؛ إن لم تكن جاهزة يمكن تأجيل إرسال التنبيهات الفعلية والاكتفاء بحفظ DonorAlert فقط.
