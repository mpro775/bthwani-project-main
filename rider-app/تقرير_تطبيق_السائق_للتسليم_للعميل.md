# تقرير تطبيق السائق (تطبيق الكابتن) — للتسليم للعميل

**اسم التطبيق:** تطبيق الكابتن (رider-app)  
**الإصدار:** 1.0.1  
**التاريخ:** فبراير 2025  
**المنصة:** Android / iOS (Expo - React Native)

---

## 1. نظرة عامة

تطبيق السائق هو تطبيق موبايل مخصّص لسائقي ومنفذي التوصيل في منظومة بثواني. يتيح للسائق تسجيل الدخول برقم الهاتف، استلام الطلبات، إدارة المحفظة والأرباح، والتفاعل مع خدمات أماني (نقل نسائي)، معروف (المفقودات والموجودات)، وأخدمني (مهام توصيل)، بالإضافة إلى الملف الشخصي والإجازات والدعم الفني.

---

## 2. هيكل التطبيق والتنقل

### 2.1 قبل تسجيل الدخول
- **شاشة تسجيل الدخول** `(auth)/login`
  - إدخال **رقم الهاتف** (9 أرقام، يبدأ بـ 77 أو 78 أو 71 أو 73)
  - إدخال **كلمة المرور**
  - زر "تسجيل الدخول"
  - واجهة عربية مع خط القاهرة (Cairo)

### 2.2 بعد تسجيل الدخول (منطقة السائق)
جميع الشاشات التالية محمية: إذا لم يكن السائق مسجلاً يتم التوجيه إلى شاشة تسجيل الدخول.

---

## 3. الشاشات والعمليات المُبرمجة

### 3.1 الصفحة الرئيسية (لوحة التحكم)
**المسار:** `(driver)/home`

- **تبويبات (ثلاثة):**
  1. **طلباتي** — قائمة الطلبات المعينة للسائق مع:
     - رقم الطلب، الحالة، العنوان، السعر
     - زر "إنهاء الطلب"
     - زر "نداء طوارئ (SOS)"
  2. **محفظتي** — عرض مختصر للمحفظة (يُحمّل من نفس شاشة المحفظة)
  3. **حسابي** — عرض مختصر للملف الشخصي (نفس شاشة الحساب)

- **في الهيدر:**
  - زر تحديث (سحب للتحديث)
  - مفتاح **متاح / غير متاح** لتحديث حالة توفر السائق على السيرفر

---

### 3.2 الطلبات (التوصيل العام)
**المسار:** `(driver)/orders`

- عرض قائمة الطلبات المعينة للسائق
- فلترة حسب نوع السائق: `rider_driver` (توصيل) / `light_driver` (كنز) / `women_driver` (أماني)
- لكل طلب: رقم، حالة، عنوان، سعر
- إجراء "تم التوصيل" (إكمال الطلب)
- زر نداء طوارئ (SOS)

**تفاصيل الطلب:** `(driver)/orders/[id]`  
- شاشة تفاصيل الطلب حسب المعرّف (هيكل جاهز لربط API تفاصيل الطلب لاحقاً)

---

### 3.3 العروض (طلبات متاحة للقبول)
**المسار:** `(driver)/offers`

- قائمة العروض/الطلبات المتاحة للاستلام
- لكل عرض: اسم العميل، عنوان الاستلام، عنوان التسليم، السعر، المسافة، الوقت التقديري
- زر "قبول العرض" لربط الطلب بالسائق
- سحب للتحديث

---

### 3.4 المحفظة والأموال
**المسار:** `(driver)/wallet`

- **ملخص المحفظة:**
  - الرصيد الحالي
  - إجمالي الأرباح، أرباح اليوم، أرباح الأسبوع، أرباح الشهر
  - المدفوعات المعلقة
- قائمة **آخر 5 معاملات**
- أزرار:
  - **طلب سحب** → الانتقال لشاشة السحب
  - **سجل المعاملات** → الانتقال لشاشة المعاملات

**سجل المعاملات:** `(driver)/transactions`

- قائمة المعاملات مع pagination (cursor)
- فلترة حسب: النوع (credit/debit)، الحالة، الطريقة
- عرض تفاصيل كل معاملة (المبلغ، النوع، الحالة، التاريخ)

**طلب سحب:** `(driver)/withdraw/index`

- اختيار طريقة السحب من القائمة (مثلاً: تحويل بنكي، وكيل)
- إدخال المبلغ وبيانات الحساب (اسم البنك، رقم الحساب، اسم صاحب الحساب، أو رمز الوكيل)
- إرسال طلب السحب
- عرض **سجل طلبات السحب** (قائمة + إمكانية إلغاء طلب معلق)

**سجل السحوبات (بديل):** `(driver)/withdraw/history`

- قائمة طلبات السحب السابقة
- نموذج طلب سحب إضافي (مبلغ، طريقة، بيانات الحساب)

---

### 3.5 أماني (النقل النسائي)
**المسار:** `(driver)/amani` — قائمة أماني

- **تبويبان:**
  - **طلبات متاحة** — طلبات أماني التي يمكن للسائقة قبولها
  - **طلباتي** — الطلبات المعينة للسائقة
- قبول طلب من "متاحة" → يُنقل لـ "طلباتي"
- إشعار فوري (عبر WebSocket) عند تعيين طلب جديد للسائقة
- الانتقال لتفاصيل الطلب

**تفاصيل طلب أماني:** `(driver)/amani/[id]`

- عرض تفاصيل الطلب (نقاط الانطلاق والوصول، الحالة، الملاحظات)
- تحديث حالة الطلب (مثلاً: بدء الرحلة، إنهاء الرحلة)

---

### 3.6 معروف (المفقودات والموجودات — مهام التوصيل)
**المسار:** `(driver)/maarouf`

- قائمة مهام التوصيل الخاصة بمعروف (إعلانات مفقودات/موجودات مع طلب توصيل)
- عرض العناصر مع التفاصيل المناسبة

**تفاصيل مهمة معروف:** `(driver)/maarouf/[id]`

- تفاصيل المهمة
- إدخال رمز الاستلام (OTP) لإطلاق المكافأة للمستلم عند التسليم

---

### 3.7 أخدمني (مهام التوصيل / الشحن)
**المسار:** `(driver)/errands`

- قائمة مهام السائق في خدمة أخدمني
- عرض حالة كل مهمة (قيد التنفيذ، مكتملة، إلخ)

**تفاصيل مهمة أخدمني:** `(driver)/errands/[id]`

- تفاصيل المهمة
- تحديث حالة المهمة (مثلاً: في الطريق، تم التسليم)

---

### 3.8 الملف الشخصي والحساب
**المسار:** `(driver)/profile`

- عرض وتعديل:
  - الاسم الكامل
  - البريد الإلكتروني
  - رقم الهاتف
  - نوع المركبة (دراجة، سيارة، موتور)
  - فئة وقوة المركبة (إن وُجدت)
- إحصائيات: التقييم، عدد الرحلات، نسبة اكتمال الملف، المستندات المعتمدة
- أزرار:
  - **حفظ التعديلات**
  - **تغيير كلمة المرور** → الانتقال لشاشة تغيير كلمة المرور
  - **حذف الحساب** (مع تأكيد مزدوج)

**تغيير كلمة المرور:** `(driver)/change-password`

- إدخال كلمة المرور القديمة
- إدخال كلمة المرور الجديدة وتأكيدها
- التحقق: 6 أحرف على الأقل، وتطابق حقل التأكيد
- إرسال الطلب للسيرفر

---

### 3.9 الإجازات
**المسار:** `(driver)/vacations`

- قائمة طلبات الإجازة (مع الحالة: معلق، موافق عليه، مرفوض)
- نموذج **طلب إجازة جديد**: تاريخ البداية، تاريخ النهاية، السبب
- إرسال الطلب وتحديث القائمة
- سحب للتحديث

---

### 3.10 المواقع (عناوين السائق)
**المسار:** `(driver)/locations`

- إضافة موقع حالي: إدخال "تسمية" (مثلاً: منزلي)، ثم حفظ الموقع الحالي عبر GPS
- قائمة المواقع المحفوظة
- حذف موقع من القائمة

---

### 3.11 نداء الطوارئ (SOS)
**مكوّن:** يُستخدم من شاشات الطلبات والرئيسية

- عند الضغط على "نداء طوارئ":
  - طلب صلاحية الموقع إن لم تكن ممنوحة
  - قراءة الموقع الحالي
  - إرسال طلب `POST /drivers/sos` مع الرسالة والموقع
  - إظهار تنبيه للمستخدم بتأكيد الإرسال أو فشله

---

### 3.12 الدعم الفني
**الشاشة:** `SupportScreen` (قابلة للربط من القائمة أو الإعدادات)

- قائمة تذاكر الدعم الخاصة بالسائق
- إنشاء تذكرة جديدة: (الموضوع، الوصف، التصنيف)
- إضافة رد على تذكرة
- تقييم التذكرة عند الإغلاق

---

### 3.13 شاشات حسب نوع السائق

- **أماني (النقل النسائي):** `(driver)/women`
  - روابط سريعة: رحلاتي (طلبات نسائي)، طلبات أماني، الرصيد، الإعدادات

- **كنز (التوصيل الخفيف):** `(driver)/kanz`
  - روابط سريعة: الطلبات (بنوع light_driver)، مهام توصيل كنز، المحفظة، الحساب

---

### 3.14 نقطة الدخول الافتراضية بعد Login
- **الصفحة الرئيسية:** `(driver)/home` (لوحة التحكم بالتبويبات: طلباتي، محفظتي، حسابي)

---

## 4. المصادقة والأمان

- **تسجيل الدخول:** رقم الهاتف + كلمة المرور عبر `POST /auth/driver/login`
- **التوكن:** يُحفظ في **Expo SecureStore** (لا يُخزّن في تخزين عادي)
- **بيانات الجلسة:** حفظ التوكن وبيانات السائق (مثل الاسم والدور) واستعادتهما عند فتح التطبيق
- **تسجيل الخروج:** مسح التوكن والبيانات من SecureStore وإعادة التوجيه لشاشة تسجيل الدخول

---

## 5. الإشعارات (Push Notifications)

- **تسجيل جهاز السائق:** إرسال **Expo Push Token** إلى السيرفر عبر `POST /drivers/push-token` (بعد تسجيل الدخول)
- **قنوات Android:** قناتان (تحديثات الطلبات، تعيين الطلبات) مع صوت افتراضي
- **التوجيه عند الضغط:** عند الضغط على إشعار طلب، يتم التوجيه لشاشة تفاصيل الطلب (مثلاً OrderDetails أو الطلب المعيّن)

---

## 6. التكامل مع الباك إند (API)

جميع الطلبات تستخدم الأساس: `https://api.bthwani.com/api/v1` مع رأس `Authorization: Bearer <token>`.

### 6.1 المصادقة
- `POST /auth/driver/login` — تسجيل دخول السائق (هاتف + كلمة مرور)

### 6.2 السائق
- `GET /drivers/me` — بيانات السائق الحالي
- `GET /drivers/profile` — الملف الشخصي
- `PATCH /drivers/profile` — تحديث الملف
- `POST /drivers/change-password` — تغيير كلمة المرور
- `PATCH /drivers/availability` — تحديث حالة التوفر (متاح/غير متاح)
- `POST /drivers/locations` — إضافة موقع
- `GET /drivers/me` (otherLocations) — جلب المواقع
- `DELETE /drivers/locations/:index` — حذف موقع
- `POST /drivers/sos` — نداء طوارئ
- `POST /drivers/push-token` — تسجيل جهاز للإشعارات

### 6.3 الطلبات والعروض
- `GET /drivers/orders/available` — الطلبات المتاحة
- `POST /drivers/orders/:id/accept` — قبول طلب
- `POST /drivers/orders/:id/reject` — رفض طلب
- `POST /drivers/orders/:id/start-delivery` — بدء التوصيل
- `POST /drivers/orders/:id/complete` — إتمام التوصيل
- `GET /drivers/orders/history` — سجل الطلبات
- (عروض: listOffers / acceptOffer حسب تنفيذ الباك إند)

### 6.4 المحفظة (v1)
- `GET /wallet/balance` — رصيد المحفظة
- `GET /wallet/transactions` — سجل المعاملات
- `GET /wallet/transaction/:id` — تفاصيل معاملة
- `GET /wallet/withdraw/methods` — طرق السحب
- `POST /wallet/withdraw/request` — طلب سحب
- `GET /wallet/withdraw/my` — طلبات السحب الخاصة بي
- `PATCH /wallet/withdraw/:id/cancel` — إلغاء طلب سحب

### 6.5 أرباح وإحصائيات السائق
- `GET /drivers/earnings` — الأرباح (اختياري: تاريخ بداية/نهاية)
- `GET /drivers/statistics` — إحصائيات السائق
- (ملخص المحفظة قد يُجمَع من أكثر من مصدر حسب تنفيذ الباك إند)

### 6.6 أماني
- `GET /amani` — قائمة طلبات أماني (متاحة حسب الصلاحيات)
- `GET /amani/driver/my-orders` — طلباتي كسائقة أماني
- `POST /amani/:id/accept` — قبول طلب أماني
- `PATCH /amani/:id/status` — تحديث حالة الطلب
- `GET /amani/:id` — تفاصيل طلب أماني

### 6.7 معروف
- `GET /maarouf/deliveries/list` — قائمة مهام التوصيل (معروف)
- `GET /maarouf/:id` — تفاصيل إعلان/مهمة
- `GET /maarouf/:id/reward-holds` — حجوزات المكافآت
- `POST /maarouf/:id/reward-hold/:holdId/verify-code` — التحقق من رمز الاستلام وإطلاق المكافأة

### 6.8 أخدمني
- `GET /akhdimni/driver/my-errands` — مهماتي كسائق
- `PATCH /akhdimni/errands/:id/status` — تحديث حالة المهمة
- `GET /akhdimni/errands/:id` — تفاصيل مهمة

### 6.9 الإجازات
- `POST /drivers/vacations/request` — طلب إجازة
- `GET /drivers/vacations/my` — قائمة إجازاتي
- `GET /drivers/vacations/balance` — رصيد الإجازات
- `PATCH /drivers/vacations/:id/cancel` — إلغاء طلب إجازة

### 6.10 الدعم الفني
- `POST /support/tickets` — إنشاء تذكرة
- `GET /support/tickets` — تذاكري
- `GET /support/tickets/:id` — تفاصيل تذكرة
- `PATCH /support/tickets/:id/messages` — إضافة رد
- `PATCH /support/tickets/:id/rate` — تقييم التذكرة

---

## 7. التقنيات المستخدمة

- **الإطار:** Expo (React Native)
- **اللغة:** TypeScript
- **التنقل:** expo-router (ملفات = مسارات)
- **الحالة والمصادقة:** React Context (AuthContext) + SecureStore
- **الشبكة:** Axios (instance موحّد مع baseURL و Bearer token)
- **الخرائط والموقع:** expo-location
- **الإشعارات:** expo-notifications + تسجيل التوكن على السيرفر
- **الخطوط:** Cairo (عربي)
- **الواجهة:** مكوّنات React Native (View, Text, TextInput, TouchableOpacity, FlatList, ScrollView, إلخ) مع أنماط مخصّصة وألوان من `constants/colors`
- **WebSocket (أماني):** للاستماع لتعيينات الطلبات الفورية

---

## 8. ما تم تسليمه للعميل (ملخص)

| الفئة | المضمون |
|-------|---------|
| **تسجيل الدخول** | شاشة دخول بالهاتف وكلمة المرور، حماية المسارات، حفظ الجلسة بشكل آمن |
| **لوحة التحكم** | تبويبات: طلباتي، محفظتي، حسابي + تحديث التوفر |
| **الطلبات** | قائمة طلبات، إكمال طلب، نداء طوارئ، تفاصيل طلب (هيكل) |
| **العروض** | قائمة عروض، قبول عرض |
| **المحفظة** | رصيد، أرباح (يومي/أسبوعي/شهري)، معاملات، سحب، سجل سحوبات |
| **أماني** | قائمة متاحة/طلباتي، قبول، تفاصيل، تحديث حالة، إشعار فوري (WebSocket) |
| **معروف** | قائمة مهام توصيل، تفاصيل، التحقق من رمز الاستلام للمكافأة |
| **أخدمني** | قائمة مهام، تفاصيل، تحديث حالة المهمة |
| **الملف الشخصي** | عرض وتعديل البيانات، تغيير كلمة المرور، حذف الحساب |
| **الإجازات** | طلب إجازة، قائمة إجازاتي |
| **المواقع** | إضافة موقع حالي، قائمة مواقع، حذف |
| **SOS** | إرسال موقع ورسالة طوارئ للسيرفر |
| **الدعم الفني** | تذاكر، إنشاء تذكرة، ردود، تقييم |
| **الإشعارات** | تسجيل الجهاز، استقبال إشعارات، توجيه لتفاصيل الطلب |
| **حسب نوع السائق** | شاشات اختصار لأماني وكنز |

---

## 9. ملاحظات للتشغيل والتسليم

- **البيئة:** التأكد من أن المتغيرات أو إعدادات الـ build تشير إلى الـ API الصحيح (مثلاً `https://api.bthwani.com/api/v1`).
- **الإشعارات:** تحتاج مشروع Expo (EAS) وربط `google-services.json` لـ Android وتهيئة iOS إن لزم.
- **الاختبار:** يُفضّل اختبار تسجيل الدخول، الطلبات، المحفظة، أماني، معروف، وأخدمني على بيئة تشغيلية أو staging قبل التسليم النهائي.

---

*تم إعداد هذا التقرير بناءً على هيكل وتدفقات تطبيق السائق (rider-app) الحالية ليكون مستند تسليم واضح للعميل.*
