# خطة توافق تطبيق المسوقين الميدانيين مع الباك إند

هذه الخطة لمعالجة النواقص والتعارضات بين تطبيق **field-marketers** ووحدتي **marketer** و **onboarding** في **backend-nest**.

---

## المرحلة 1: المصادقة (Auth)

| #   | المهمة                                         | الملف / الموقع                                     | التفاصيل                                                                                                                                  |
| --- | ---------------------------------------------- | -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| 1.1 | إضافة `POST /auth/marketer-login`              | `backend-nest/src/modules/auth/auth.controller.ts` | استقبال `email` + `password`، التحقق من مستخدم بدور مسوق (أو من جدول المسوقين)، إرجاع Marketer JWT + `{ user: { id, fullName, email } }`. |
| 1.2 | إضافة `GET /auth/me` للمسوق                    | `backend-nest/src/modules/auth/auth.controller.ts` | يقبل **Marketer JWT** فقط، يرجع بيانات المستخدم الحالي (أو توجيه التطبيق لاستخدام `GET /marketer/profile` بدلاً منه).                     |
| 1.3 | (اختياري) إضافة `POST /auth/push-token` للمسوق | نفس الوحدة                                         | إن كان التطبيق يرسل Expo push token؛ التأكد من ربطه بحساب المسوق.                                                                         |

---

## المرحلة 2: وحدة Marketer — إصلاحات سريعة

| #   | المهمة                                     | الملف / الموقع                                             | التفاصيل                                                                                                 |
| --- | ------------------------------------------ | ---------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| 2.1 | إعادة تفعيل `GET /marketer/commissions/my` | `backend-nest/src/modules/marketer/marketer.controller.ts` | إضافة route يستدعي `marketerService.getMyCommissions(marketerId, status)` مع `@Query('status') status?`. |
| 2.2 | توحيد حقل الاسم في تحديث الملف             | `marketer.controller.ts` + `marketer.service.ts`           | قبول `fullName` أو `name` في body الـ PATCH وتحويله إلى `fullName` في الـ entity عند التحديث.            |

---

## المرحلة 3: Onboarding — المسارات والبادئة

اختر **أحد** الخيارين:

### خيار أ: توحيد المسارات تحت `/marketer/onboarding` في الباك إند (موصى به)

| #   | المهمة                                   | الملف / الموقع                                                   | التفاصيل                                                                                                                                                                                                                                                           |
| --- | ---------------------------------------- | ---------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 3.1 | نقل/تكرار routes الانضمام تحت Marketer   | `marketer.controller.ts` أو controller فرعي تحت بادئة `marketer` | تعريف: `POST /marketer/onboarding`, `GET /marketer/onboarding/my`, `GET /marketer/onboarding/:id`, `PATCH /marketer/onboarding/:id`, `POST /marketer/onboarding/:id/submit`, `POST /marketer/quick-onboard`. استدعاء منطق من OnboardingService أو MarketerService. |
| 3.2 | إبقاء منطق الانضمام في OnboardingService | `backend-nest/src/modules/onboarding/`                           | إنشاء OnboardingService إن لم يكن موجوداً، ونقل كل منطق الحفظ والقراءة من MarketerService (getApplications, getApplicationDetails، إنشاء من body، إلخ) إليه. استدعاؤه من MarketerController أو من OnboardingController حسب الخيار.                                 |

### خيار ب: الإبقاء على `/onboarding` وتعديل التطبيق فقط

| #   | المهمة                             | الملف / الموقع                      | التفاصيل                                                                                                                                                                                               |
| --- | ---------------------------------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 3.1 | تحديث مسارات التطبيق               | `field-marketers/src/api/routes.ts` | استبدال `/marketer/onboarding` بـ `/onboarding` و `/marketer/quick-onboard` بـ `/onboarding/quick-onboard`.                                                                                            |
| 3.2 | إضافة routes ناقصة في الباك للمسوق | `onboarding.controller.ts`          | إضافة `GET /onboarding/:id` (للمسوق، بصلاحية Marketer JWT فقط — التأكد أن الطلب يخص المسوق الحالي). إضافة `PATCH /onboarding/:id` و `POST /onboarding/:id/submit` إن كان المفهوم يدعم المسودات والرفع. |

---

## المرحلة 4: Onboarding — ربط الـ Controller بالبيانات

| #   | المهمة                             | الملف / الموقع                                                           | التفاصيل                                                                                                                           |
| --- | ---------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| 4.1 | ربط إنشاء الطلب بقاعدة البيانات    | `onboarding.controller.ts` + خدمة (OnboardingService أو MarketerService) | استدعاء خدمة تنشئ وثيقة في مجموعة `onboardings` من الـ body (بعد تطبيع الحقول)، وترجع `{ success, data: { _id, ... }, message }`.  |
| 4.2 | ربط `GET my` بالبيانات الحقيقية    | نفس الوحدة                                                               | استدعاء خدمة تجلب الطلبات حسب `marketerId` مع دعم `status`, `page`, `limit`, `from`, `to` وترجع `{ items, pagination }` أو مصفوفة. |
| 4.3 | ربط `POST quick-onboard` بالحفظ    | نفس الوحدة                                                               | حفظ طلب انضمام سريع (الحد الأدنى: phone, storeName, location + marketerId) في DB وترجيع الطلب المُنشأ.                             |
| 4.4 | تنفيذ `GET /onboarding/:id` للمسوق | نفس الوحدة                                                               | جلب طلب واحد مع التحقق أن `marketer` يطابق المسوق الحالي، وترجيع تفاصيل الطلب.                                                     |

---

## المرحلة 5: Onboarding — توحيد الحقول والـ DTOs

| #   | المهمة                                             | الملف / الموقع                                                | التفاصيل                                                                                                                                                                                                                                    |
| --- | -------------------------------------------------- | ------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 5.1 | تعريف DTO لإنشاء طلب انضمام                        | `backend-nest/src/modules/onboarding/dto/` أو `marketer/dto/` | توثيق/إنشاء: `storeName`, `ownerName`, `phone`, `email?`, `address: { street?, city?, district?, location: { lat, lng } }`, `type: 'store' \| 'vendor' \| 'driver'`. إضافة حقول اختيارية (مثل categoryId, imageUrl) إن وُجدت في الـ entity. |
| 5.2 | تطبيع طلبات التطبيق في الباك أو توحيدها في التطبيق | تطبيق أو باك                                                  | إما: (أ) الباك يقبل شكل التطبيق (storeDraft.name → storeName، ownerDraft.fullName → ownerName) ويحفظ ما يلزم، أو (ب) التطبيق يرسل نفس شكل الباك (storeName, ownerName, address, type) عند الإنشاء والـ quick-onboard.                       |
| 5.3 | حالات الطلب (status)                               | entity + تطبيق                                                | إما إضافة `draft`, `submitted`, `needs_fix` إلى الـ entity والـ API، أو توحيد التطبيق على `pending` فقط قبل الاعتماد.                                                                                                                       |
| 5.4 | دعم query في GET my                                | `getMyOnboardings`                                            | إضافة `@Query() page?, limit?, from?, to?` واستخدامها في الاستعلام والترقيم.                                                                                                                                                                |

---

## المرحلة 6: تطبيق المسوق (field-marketers)

| #   | المهمة                                     | الملف / الموقع                                                      | التفاصيل                                                                                                                                                                                                               |
| --- | ------------------------------------------ | ------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 6.1 | تعريف endpoints الناقصة في routes          | `field-marketers/src/api/routes.ts`                                 | إضافة `ONB_UPDATE(id)` و `ONB_SUBMIT(id)` ليطابقا المسارات في الباك (مثلاً `PATCH /marketer/onboarding/:id` و `POST /marketer/onboarding/:id/submit` أو `/onboarding/...` حسب الخيار في المرحلة 3).                    |
| 6.2 | تصحيح استدعاء الـ quick onboard            | `field-marketers/src/screens/onboarding/OnboardingWizardScreen.tsx` | استبدال `POST /field/quick-onboard` بـ `ENDPOINTS.QUICK_ONBOARD` (أي `/marketer/quick-onboard` أو `/onboarding/quick-onboard`) وتشكيل الـ payload ليطابق body الباك (مثلاً `phone`, `storeName`, `location` كحد أدنى). |
| 6.3 | (بديل لـ /auth/me) التحقق من الجلسة بالملف | `field-marketers/src/context/AuthContext.tsx`                       | إن لم يُضف الباك `GET /auth/me` للمسوق: استدعاء `GET /marketer/profile` عند التحقق من التوكن واستخدام الاستجابة كـ user في الـ context.                                                                                |

---

## المرحلة 7: اختياري — تحسينات

| #   | المهمة                                             | الملف / الموقع                                                    | التفاصيل                                                                                       |
| --- | -------------------------------------------------- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------- |
| 7.1 | إضافة rejectedBy و rejectedAt في Onboarding entity | `backend-nest/src/modules/marketer/entities/onboarding.entity.ts` | إن كان الـ service يحدّثهما؛ إضافتهما في الـ schema لضمان توثيق البيانات.                      |
| 7.2 | توثيق الاستجابات في Swagger                        | الـ controllers المعنية                                           | توثيق شكل الاستجابة (مثلاً قائمة الطلبات، عنصر طلب واحد، إحصائيات) لسهولة المزامنة مع التطبيق. |

---

## ترتيب التنفيذ المقترح

1. **المرحلة 1** (Auth) — حتى يعمل تسجيل الدخول والتحقق من الجلسة.
2. **المرحلة 2** (Marketer) — إصلاح عمولاتي وتحديث الملف.
3. **المرحلة 3 + 4** (Onboarding مسارات + ربط بالبيانات) — حتى تُحفظ طلبات الانضمام وتُعرض قائمة الطلبات وتفاصيل الطلب.
4. **المرحلة 5** (حقول و DTOs) — توحيد الـ body والـ status والـ query.
5. **المرحلة 6** (تطبيق المسوق) — تصحيح المسارات والـ payload والـ routes الناقصة.
6. **المرحلة 7** (اختياري) — عند الحاجة.

---

## ملخص سريع للنواقص المعالجة

| النقص / التعارض                                                      | الحل في الخطة           |
| -------------------------------------------------------------------- | ----------------------- |
| لا يوجد `POST /auth/marketer-login`                                  | المرحلة 1.1             |
| لا يوجد `GET /auth/me` للمسوق                                        | المرحلة 1.2 أو 6.3      |
| لا يوجد `GET /marketer/commissions/my`                               | المرحلة 2.1             |
| تعارض name / fullName في الملف                                       | المرحلة 2.2             |
| مسارات الانضمام تحت /marketer/... في التطبيق بينما الباك /onboarding | المرحلة 3 (خيار أ أو ب) |
| عدم حفظ طلبات الانضمام أو جلبها من DB                                | المرحلة 4               |
| عدم وجود GET :id و PATCH :id و POST :id/submit للمسوق                | المرحلة 3 + 4.4         |
| التطبيق يستدعي /field/quick-onboard                                  | المرحلة 6.2             |
| تعارض شكل الـ body والحقول والـ status                               | المرحلة 5               |
| ONB_UPDATE و ONB_SUBMIT غير معرّفة في التطبيق                        | المرحلة 6.1             |

---

_آخر تحديث: بناءً على مراجعة وحدتي marketer و onboarding وتطبيق field-marketers._
