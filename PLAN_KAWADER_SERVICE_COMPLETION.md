# خطة إكمال خدمة كوادر – الوظائف والخدمات المهنية (V3)

هذه الخطة لإكمال **خدمة كوادر** (الوظائف والخدمات المهنية) وفق مواصفات V3 – Jobs & Services في وثائق التسليم، وربطها بشكل صحيح بين:

- **الخادم** (backend-nest)
- **تطبيق المستخدم** (app-user)
- **الموقع** (bthwani-web)
- **لوحة التحكم** (admin-dashboard)

---

## الوضع الحالي vs الهدف (ملخص)

| الجانب                               | الوضع الحالي                                                             | الهدف (V3)                                                                 |
| ------------------------------------ | ------------------------------------------------------------------------ | -------------------------------------------------------------------------- |
| **عروض الوظائف/الخدمات**             | كيان واحد Kawader (عنوان، وصف، نطاق، ميزانية، metadata)                  | تمييز نوع العرض (وظيفة / عرض خدمة) + حقول صريحة: jobType، location، salary |
| **بلاغاتي / بحث**                    | التطبيق يستدعي `/kawader/my` و `/kawader/search` لكن الباكند لا يوفّرهما | تنفيذ GET my و GET search وترتيب المسارات قبل `:id`                        |
| **التقديم على الوظيفة**              | محادثة فقط (kawader-chat) بدون طلب رسمي                                  | كيان **Application** (jobId، userId، coverNote، status) + زر "تقدم الآن"   |
| **معرض الأعمال (Portfolio)**         | غير موجود                                                                | كيان Portfolio (user، mediaIds، caption) + واجهات رفع وعرض                 |
| **التقييمات والمراجعات**             | غير موجود                                                                | كيان Review + متوسط تقييم لمقدم الخدمة                                     |
| **تقويم الحجوزات**                   | غير موجود                                                                | (مرحلة لاحقة) slots وربط بحجوزات الخدمات                                   |
| **ملف المستقل (Freelancer Profile)** | غير منفصل                                                                | صفحة تعرض عروض المستقل + معرضه + تقييماته                                  |

---

## المرحلة 1: Backend – إصلاح المسارات وتنفيذ my و search

### 1.1 ترتيب المسارات وتنفيذ GET my

| #     | المهمة          | الملف                   | التفاصيل                                                                                               |
| ----- | --------------- | ----------------------- | ------------------------------------------------------------------------------------------------------ |
| 1.1.1 | ترتيب المسارات  | `kawader.controller.ts` | وضع `@Get('my')` و `@Get('search')` **قبل** `@Get(':id')` حتى لا يُفسَّر my/search كـ id               |
| 1.1.2 | تنفيذ GET my    | `kawader.service.ts`    | دالة `findMy(userId, cursor?, limit?)`: استعلام حيث `ownerId = userId` مع cursor pagination            |
| 1.1.3 | endpoint GET my | `kawader.controller.ts` | `GET /kawader/my` — يستخرج المستخدم الحالي من الـ guard ويرسل لـ findMy؛ إرجاع `{ items, nextCursor }` |

### 1.2 تنفيذ GET search

| #     | المهمة                | الملف                   | التفاصيل                                                                                                                          |
| ----- | --------------------- | ----------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| 1.2.1 | بحث نصي في الخدمة     | `kawader.service.ts`    | دالة `search(opts)`: فلترة حسب `q` (نص في title أو description أو metadata.skills)، وstatus، وbudgetMin/Max، مع cursor pagination |
| 1.2.2 | endpoint GET search   | `kawader.controller.ts` | `GET /kawader/search?q=...&status=...&cursor=...` — استدعاء search مع query params                                                |
| 1.2.3 | فهرسة للبحث (اختياري) | `kawader.entity.ts`     | فهرس نصي على title و description إن دعت الحاجة لأداء أفضل                                                                         |

### 1.3 تأمين الـ endpoints (صلاحيات)

| #     | المهمة                            | الملف                              | التفاصيل                                                                 |
| ----- | --------------------------------- | ---------------------------------- | ------------------------------------------------------------------------ |
| 1.3.1 | التحقق من المستخدم في my          | `kawader.controller.ts`            | GET my يتطلب مصادقة؛ استخدام CurrentUser أو guard لاستخراج userId        |
| 1.3.2 | التحقق من المالك في update/delete | `kawader.service.ts` أو controller | عند PATCH/DELETE التحقق أن `doc.ownerId` يساوي المستخدم الحالي (أو أدمن) |

---

## المرحلة 2: Backend – حقول صريحة للوظائف وتمييز النوع

### 2.1 إضافة حقول في Entity

| #     | المهمة                   | الملف               | التفاصيل                                                                                                            |
| ----- | ------------------------ | ------------------- | ------------------------------------------------------------------------------------------------------------------- |
| 2.1.1 | إضافة `offerType`        | `kawader.entity.ts` | `@Prop({ enum: ['job','service'], default: 'job' }) offerType?: 'job' \| 'service'` — تمييز إعلان وظيفة عن عرض خدمة |
| 2.1.2 | إضافة `jobType`          | `kawader.entity.ts` | `@Prop({ enum: ['full_time','part_time','remote'], default: null }) jobType?: string` — للوظائف فقط                 |
| 2.1.3 | إضافة `location`         | `kawader.entity.ts` | `@Prop() location?: string` — مدينة أو منطقة (أو الاحتفاظ بـ metadata.location مع توثيق ثابت)                       |
| 2.1.4 | إضافة `salary` (اختياري) | `kawader.entity.ts` | `@Prop() salary?: number` — للوظائف؛ إن وُجد يستخدم بدل أو بجانب budget حسب المنتج                                  |

### 2.2 تحديث DTOs

| #     | المهمة                                     | الملف                                             | التفاصيل                                                              |
| ----- | ------------------------------------------ | ------------------------------------------------- | --------------------------------------------------------------------- |
| 2.2.1 | إضافة offerType, jobType, location, salary | `create-kawader.dto.ts` و `update-kawader.dto.ts` | كلها اختيارية؛ التحقق بـ @IsOptional و @IsEnum لـ offerType و jobType |
| 2.2.2 | توثيق metadata                             | README أو تعليقات                                 | توحيد استخدام metadata (مثل skills[], experience, remote) في الواجهات |

### 2.3 تحديث الخدمة والفلترة

| #     | المهمة                        | الملف                | التفاصيل                                                  |
| ----- | ----------------------------- | -------------------- | --------------------------------------------------------- |
| 2.3.1 | فلترة حسب offerType و jobType | `kawader.service.ts` | في list و search: دعم query params `offerType`, `jobType` |
| 2.3.2 | فلترة حسب location            | نفس الملف            | دعم `?location=...` أو بحث نصي في location                |

---

## المرحلة 3: Backend – نظام التقديم (Applications)

### 3.1 إنشاء كيان Application

| #     | المهمة                          | الملف                                            | التفاصيل                                                                                                                     |
| ----- | ------------------------------- | ------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| 3.1.1 | إنشاء KawaderApplication entity | `kawader/entities/kawader-application.entity.ts` | حقول: kawaderId (ref Kawader), userId (ref User), coverNote (string), status (enum: pending, accepted, rejected), timestamps |
| 3.1.2 | تسجيل في Module                 | `kawader.module.ts`                              | إضافة KawaderApplication في MongooseModule                                                                                   |
| 3.1.3 | DTOs                            | `dto/apply-kawader.dto.ts`                       | CreateApplyDto: coverNote (optional string)                                                                                  |

### 3.2 خدمة التقديم

| #     | المهمة             | الملف                                                    | التفاصيل                                                                                                          |
| ----- | ------------------ | -------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | -------- |
| 3.2.1 | تقديم على عرض      | `kawader.service.ts` أو `kawader-application.service.ts` | apply(kawaderId, userId, dto): التحقق من وجود Kawader وعدم تقديم المستخدم مسبقاً؛ إنشاء Application بحالة pending |
| 3.2.2 | قائمة تقديمات عرض  | نفس الخدمة                                               | getApplicationsByKawader(kawaderId, ownerId): للمالك فقط؛ إرجاع قائمة التقديمات مع populate user                  |
| 3.2.3 | تقديماتي           | نفس الخدمة                                               | getMyApplications(userId, cursor): قائمة التقديمات التي أرسلها المستخدم مع تفاصيل العرض                           |
| 3.2.4 | تحديث حالة التقديم | نفس الخدمة                                               | updateApplicationStatus(applicationId, ownerId, status): للمالك فقط؛ accepted                                     | rejected |

### 3.3 API التقديم

| #     | المهمة                   | الملف                   | التفاصيل                                                                                             |
| ----- | ------------------------ | ----------------------- | ---------------------------------------------------------------------------------------------------- |
| 3.3.1 | POST apply               | `kawader.controller.ts` | `POST /kawader/:id/apply` — body: { coverNote? }; المستخدم الحالي = مقدم الطلب                       |
| 3.3.2 | GET تطبيقات عرض (للمالك) | نفس الملف               | `GET /kawader/:id/applications` — للمالك فقط؛ إرجاع قائمة التقديمات                                  |
| 3.3.3 | GET تقديماتي             | نفس الملف               | `GET /kawader/applications/my` — قبل :id؛ إرجاع تقديمات المستخدم الحالي                              |
| 3.3.4 | PATCH حالة تقديم         | نفس الملف               | `PATCH /kawader/applications/:appId/status` — body: { status: 'accepted' \| 'rejected' }; للمالك فقط |

### 3.4 ربط المحادثة بالتقديم (اختياري)

| #     | المهمة                            | الملف          | التفاصيل                                                                                                                        |
| ----- | --------------------------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| 3.4.1 | ربط conversation بـ applicationId | `kawader-chat` | عند إنشاء محادثة بعد "تقدم الآن": إنشاء Application أولاً ثم إنشاء المحادثة؛ أو ربط اختياري applicationId في المحادثة للعرض فقط |

---

## المرحلة 4: Backend – معرض الأعمال (Portfolio)

### 4.1 إنشاء كيان Portfolio

| #     | المهمة                        | الملف                                          | التفاصيل                                                                     |
| ----- | ----------------------------- | ---------------------------------------------- | ---------------------------------------------------------------------------- |
| 4.1.1 | إنشاء KawaderPortfolio entity | `kawader/entities/kawader-portfolio.entity.ts` | حقول: userId (ref User), mediaIds (ObjectId[]), caption (string), timestamps |
| 4.1.2 | تسجيل في Module               | `kawader.module.ts`                            | إضافة KawaderPortfolio في MongooseModule                                     |
| 4.1.3 | DTOs                          | `dto/create-portfolio-item.dto.ts`             | mediaIds (array)، caption (optional)                                         |

### 4.2 خدمة ومعارض API

| #     | المهمة            | الملف                                                        | التفاصيل                                                                                                                           |
| ----- | ----------------- | ------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| 4.2.1 | إضافة عنصر معرض   | خدمة portfolio                                               | addPortfolioItem(userId, dto): للمستخدم الحالي فقط                                                                                 |
| 4.2.2 | معرض مستخدم (عام) | نفس الخدمة                                                   | getPortfolioByUser(userId): إرجاع عناصر المعرض مع populate mediaIds                                                                |
| 4.2.3 | حذف عنصر          | نفس الخدمة                                                   | removePortfolioItem(itemId, userId): للمالك فقط                                                                                    |
| 4.2.4 | API endpoints     | `kawader.controller.ts` أو `kawader-portfolio.controller.ts` | `POST /kawader/portfolio`, `GET /kawader/portfolio/me`, `GET /kawader/portfolio/user/:userId`, `DELETE /kawader/portfolio/:itemId` |

---

## المرحلة 5: Backend – التقييمات والمراجعات (Reviews)

### 5.1 إنشاء كيان Review

| #     | المهمة                     | الملف                                       | التفاصيل                                                                                                                                                  |
| ----- | -------------------------- | ------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 5.1.1 | إنشاء KawaderReview entity | `kawader/entities/kawader-review.entity.ts` | حقول: kawaderId (ref Kawader), reviewerId (ref User), revieweeId (ref User — مقدم الخدمة/صاحب العرض), rating (1–5), comment (string optional), timestamps |
| 5.1.2 | تسجيل في Module            | `kawader.module.ts`                         | إضافة KawaderReview في MongooseModule                                                                                                                     |
| 5.1.3 | DTOs                       | `dto/create-review.dto.ts`                  | rating (number 1–5), comment (optional)                                                                                                                   |

### 5.2 خدمة المراجعات

| #     | المهمة               | الملف       | التفاصيل                                                                                                     |
| ----- | -------------------- | ----------- | ------------------------------------------------------------------------------------------------------------ |
| 5.2.1 | إنشاء مراجعة         | خدمة review | create(kawaderId, reviewerId, revieweeId, dto): بعد إتمام التعامل (مثلاً عند status completed أو قبول تطبيق) |
| 5.2.2 | متوسط تقييم مستخدم   | نفس الخدمة  | getAverageRating(revieweeId): متوسط rating لجميع المراجعات على revieweeId                                    |
| 5.2.3 | قائمة مراجعات مستخدم | نفس الخدمة  | getReviewsByUser(revieweeId, cursor): للملف العام للمستقل                                                    |
| 5.2.4 | API                  | controller  | `POST /kawader/:id/review`, `GET /kawader/reviews/user/:userId`, وربط متوسط التقييم في عرض تفاصيل المستقل    |

---

## المرحلة 6: تطبيق المستخدم (app-user)

### 6.1 بلاغاتي وبحث

| #     | المهمة                | الملف                                       | التفاصيل                                                                                        |
| ----- | --------------------- | ------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| 6.1.1 | ربط "عروضي" بـ GET my | `kawaderApi.ts`, `KawaderListScreen` أو تاب | استدعاء getMyKawader() وعرض النتائج في تاب أو شاشة "عروضي"                                      |
| 6.1.2 | شريط بحث وفلترة       | `KawaderListScreen.tsx`                     | حقل بحث يستدعي searchKawader(q, status, cursor)؛ فلاتر: status، نطاق الميزانية، jobType إن وُجد |
| 6.1.3 | تحديث Types و API     | `types/types.ts`, `api/kawaderApi.ts`       | التأكد من دعم الحقول الجديدة (offerType, jobType, location, salary) في الأنواع والـ payloads    |

### 6.2 التقديم على الوظيفة (تقدم الآن)

| #     | المهمة                           | الملف                                    | التفاصيل                                                                                                 |
| ----- | -------------------------------- | ---------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| 6.2.1 | زر "تقدم الآن"                   | `KawaderDetailsScreen.tsx`               | بجانب "تواصل": يفتح نموذجاً أو modal بحقل cover note (رسالة اختيارية) ثم استدعاء POST /kawader/:id/apply |
| 6.2.2 | API التقديم                      | `kawaderApi.ts`                          | applyToKawader(id, coverNote?), getMyApplications(cursor?), getKawaderApplications(id) للمالك            |
| 6.2.3 | شاشة "تقدماتي"                   | `KawaderMyApplicationsScreen.tsx` (جديد) | قائمة التقديمات التي أرسلها المستخدم مع حالة كل تقديم (معلق / مقبول / مرفوض)                             |
| 6.2.4 | للمالك: قائمة التقديمات على عرضي | `KawaderDetailsScreen.tsx` أو شاشة فرعية | زر "عرض التقديمات" يستدعي GET /kawader/:id/applications ويعرض قائمة مع إمكانية قبول/رفض                  |

### 6.3 حقول النوع والموقع والراتب

| #     | المهمة                                   | الملف                                              | التفاصيل                                               |
| ----- | ---------------------------------------- | -------------------------------------------------- | ------------------------------------------------------ |
| 6.3.1 | نوع العرض (وظيفة / خدمة)                 | `KawaderCreateScreen.tsx`, `KawaderEditScreen.tsx` | قائمة أو toggle: إعلان وظيفة / عرض خدمة                |
| 6.3.2 | نوع الوظيفة (دوام كامل / جزئي / عن بُعد) | نفس الملفات                                        | عند اختيار "وظيفة": قائمة jobType                      |
| 6.3.3 | الموقع والراتب                           | نفس الملفات                                        | حقول location و salary (أو توحيد مع budget حسب المنتج) |
| 6.3.4 | عرض في التفاصيل والبطاقة                 | `KawaderDetailsScreen.tsx`, `KawaderCard.tsx`      | عرض jobType، location، salary في الواجهة               |

### 6.4 معرض الأعمال (Portfolio)

| #     | المهمة           | الملف                                                    | التفاصيل                                                                     |
| ----- | ---------------- | -------------------------------------------------------- | ---------------------------------------------------------------------------- |
| 6.4.1 | إدارة معرضي      | `KawaderPortfolioScreen.tsx` (جديد) أو داخل الملف الشخصي | رفع صور/وسائط مع caption؛ استدعاء POST /kawader/portfolio و GET portfolio/me |
| 6.4.2 | عرض معرض المستقل | في تفاصيل العرض أو ملف المستقل                           | عند عرض عرض خدمة: عرض معرض مقدم الخدمة (GET portfolio/user/:userId)          |

### 6.5 التقييمات

| #     | المهمة                        | الملف                           | التفاصيل                                                         |
| ----- | ----------------------------- | ------------------------------- | ---------------------------------------------------------------- |
| 6.5.1 | كتابة مراجعة بعد إتمام        | بعد قبول تقديم أو إغلاق عرض     | نموذج تقييم (1–5 نجوم + تعليق) واستدعاء POST /kawader/:id/review |
| 6.5.2 | عرض التقييمات على ملف المستقل | في تفاصيل العرض أو صفحة المستقل | قائمة مراجعات مع متوسط التقييم (GET reviews/user/:userId)        |

### 6.6 التنقل (Navigation)

| #     | المهمة               | الملف                                           | التفاصيل                                                                    |
| ----- | -------------------- | ----------------------------------------------- | --------------------------------------------------------------------------- |
| 6.6.1 | إضافة مسارات جديدة   | `navigation/index.tsx`, `types/navigation.d.ts` | KawaderMyApplications، KawaderPortfolio، (اختياري) KawaderFreelancerProfile |
| 6.6.2 | روابط من قائمة كوادر | تبويب أو زر في KawaderList                      | "عروضي" → GET my؛ "تقدماتي" → شاشة التقديمات                                |

---

## المرحلة 7: الموقع (bthwani-web)

| #   | المهمة                         | الملف                            | التفاصيل                                                   |
| --- | ------------------------------ | -------------------------------- | ---------------------------------------------------------- |
| 7.1 | دعم my و search                | `features/kawader/api.ts`, hooks | استدعاء GET my و GET search مع نفس الفلاتر                 |
| 7.2 | نوع العرض و jobType و location | `KawaderForm.tsx`, types         | إضافة الحقول في النموذج والعرض                             |
| 7.3 | تقدم الآن ومعرض وتقييمات       | حسب توفر الـ API                 | زر تقدم الآن، عرض معرض المستخدم، عرض التقييمات في التفاصيل |

---

## المرحلة 8: لوحة التحكم (admin-dashboard)

| #   | المهمة                        | الملف                             | التفاصيل                                                                              |
| --- | ----------------------------- | --------------------------------- | ------------------------------------------------------------------------------------- |
| 8.1 | فلترة حسب offerType و jobType | `KawaderListPage.tsx`, API params | إضافة فلاتر في قائمة الكوادر                                                          |
| 8.2 | عمود النوع والموقع            | جدول القائمة                      | عرض offerType، jobType، location في الجدول                                            |
| 8.3 | عرض التقديمات على عرض         | `KawaderDetailsPage.tsx`          | قائمة التقديمات (applications) للعرض مع حالة كل تقديم (قراءة فقط أو مع ملاحظة للأدمن) |
| 8.4 | إحصائيات (اختياري)            | صفحة القائمة أو داشبورد           | عدد العروض حسب النوع، عدد التقديمات، إلخ                                              |

---

## ترتيب التنفيذ المقترح

1. **المرحلة 1** (إصلاح my و search) — عاجل لأن التطبيق يستدعيهما بالفعل.
2. **المرحلة 2** (حقول صريحة وتمييز النوع) — لتوافق أفضل مع V3 وتحسين الفلترة.
3. **المرحلة 3** (نظام التقديم) — جوهر "تقدم الآن" و My Jobs.
4. **المرحلة 6.1–6.3** (app-user: عروضي، بحث، تقدم الآن، حقول جديدة) — بالتوازي أو بعد 1–3.
5. **المرحلة 4 و 5** (Portfolio و Reviews) — ثم ربطها في التطبيق (6.4، 6.5).
6. **المرحلة 7 و 8** (الموقع ولوحة التحكم) — حسب الأولوية.

---

## ملخص الـ APIs المستهدفة (Backend)

| Method | المسار                              | الوصف                                                                       |
| ------ | ----------------------------------- | --------------------------------------------------------------------------- |
| POST   | /kawader                            | إنشاء عرض (مع offerType، jobType، location، salary عند الحاجة)              |
| GET    | /kawader                            | قائمة مع فلترة: cursor، status، offerType، jobType، budgetMin/Max، location |
| GET    | /kawader/my                         | عروضي (قبل :id)                                                             |
| GET    | /kawader/search                     | بحث q، status، cursor (قبل :id)                                             |
| GET    | /kawader/:id                        | تفاصيل عرض                                                                  |
| PATCH  | /kawader/:id                        | تحديث عرض                                                                   |
| DELETE | /kawader/:id                        | حذف عرض                                                                     |
| POST   | /kawader/:id/apply                  | تقديم على العرض (coverNote اختياري)                                         |
| GET    | /kawader/:id/applications           | قائمة التقديمات (للمالك فقط)                                                |
| GET    | /kawader/applications/my            | تقديماتي                                                                    |
| PATCH  | /kawader/applications/:appId/status | تحديث حالة تقديم (للمالك: accepted \| rejected)                             |
| POST   | /kawader/portfolio                  | إضافة عنصر معرض                                                             |
| GET    | /kawader/portfolio/me               | معرضي                                                                       |
| GET    | /kawader/portfolio/user/:userId     | معرض مستخدم (عام)                                                           |
| DELETE | /kawader/portfolio/:itemId          | حذف عنصر معرض                                                               |
| POST   | /kawader/:id/review                 | إنشاء مراجعة (rating، comment)                                              |
| GET    | /kawader/reviews/user/:userId       | مراجعات مستخدم (للملف العام)                                                |
| GET    | /admin/kawader                      | قائمة مع فلترة (موجود)                                                      |
| GET    | /admin/kawader/stats/overview       | إحصائيات (موجود)                                                            |

---

## ملاحظات

- **تقويم الحجوزات (Booking Calendar):** غير مشمول في هذه الخطة؛ يمكن إضافته لاحقاً كمرحلة منفصلة (slots + حجوزات للخدمات) كما في خطة عربون.
- **المحادثة (kawader-chat):** تبقى كما هي؛ يمكن ربط إنشاء المحادثة بحدث "قبول التقديم" أو تركها مستقلة كخيار "تواصل" دون تقديم رسمي.
- **الصلاحيات:** التحقق من ownerId عند تعديل/حذف العرض وإدارة التقديمات؛ التحقق من reviewerId عند إنشاء المراجعة (مرة واحدة لكل كادر/مستخدم).
- **الإشعارات:** (خارج نطاق الخطة) إشعار صاحب العرض بتقديم جديد، وإشعار مقدم الطلب بقبول/رفض التقديم.

---

_آخر تحديث: وفق مقارنة خدمة كوادر الحالية مع مواصفات V3 – Jobs & Services في وثيقة التسليم._
